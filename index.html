<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢³æ’æ”¾ç®¡ç†ç³»ç»Ÿ - EMS (æ”¹è¿›ç‰ˆ)</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="improvements.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- é…ç½®ç®¡ç†å™¨ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="config.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-leaf"></i>
                <span>ç¢³æ’æ”¾ç®¡ç†ç³»ç»Ÿ (æ”¹è¿›ç‰ˆ)</span>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-module="upload">æ–‡æ¡£ä¸Šä¼ </button>
                <button class="nav-tab" data-module="kanban">Kanbanåˆ†æ</button>
                <button class="nav-tab" data-module="lean">Leanä¼˜åŒ–</button>
                <button class="nav-tab" data-module="scrum">Scrumæ‰§è¡Œ</button>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æ–‡æ¡£ä¸Šä¼ æ¨¡å— -->
            <div id="upload-module" class="module active">
                <div class="module-header">
                    <h2><i class="fas fa-upload"></i> äº§å“è®¾è®¡æ–¹æ¡ˆä¸Šä¼ </h2>
                    <p>ä¸Šä¼ æ‚¨çš„äº§å“è®¾è®¡æ–¹æ¡ˆï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æç¢³æ’æ”¾å¹¶ä¼˜åŒ–ç”Ÿäº§æµç¨‹</p>

                </div>
                
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </h3>
                        <p>æ”¯æŒ PDF, DOC, DOCX, TXT æ ¼å¼</p>
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" hidden>
                        <button class="btn btn-primary" id="selectFileBtn">
                            é€‰æ‹©æ–‡ä»¶
                        </button>
                    </div>
                    
                    <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                        <h4>å·²ä¸Šä¼ æ–‡ä»¶</h4>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>

                <!-- AIè¡¥å……ä¿¡æ¯åŒºåŸŸ -->
                <div class="ai-supplement" id="aiSupplement" style="display: none;">
                    <div class="ai-chat">
                        <div class="chat-header">
                            <i class="fas fa-robot"></i>
                            <span>AIåŠ©æ‰‹ - è¡¥å……ç¼ºå¤±ä¿¡æ¯</span>
                        </div>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="è¯·å›ç­”AIçš„é—®é¢˜...">
                            <button class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                    <button class="btn btn-success" id="startAnalysis" onclick="startAnalysis()" disabled>
                        <i class="fas fa-play"></i> å¼€å§‹åˆ†æ
                    </button>
                    <button class="btn btn-primary" id="downloadBtn" onclick="downloadCompletedDocument()" style="display: none;">
                        <i class="fas fa-download"></i> ä¸‹è½½AIè¡¥å…¨æ–‡æ¡£
                    </button>
                </div>
                </div>
            </div>

            <!-- Kanbanæ¨¡å— -->
            <div id="kanban-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-chart-line"></i> Kanban ç¢³æ’æ”¾åˆ†æ</h2>
                    <p>äº§å“ç”Ÿå‘½å‘¨æœŸç¢³æ’æ”¾é¢„æµ‹ä¸é€†æ—¶é—´çº¿å±•ç¤º</p>

                </div>
                
                <div class="timeline-container">
                    <h3>äº§å“ç”Ÿå‘½å‘¨æœŸé€†æ—¶é—´çº¿</h3>
                    <div class="reverse-timeline" id="reverseTimeline">
                        <!-- æ—¶é—´çº¿èŠ‚ç‚¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="emission-analysis">
                    <h3>å„ç¯èŠ‚ç¢³æ’æ”¾åˆ†æ</h3>
                    <div class="emission-cards" id="emissionCards">
                        <!-- æ’æ”¾å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- Leanæ¨¡å— -->
            <div id="lean-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-lightbulb"></i> Lean ä¼˜åŒ–åˆ†æ</h2>
                    <p>æ·±åº¦åˆ†æé«˜æ’æ”¾åŸå› å¹¶æä¾›ä¼˜åŒ–å»ºè®®</p>

                </div>
                
                <div class="analysis-content" id="leanAnalysis">
                    <div class="analysis-placeholder">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>è¯·åœ¨Kanbanæ¨¡å—ä¸­å®Œæˆåˆ†æåè¿›å…¥Leanä¼˜åŒ–</p>
                    </div>
                </div>
            </div>

            <!-- Scrumæ¨¡å— -->
            <div id="scrum-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-tasks"></i> Scrum æ‰§è¡Œè·Ÿè¸ª</h2>
                    <p>å„éƒ¨é—¨ä»»åŠ¡åˆ†é…ä¸è¿›åº¦ç›‘æ§</p>

                </div>
                
                <!-- Scrumæ§åˆ¶é¢æ¿ï¼ˆå·²ç§»é™¤Sprintä¿¡æ¯ï¼Œåº”ç”¨æˆ·è¦æ±‚éšè—è¯¥æ¨¡å—ï¼‰ -->

                <!-- Scrumå†…å®¹åŒºåŸŸ -->
                <div class="scrum-content" id="scrumContent">
                    <!-- ç”˜ç‰¹å›¾è§†å›¾ï¼ˆä»…ä¿ç•™ç”˜ç‰¹å›¾ï¼‰ -->
                    <div class="scrum-view" id="gantt-view" style="display: block;">
                        <div class="gantt-container">
                            <div class="gantt-header">
                                <h3><i class="fas fa-chart-gantt"></i> é¡¹ç›®ç”˜ç‰¹å›¾</h3>
                                <div class="gantt-controls">
                                    <button class="btn btn-primary" onclick="adjustGanttZoom('day')">æ—¥è§†å›¾</button>
                                    <button class="btn btn-secondary" onclick="adjustGanttZoom('week')">å‘¨è§†å›¾</button>
                                </div>
                            </div>
                            <div class="gantt-chart" id="ganttChart">
                                <!-- ç”˜ç‰¹å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div id="scrumDebugPanel" class="scrum-debug" style="display:none; margin-top:10px; background:#fff3cd; border:1px solid #ffeaa7; padding:8px; border-radius:6px;"></div>
                        </div>
                    </div>


                </div>


            </div>
        </main>
    </div>

    <!-- AIå¯¹è¯å¼¹çª— -->
    <div class="modal" id="aiModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-robot"></i> AIåˆ†æåŠ©æ‰‹</h3>
                <button class="close-btn" onclick="closeAiModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="selected-data" id="selectedData"></div>
                <div class="ai-question">
                    <label for="aiQuestion">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š</label>
                    <textarea id="aiQuestion" placeholder="ä¾‹å¦‚ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªç¯èŠ‚çš„æ’æ”¾é‡è¿™ä¹ˆé«˜ï¼Ÿ"></textarea>
                    <button class="btn btn-primary" onclick="askAI()">è¯¢é—®AI</button>
                </div>
                <div class="ai-response" id="aiResponse" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Mammoth.jsåº“ç”¨äºDOCXæ–‡ä»¶è§£æ -->
    <script src="https://unpkg.com/mammoth@1.4.21/mammoth.browser.min.js"></script>
    
    <!-- åœ¨script.jsåŠ è½½å‰é‡å†™å…³é”®å‡½æ•° -->
    <script>
        // é¢„å…ˆé‡å†™selectSolutionAreaå‡½æ•°
        window.selectSolutionArea = async function(area) {
            console.log('é‡å†™çš„selectSolutionAreaè¢«è°ƒç”¨:', area);
            
            // ä¿å­˜å½“å‰é€‰ä¸­é¢†åŸŸ
            if (window.currentSelectedArea !== undefined) {
                window.currentSelectedArea = area;
            }

            // é«˜äº®é€‰ä¸­çš„é¡¹ç›®
            document.querySelectorAll('.solution-area-card').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-area="${area}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
            
            // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
            const selectedAnalysis = document.getElementById('selectedAnalysis');
            const optimizationSection = document.getElementById('optimizationSection');
            if (selectedAnalysis) selectedAnalysis.style.display = 'block';
            if (optimizationSection) optimizationSection.style.display = 'block';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨åˆ†æä¸­ï¼Œç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®...</div>';
            }
            
            // ç›´æ¥è°ƒç”¨AIç”Ÿæˆå‡½æ•°
            try {
                console.log('å¼€å§‹è°ƒç”¨AIç”Ÿæˆå‡½æ•°');
                if (typeof window.generatePersonalizedSuggestions === 'function') {
                    await window.generatePersonalizedSuggestions(area);
                } else {
                    console.error('generatePersonalizedSuggestionså‡½æ•°æœªå®šä¹‰');
                }
            } catch (error) {
                console.error('AIç”Ÿæˆå¤±è´¥:', error);
            }
        };
    </script>
    
    <script src="script.js"></script>
    <script>
        // ç¢³æ’æ”¾ç®¡ç†ç³»ç»Ÿæ”¹è¿›åŠŸèƒ½
        
        // å…¨å±€å˜é‡ - ä¿®å¤é‡‡çº³çŠ¶æ€æŒä¹…åŒ–é—®é¢˜
        // ä½¿ç”¨windowå¯¹è±¡é¿å…ä¸script.jsä¸­çš„å˜é‡å†²çª
        if (!window.acceptedSuggestions) {
            // æ¸…é™¤ç¼“å­˜ï¼Œé‡ç½®çŠ¶æ€
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }
        
        // åˆå§‹åŒ–å…¨å±€å˜é‡
        if (!window.acceptedSuggestions) {
            // æ¸…é™¤ç¼“å­˜ï¼Œé‡ç½®çŠ¶æ€
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.lastSuggestionsCache) {
            window.lastSuggestionsCache = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }

        // åˆå§‹åŒ–åˆ†ææ•°æ®
        if (!window.analysisData) {
            window.analysisData = {
                emissions: {
                    procurement: { value: 80, originalValue: 80 },
                    manufacturing: { value: 120, originalValue: 120 },
                    logistics: { value: 45, originalValue: 45 },
                    usage: { value: 200, originalValue: 200 },
                    recycling: { value: 25, originalValue: 25 },
                    decomposition: { value: 10, originalValue: 10 }
                },
                timeline: {
                    procurement: { duration: 30, originalDuration: 30, unit: 'å¤©' },
                    manufacturing: { duration: 45, originalDuration: 45, unit: 'å¤©' },
                    logistics: { duration: 7, originalDuration: 7, unit: 'å¤©' },
                    usage: { duration: 730, originalDuration: 730, unit: 'å¤©' },
                    recycling: { duration: 60, originalDuration: 60, unit: 'å¤©' },
                    decomposition: { duration: 1825, originalDuration: 1825, unit: 'å¤©' }
                }
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆååº”ç”¨ç´¯ç§¯æ”¹è¿›æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœæœ‰å·²é‡‡çº³çš„å»ºè®®ï¼Œåº”ç”¨ç´¯ç§¯æ•ˆæœ
            if (window.acceptedSuggestions && window.acceptedSuggestions.length > 0) {
                setTimeout(() => {
                    if (typeof window.updateAllDataCards === 'function') {
                        window.updateAllDataCards();
                    }
                }, 500);
            }
            
            // æ¸²æŸ“æ•°æ®å¡ç‰‡
            if (typeof renderDataCards === 'function') {
                renderDataCards();
            }
        });

        // æ”¹è¿›1: AIåŠ©æ‰‹åˆ·æ–°åŠŸèƒ½
        function refreshFieldContent(fieldName) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"] .field-value`);
            if (!fieldElement) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            fieldElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIé‡æ–°ç”Ÿæˆä¸­...';
            
            // æ¨¡æ‹ŸAIé‡æ–°ç”Ÿæˆå†…å®¹
            setTimeout(() => {
                const newContent = generateSmartFieldContent(fieldName);
                fieldElement.textContent = newContent;
                fieldElement.setAttribute('data-original', newContent);
                
                // æ›´æ–°å­˜å‚¨çš„æ•°æ®
                if (window.supplementData) {
                    window.supplementData[fieldName] = newContent;
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                addAIMessage(`ğŸ”„ "${fieldName}"å·²é‡æ–°ç”Ÿæˆï¼š${newContent}`);
            }, 1500);
        }

        // æ ¹æ®å­—æ®µç±»å‹ç”Ÿæˆæ™ºèƒ½å†…å®¹
        function generateSmartFieldContent(fieldName) {
            const documentType = window.currentAnalysis?.documentType || 'general';
            
            const smartContentGenerators = {
                'ä¾›åº”å•†åœ°ç†ä½ç½®ä¿¡æ¯': () => {
                    const locations = ['æ±Ÿè‹è‹å·', 'å¹¿ä¸œæ·±åœ³', 'æµ™æ±Ÿæ­å·', 'å±±ä¸œé’å²›', 'æ²³åŒ—çŸ³å®¶åº„', 'æ¹–åŒ—æ­¦æ±‰'];
                    const selected = locations[Math.floor(Math.random() * locations.length)];
                    return `${selected}ï¼ˆåŸºäº${getDocumentTypeName(documentType)}äº§ä¸šé›†ç¾¤åˆ†æï¼‰`;
                },
                'åŸææ–™å…·ä½“è§„æ ¼å’Œæ¥æº': () => {
                    const materials = {
                        electronics: ['èŠ¯ç‰‡-å°ç§¯ç”µ', 'é‡‘å±å¤–å£³-å¯Œå£«åº·', 'ç”µæ± -å®å¾·æ—¶ä»£'],
                        textile: ['æœ‰æœºæ£‰-æ–°ç–†', 'ç¯ä¿æŸ“æ–™-å¾·å›½å·´æ–¯å¤«', 'å†ç”Ÿçº¤ç»´-æ—¥æœ¬ä¸œä¸½'],
                        automotive: ['é’¢æ-å®é’¢é›†å›¢', 'æ©¡èƒ¶-ç±³å…¶æ—', 'ç”µæ± -æ¯”äºšè¿ª'],
                        general: ['é’¢æ-å®é’¢é›†å›¢', 'å¡‘æ–™-ä¸­çŸ³åŒ–', 'ç”µå­å…ƒä»¶-å¯Œå£«åº·']
                    };
                    const typeMatrials = materials[documentType] || materials.general;
                    return typeMatrials.join('ï¼Œ');
                },
                'ç”Ÿäº§å·¥è‰ºè¯¦ç»†æµç¨‹': () => {
                    const processes = {
                        electronics: 'èŠ¯ç‰‡å°è£…â†’ç”µè·¯æ¿ç»„è£…â†’å¤–å£³è£…é…â†’ç³»ç»Ÿæµ‹è¯•â†’è´¨é‡æ£€éªŒ',
                        textile: 'çº¤ç»´å¤„ç†â†’çººçº±ç»‡å¸ƒâ†’æŸ“è‰²å°èŠ±â†’è£å‰ªç¼åˆ¶â†’è´¨é‡æ£€æµ‹',
                        automotive: 'å†²å‹æˆå‹â†’ç„Šæ¥è£…é…â†’æ¶‚è£…å¤„ç†â†’æ€»è£…è°ƒè¯•â†’è·¯è¯•æ£€éªŒ',
                        general: 'åŸæ–™é¢„å¤„ç†â†’ç²¾å¯†åŠ å·¥â†’è´¨é‡æ£€æµ‹â†’ç»„è£…é›†æˆâ†’åŒ…è£…å…¥åº“'
                    };
                    return processes[documentType] || processes.general;
                },
                'ç‰©æµè¿è¾“æ–¹å¼å’Œè·¯å¾„': () => {
                    const logistics = [
                        'å…¬è·¯è¿è¾“ä¸ºä¸»ï¼Œå¹³å‡è¿è·' + (Math.floor(Math.random() * 200) + 200) + 'å…¬é‡Œ',
                        'é“è·¯+å…¬è·¯è”è¿ï¼Œç»¿è‰²ç‰©æµå æ¯”' + (Math.floor(Math.random() * 30) + 20) + '%',
                        'å¤šå¼è”è¿ï¼Œæµ·è¿+é™†è¿ç»“åˆï¼Œæˆæœ¬ä¼˜åŒ–' + (Math.floor(Math.random() * 15) + 10) + '%'
                    ];
                    return logistics[Math.floor(Math.random() * logistics.length)];
                },
                'äº§å“ä½¿ç”¨åœºæ™¯å’Œå‘¨æœŸ': () => {
                    const scenarios = {
                        electronics: `æ¶ˆè´¹ç”µå­äº§å“ï¼Œå…¸å‹ä½¿ç”¨å¯¿å‘½${Math.floor(Math.random() * 5) + 3}-${Math.floor(Math.random() * 3) + 8}å¹´`,
                        textile: `æ—¥å¸¸æœè£…ï¼Œæ¨èç©¿æˆ´å‘¨æœŸ${Math.floor(Math.random() * 24) + 12}ä¸ªæœˆ`,
                        automotive: `äº¤é€šå·¥å…·ï¼Œä½¿ç”¨å¯¿å‘½${Math.floor(Math.random() * 5) + 8}-${Math.floor(Math.random() * 5) + 12}å¹´`,
                        general: `é€šç”¨äº§å“ï¼Œå…¸å‹ä½¿ç”¨å¯¿å‘½${Math.floor(Math.random() * 3) + 3}-${Math.floor(Math.random() * 3) + 6}å¹´`
                    };
                    return scenarios[documentType] || scenarios.general;
                }
            };
            
            const generator = smartContentGenerators[fieldName];
            if (generator) {
                return generator();
            }
            
            // é»˜è®¤ç”Ÿæˆ
            return `åŸºäº${getDocumentTypeName(documentType)}è¡Œä¸šç‰¹ç‚¹é‡æ–°ç”Ÿæˆçš„${fieldName}ä¿¡æ¯`;
        }

        // æ”¹è¿›2: å¯¹è¯è®°å½•åŠŸèƒ½
        if (!window.aiChatHistory) {
            window.aiChatHistory = {
                kanban: [],
                lean: []
            };
        }

        // ç«‹å³é‡å†™å‡½æ•°ï¼Œä¸ç­‰å¾…DOMåŠ è½½
        (function() {
            // é‡å†™displayAutoCompletedDataå‡½æ•°ä»¥æ·»åŠ åˆ·æ–°æŒ‰é’®
            const originalDisplayAutoCompletedData = window.displayAutoCompletedData;
            
            if (originalDisplayAutoCompletedData) {
                window.displayAutoCompletedData = function(data) {
                    const chatMessages = document.getElementById('chatMessages');
                    const autoCompletedDiv = document.createElement('div');
                    autoCompletedDiv.className = 'message ai auto-completed-data';
                    autoCompletedDiv.id = 'autoCompletedData';
                    
                    let content = '<div class="auto-completed-header"><i class="fas fa-magic"></i> <strong>AIè‡ªåŠ¨è¡¥å…¨ç»“æœï¼š</strong></div>';
                    
                    Object.entries(data).forEach(([key, value]) => {
                        content += `
                            <div class="auto-completed-item" data-field="${key}">
                                <div class="field-label"><strong>${key}:</strong></div>
                                <div class="field-value" contenteditable="true" data-original="${value}">${value}</div>
                                <div class="field-actions">
                                    <button class="btn-mini btn-edit" onclick="editField('${key}')" title="ç¼–è¾‘å­—æ®µ">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button class="btn-mini btn-reset" onclick="resetField('${key}')" title="é‡ç½®ä¸ºæ¨èå€¼">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    autoCompletedDiv.innerHTML = content;
                    chatMessages.appendChild(autoCompletedDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
            }

            // å¢å¼ºçš„AIå¯¹è¯æ¨¡æ€æ¡†
            const originalOpenAIModal = window.openAIModal;
            if (originalOpenAIModal) {
                window.openAIModal = function(emissionType, emissionData) {
                    selectedEmissionData = { type: emissionType, data: emissionData };
                    
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    const typeNames = {
                        procurement: 'åŸæ–™é‡‡è´­',
                        manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                        logistics: 'ç‰©æµè¿è¾“',
                        usage: 'äº§å“ä½¿ç”¨',
                        recycling: 'å›æ”¶å¤„ç†',
                        decomposition: 'è‡ªç„¶é™è§£'
                    };
                    
                    // ç¡®å®šå½“å‰æ¨¡å—
                    const currentModule = document.querySelector('.nav-tab.active')?.dataset.module || 'kanban';
                    
                    selectedDataDiv.innerHTML = `
                        <h4>é€‰ä¸­æ•°æ®: ${typeNames[emissionType]}</h4>
                        <p>ç¢³æ’æ”¾å€¼: <strong>${emissionData.value}</strong></p>
                        <p>æ’æ”¾çº§åˆ«: <strong>${emissionData.level === 'high' ? 'é«˜' : emissionData.level === 'medium' ? 'ä¸­' : 'ä½'}</strong></p>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-history"></i> å¯¹è¯è®°å½•</h5>
                            <div class="history-messages" id="historyMessages">
                                ${renderChatHistory(currentModule, emissionType)}
                            </div>
                        </div>
                    `;
                    
                    // è®¾ç½®å½“å‰æ¨¡å—ç±»å‹
                    modal.setAttribute('data-module', currentModule);
                    modal.setAttribute('data-emission-type', emissionType);
                    
                    modal.style.display = 'flex';
                };
            }

            // å¢å¼ºçš„AIè¯¢é—®åŠŸèƒ½
            const originalAskAI = window.askAI;
            if (originalAskAI) {
                window.askAI = async function() {
                    const questionInput = document.getElementById('aiQuestion');
                    if (!questionInput) {
                        alert('æ— æ³•æ‰¾åˆ°é—®é¢˜è¾“å…¥æ¡†');
                        return;
                    }
                    
                    const question = questionInput.value.trim();
                    if (!question) {
                        alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                        return;
                    }
                    
                    const modal = document.getElementById('aiModal');
                    if (!modal) {
                        alert('æ— æ³•æ‰¾åˆ°AIå¯¹è¯æ¡†');
                        return;
                    }
                    
                    const moduleType = modal.getAttribute('data-module') || 'kanban';
                    const emissionType = modal.getAttribute('data-emission-type');
                    const mode = modal.getAttribute('data-mode');
                    
                    const responseDiv = document.getElementById('aiResponse');
                    if (responseDiv) {
                        responseDiv.style.display = 'block';
                        responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨åˆ†æä¸­...';
                    }
                    
                    try {
                        let response;
                        if (mode === 'suggestion-consult') {
                            // æ·±åº¦åˆ†æAIåŠ©æ‰‹æ¨¡å¼
                            response = await callSuggestionAI(question, window.currentConsultSuggestion);
                        } else {
                            // æ™®é€šAIåˆ†ææ¨¡å¼
                            response = await callAI(question, selectedEmissionData);
                        }
                        
                        // ä¿å­˜å¯¹è¯è®°å½•
                        saveAIChatHistory(moduleType, emissionType, question, response);
                        
                        responseDiv.innerHTML = `
                            <h4><i class="fas fa-lightbulb"></i> AIåˆ†æç»“æœ</h4>
                            <div class="ai-analysis">${response}</div>
                            <div class="action-buttons" style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="continueConversation()" style="margin-right: 0.5rem;">
                                    <i class="fas fa-comments"></i> ç»§ç»­è¿½é—®
                                </button>
                                <button class="btn btn-primary" onclick="closeAiModal()">
                                    <i class="fas fa-times"></i> å…³é—­
                                </button>
                            </div>
                        `;
                        
                        // æ›´æ–°å¯¹è¯å†å²æ˜¾ç¤º
                        updateChatHistoryDisplay(moduleType, emissionType);
                        
                    } catch (error) {
                        console.error('AIåˆ†æå¤±è´¥:', error);
                        responseDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AIæœåŠ¡æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>`;
                    }
                };
            }

            // é‡å†™Leanæ¨¡å—çš„æ¸²æŸ“å‡½æ•°ä»¥æ”¯æŒä¸ªæ€§åŒ–å»ºè®®å’ŒçŠ¶æ€æŒä¹…åŒ–
            const originalRenderLeanModule = window.renderLeanModule;
            if (originalRenderLeanModule) {
                window.renderLeanModule = function() {
                    const leanContent = document.getElementById('leanAnalysis');
                    
                    // è·å–å®é™…æ–¹æ¡ˆå†…å®¹åˆ†æç»“æœ
                    const solutionAnalysis = getSolutionAnalysisResults();
                    
                    // è·å–ç¢³æ’æ”¾å¡ç‰‡æ•°æ®
                    const emissionCardsHtml = generateEmissionCardsForLean();
                    
                    leanContent.innerHTML = `
                        <div class="solution-analysis-section">
                            <h3><i class="fas fa-file-alt"></i> æ–¹æ¡ˆå†…å®¹åˆ†æ</h3>
                            <div class="solution-analysis-results">
                                ${solutionAnalysis.map(analysis => {
                                    const classMap = {
                                        'ææ–™é€‰æ‹©': 'material-optimization',
                                        'ç”Ÿäº§å·¥è‰º': 'process-improvement', 
                                        'ä¾›åº”é“¾ç®¡ç†': 'management-enhancement',
                                        'äº§å“è®¾è®¡': 'tech-innovation',
                                        'åŒ…è£…æ–¹æ¡ˆ': 'material-optimization'
                                    };
                                    const isSelected = window.currentSelectedArea === analysis.area;
                                    // ç§»é™¤has-acceptedæ ·å¼ï¼Œæ–¹æ¡ˆå†…å®¹åˆ†æåŒºåŸŸä¸å› é‡‡çº³å»ºè®®è€Œå˜è‰²
                                    return `
                                    <div class="solution-area-card ${classMap[analysis.area] || 'tech-innovation'} ${isSelected ? 'selected' : ''}" onclick="selectSolutionArea('${analysis.area}')" data-area="${analysis.area}">
                                        <h4>
                                            <i class="${analysis.icon} area-icon"></i>
                                            ${analysis.area}
                                        </h4>
                                        <p>${analysis.currentStatus}</p>
                                        <div class="improvement-potential">æ”¹è¿›æ½œåŠ›: ${analysis.improvementPotential}</div>
                                    </div>
                                `}).join('')}
                            </div>
                            <div class="selection-hint">
                                <i class="fas fa-hand-pointer"></i> ç‚¹å‡»ä»»æ„æ–¹æ¡ˆé¢†åŸŸè¿›è¡Œæ·±åº¦åˆ†æ
                            </div>
                        </div>
                        
                        <div class="analysis-section" id="selectedAnalysis" style="display: ${window.currentSelectedArea ? 'block' : 'none'};">
                            <h3><i class="fas fa-search"></i> æ–¹æ¡ˆé¢†åŸŸæ·±åº¦åˆ†æ</h3>
                            <div id="optimizationSection">
                                <h3><i class="fas fa-lightbulb"></i> ä¼˜åŒ–å»ºè®®</h3>
                                <div class="suggestions" id="suggestionsContent">
                                    ${window.currentSelectedArea ? '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½å»ºè®®...</div>' : ''}
                                </div>
                            </div>
                        </div>

                        
                        <div class="detailed-data-section">
                            <h3><i class="fas fa-chart-bar"></i> æ—¶é—´å’Œç¢³æ’æ”¾æ•°æ®</h3>
                            <div class="data-container">
                                <div class="emission-data-block">
                                    <h4><i class="fas fa-leaf"></i> ç¢³æ’æ”¾æ•°æ®</h4>
                                    <div class="emission-cards-lean">
                                        ${emissionCardsHtml}
                                    </div>
                                </div>
                                <div class="timeline-data-block">
                                    <h4><i class="fas fa-clock"></i> æ—¶é—´æ•°æ®</h4>
                                    <div class="timeline-cards-lean">
                                        ${generateTimelineCardsHtml()}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lean-to-scrum-action-section">
                            <h3><i class="fas fa-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šè¿›å…¥Scrumæ‰§è¡Œ</h3>
                            <p>åœ¨Leanä¼˜åŒ–åˆ†æå®Œæˆåï¼Œæ‚¨å¯ä»¥å°†é‡‡çº³çš„å»ºè®®è½¬åŒ–ä¸ºScrumä»»åŠ¡ï¼Œè¿›è¡Œé¡¹ç›®æ‰§è¡Œå’Œè·Ÿè¸ªã€‚</p>
                            <button class="btn btn-primary btn-large" onclick="goToScrumExecution()">
                                <i class="fas fa-tasks"></i> è½¬åˆ°Scrumæ‰§è¡Œ
                            </button>
                        </div>
                    `;
                    
                    // å¦‚æœæœ‰é€‰ä¸­çš„é¢†åŸŸï¼Œå¼‚æ­¥åŠ è½½å»ºè®®å†…å®¹
                    if (window.currentSelectedArea) {
                        // å¦‚æœæœ‰ç¼“å­˜çš„å»ºè®®ï¼Œç›´æ¥æ¸²æŸ“
                        if (window.lastSuggestionsCache && window.lastSuggestionsCache[window.currentSelectedArea]) {
                            window.renderSuggestions(window.currentSelectedArea, window.lastSuggestionsCache[window.currentSelectedArea]);
                        } else {
                            // å¦åˆ™é‡æ–°ç”Ÿæˆå»ºè®®
                            setTimeout(() => {
                                if (typeof window.generatePersonalizedSuggestions === 'function') {
                                    window.generatePersonalizedSuggestions(window.currentSelectedArea);
                                }
                            }, 100);
                        }
                    }
                };
            }



                    // é‡å†™é€‰æ‹©æ–¹æ¡ˆé¢†åŸŸå‡½æ•°
        const originalSelectSolutionArea = window.selectSolutionArea;
        if (originalSelectSolutionArea) {
            window.selectSolutionArea = async function(area) {
                console.log('é€‰æ‹©æ–¹æ¡ˆé¢†åŸŸ:', area);
                
                // ä¿å­˜å½“å‰é€‰ä¸­é¢†åŸŸ
                window.currentSelectedArea = area;

                // é«˜äº®é€‰ä¸­çš„é¡¹ç›®
                document.querySelectorAll('.solution-area-card').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-area="${area}"]`);
                if (selectedCard) selectedCard.classList.add('selected');
                
                // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
                const selectedAnalysis = document.getElementById('selectedAnalysis');
                const optimizationSection = document.getElementById('optimizationSection');
                if (selectedAnalysis) selectedAnalysis.style.display = 'block';
                if (optimizationSection) optimizationSection.style.display = 'block';
                

                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    // è‹¥æœ‰ç¼“å­˜åˆ™ç›´æ¥æ¸²æŸ“ï¼Œä¸å†æ˜¾ç¤ºåŠ è½½ä¸é‡æ–°ç”Ÿæˆ
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        window.renderSuggestions(area, window.lastSuggestionsCache[area]);
                        return; // ä½¿ç”¨ç¼“å­˜å¹¶ä¿æŒé‡‡çº³çŠ¶æ€
                    } else {
                        suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨åˆ†æä¸­ï¼Œç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®...</div>';
                    }
                }
                
                // ç›´æ¥è°ƒç”¨AIç”Ÿæˆå‡½æ•°
                try {
                    console.log('å¼€å§‹è°ƒç”¨AIç”Ÿæˆå‡½æ•°');
                    await window.generatePersonalizedSuggestions(area);
                } catch (error) {
                    console.error('AIç”Ÿæˆå¤±è´¥:', error);
                    const suggestionsDiv = document.getElementById('suggestionsContent');
                    if (suggestionsDiv) {
                        suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AIæœåŠ¡æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
                    }
                }
            };
        }

            // é‡å†™é‡‡çº³å»ºè®®å‡½æ•°ä»¥æ”¯æŒçŠ¶æ€æŒä¹…åŒ–
            const originalAcceptSuggestion = window.acceptSuggestion;
            if (originalAcceptSuggestion) {
                window.acceptSuggestion = function(suggestionTitle, event) {
                    // æ·»åŠ åˆ°å·²é‡‡çº³å»ºè®®åˆ—è¡¨
                    if (!window.acceptedSuggestions.includes(suggestionTitle)) {
                        window.acceptedSuggestions.push(suggestionTitle);
                        window.hasAcceptedSuggestions = true;
                        // æŒ‰é¢†åŸŸå­˜å‚¨å·²é‡‡çº³å»ºè®®
                        if (window.currentSelectedArea) {
                            if (!window.acceptedSuggestionsByArea[window.currentSelectedArea]) {
                                window.acceptedSuggestionsByArea[window.currentSelectedArea] = [];
                            }
                            window.acceptedSuggestionsByArea[window.currentSelectedArea].push(suggestionTitle);
                        }
                        // æŒä¹…åŒ–å­˜å‚¨
                        localStorage.setItem('acceptedSuggestions', JSON.stringify(window.acceptedSuggestions));
                        localStorage.setItem('acceptedSuggestionsByArea', JSON.stringify(window.acceptedSuggestionsByArea));
                        
                        // ä½¿ç”¨ç´¯ç§¯è®¡ç®—æ›´æ–°æ‰€æœ‰æ•°æ®å¡ç‰‡ï¼ˆç¡®ä¿æ—¶é—´ä¸ç¢³æ’å…ˆå†™å…¥æ•°æ®ï¼Œå†ç»Ÿä¸€åˆ·æ–°UIï¼‰
                        if (typeof window.updateAllDataCards === 'function') {
                            window.updateAllDataCards();
                        } else if (typeof window.refreshLeanTimelineData === 'function') {
                            // å…œåº•ï¼šä»…åˆ·æ–°æ—¶é—´å¡ç‰‡
                            window.refreshLeanTimelineData();
                        }

                        
                        // æ›´æ–°å½“å‰å»ºè®®å¡ç‰‡çš„æ˜¾ç¤ºçŠ¶æ€
                        updateSuggestionCardStatus(suggestionTitle);
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const button = event ? event.target : window.event?.target;
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> å·²é‡‡çº³';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                    
                    // æ˜¾ç¤ºä¸€é”®æ‰§è¡ŒæŒ‰é’®
                    showExecuteAllButton();
                };
            }

            // æ›´æ–°å»ºè®®å¡ç‰‡çŠ¶æ€çš„å‡½æ•°
            function updateSuggestionCardStatus(suggestionTitle) {
                const suggestionCard = document.querySelector(`[data-suggestion-title="${suggestionTitle}"]`);
                if (suggestionCard) {
                    suggestionCard.classList.add('accepted');
                    const button = suggestionCard.querySelector('.btn-success');
                    if (button) {
                        button.innerHTML = '<i class="fas fa-check"></i> å·²é‡‡çº³';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                }
            }



            // é‡å†™å’¨è¯¢AIå»ºè®®å‡½æ•°
            const originalConsultAIForSuggestion = window.consultAIForSuggestion;
            if (originalConsultAIForSuggestion) {
                window.consultAIForSuggestion = function(suggestionTitle, suggestionDesc) {
                    // è®¾ç½®å½“å‰å’¨è¯¢çš„å»ºè®®ä¿¡æ¯
                    window.currentConsultSuggestion = {
                        title: suggestionTitle,
                        description: suggestionDesc
                    };
                    
                    // å¤ç”¨ç°æœ‰çš„AIæ¨¡æ€æ¡†
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    // è®¾ç½®å»ºè®®å’¨è¯¢çš„å†…å®¹
                    selectedDataDiv.innerHTML = `
                        <div class="suggestion-consult-header">
                            <h4><i class="fas fa-lightbulb text-warning"></i> å»ºè®®å’¨è¯¢: ${suggestionTitle}</h4>
                            <div class="suggestion-description">
                                <p><strong>å»ºè®®å†…å®¹ï¼š</strong></p>
                                <p class="text-muted">${suggestionDesc}</p>
                            </div>
                        </div>
                        
                        <div class="ai-consult-guide">
                            <h5><i class="fas fa-robot text-primary"></i> AIåŠ©æ‰‹å¯ä»¥å¸®æ‚¨ï¼š</h5>
                            <ul class="consult-options">
                                <li><i class="fas fa-check-circle text-success"></i> åˆ†æå»ºè®®çš„å¯è¡Œæ€§å’Œé£é™©</li>
                                <li><i class="fas fa-list-ol text-info"></i> æä¾›è¯¦ç»†çš„å®æ–½æ­¥éª¤</li>
                                <li><i class="fas fa-chart-line text-warning"></i> è¯„ä¼°é¢„æœŸçš„æ”¹è¿›æ•ˆæœ</li>
                                <li><i class="fas fa-star text-primary"></i> æ¨èç›¸å…³çš„æœ€ä½³å®è·µ</li>
                            </ul>
                        </div>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-comments"></i> å’¨è¯¢å¯¹è¯</h5>
                            <div class="history-messages" id="historyMessages">
                                <div class="ai-welcome-message">
                                    <div class="message-avatar ai-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œé’ˆå¯¹ã€Œ${suggestionTitle}ã€è¿™ä¸ªå»ºè®®ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿæˆ‘ä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åˆ†æå’Œå»ºè®®ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // è®¾ç½®æ¨¡æ€æ¡†å±æ€§
                    modal.setAttribute('data-mode', 'suggestion-consult');
                    modal.setAttribute('data-suggestion-title', suggestionTitle);
                    modal.setAttribute('data-module', 'lean');
                    modal.setAttribute('data-emission-type', 'suggestion');
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    modal.style.display = 'flex';
                    
                    // æ¸…ç©ºå¹¶èšç„¦é—®é¢˜è¾“å…¥æ¡†
                    const questionInput = document.getElementById('aiQuestion');
                    questionInput.value = '';
                    questionInput.placeholder = 'è¯·è¾“å…¥æ‚¨å…³äºæ­¤å»ºè®®çš„é—®é¢˜...';
                    setTimeout(() => {
                        questionInput.focus();
                    }, 300);
                };
            }
        })();

        // ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®å‡½æ•° - ä½¿ç”¨çœŸå®AI API
        window.generatePersonalizedSuggestions = async function(area) {
            console.log('å¼€å§‹ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®:', area);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('æ‰¾ä¸åˆ°suggestionsContentå…ƒç´ ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            suggestionsDiv.innerHTML = `
                <div class="loading-suggestions">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>AIæ­£åœ¨åˆ†æ${area}é¢†åŸŸï¼Œç”Ÿæˆä¸ªæ€§åŒ–ä¼˜åŒ–å»ºè®®...</p>
                </div>
            `;

            try {
                // è·å–å½“å‰æ–‡æ¡£å’Œäº§å“ä¿¡æ¯
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);
                
                console.log('äº§å“ä¿¡æ¯:', {
                    productType,
                    productTypeName,
                    documentContentLength: documentContent.length,
                    supplementDataKeys: Object.keys(supplementData)
                });

                // å‡†å¤‡å­æ¨¡å—æ˜ å°„ä¸åŸºçº¿ï¼ˆæ¥è‡ªå…¨å±€analysisDataï¼‰
                const analysisData = window.analysisData || {};
                const carbonMapCN = {
                    procurement: 'åŸæ–™é‡‡è´­',
                    manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                    logistics: 'ç‰©æµè¿è¾“',
                    usage: 'äº§å“ä½¿ç”¨',
                    recycling: 'å›æ”¶å¤„ç†',
                    decomposition: 'è‡ªç„¶é™è§£'
                };
                const timeMapCN = {
                    procurement: 'åŸæ–™é‡‡è´­',
                    manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                    logistics: 'ç‰©æµè¿è¾“',
                    usage: 'äº§å“ä½¿ç”¨',
                    recycling: 'å›æ”¶å¤„ç†',
                    decomposition: 'è‡ªç„¶é™è§£'
                };
                const carbonBaseline = {
                    procurement: analysisData?.emissions?.procurement?.value ?? null,
                    manufacturing: analysisData?.emissions?.manufacturing?.value ?? null,
                    logistics: analysisData?.emissions?.logistics?.value ?? null,
                    usage: analysisData?.emissions?.usage?.value ?? null,
                    recycling: analysisData?.emissions?.recycling?.value ?? null,
                    decomposition: analysisData?.emissions?.decomposition?.value ?? null
                };
                const timeBaseline = {
                    procurement: analysisData?.timeline?.procurement?.duration ?? null,
                    manufacturing: analysisData?.timeline?.manufacturing?.duration ?? null,
                    logistics: analysisData?.timeline?.logistics?.duration ?? null,
                    usage: analysisData?.timeline?.usage?.duration ?? null,
                    recycling: analysisData?.timeline?.recycling?.duration ?? null,
                    decomposition: analysisData?.timeline?.decomposition?.duration ?? null
                };

                // æ„å»ºAIæç¤ºè¯ - æ˜ç¡®å­æ¨¡å—ä¸åŸºçº¿ï¼Œå¹¶è¦æ±‚è¿”å›å®æ–½åçš„æ–°å€¼ï¼ˆæ›´ä¸¥æ ¼çš„æ•°å€¼è§„èŒƒã€ä¸”ä¸è¿”å›äººç±»å¯è¯»æµ“ç¼©å­—æ®µï¼‰
                const prompt = `ä½œä¸ºç¢³æ’æ”¾ç®¡ç†å’Œç²¾ç›Šç”Ÿäº§ä¸“å®¶ï¼Œè¯·ä¸º${productTypeName}äº§å“çš„${area}é¢†åŸŸç”Ÿæˆ3ä¸ªå…·ä½“çš„ä¼˜åŒ–å»ºè®®ã€‚

ã€äº§å“ä¿¡æ¯ã€‘ï¼š
äº§å“ç±»å‹ï¼š${productTypeName}
æ–‡æ¡£å†…å®¹ï¼š${documentContent.substring(0, 300)}...
è¡¥å……ä¿¡æ¯ï¼š${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}

ã€ä¼˜åŒ–é¢†åŸŸã€‘ï¼š${area}

ã€å­æ¨¡å—ï¼ˆé”®â†’ä¸­æ–‡åï¼‰ã€‘
ç¢³æ’æ”¾ï¼š${JSON.stringify(carbonMapCN)}
æ—¶é—´ï¼š${JSON.stringify(timeMapCN)}

ã€å½“å‰åŸºçº¿ï¼ˆå•ä½ä¸¥æ ¼ç»Ÿä¸€ï¼‰ã€‘
ç¢³æ’æ”¾ï¼ˆkgCO2eï¼‰ï¼š${JSON.stringify(carbonBaseline)}
æ—¶é—´ï¼ˆå¤©ï¼‰ï¼š${JSON.stringify(timeBaseline)}

è¯·ä¸ºæ¯ä¸ªå»ºè®®æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ï¼š
{
  "suggestions": [
    {
      "icon": "å¯¹åº”çš„FontAwesomeå›¾æ ‡ç±»å",
      "title": "å»ºè®®æ ‡é¢˜",
      "desc": "è¯¦ç»†çš„å»ºè®®æè¿°ï¼ˆæ— éœ€å†è¿”å›ä»»ä½•äººç±»å¯è¯»çš„æ±‡æ€»å­—æ®µï¼‰",
      "subProject": "å­é¡¹ç›®åç§°",
      // å¿…å¡«ï¼šå®æ–½åçš„æ–°å€¼ï¼ˆå¿…é¡»åŒ…å«æ‰€æœ‰é”®ï¼›å•ä½ä¸åŸºçº¿ä¸€è‡´ï¼‰
      "carbonAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      // å¯é€‰ï¼šè‹¥æä¾› improvementsï¼Œå¿…é¡»ä¸ after æ•°å€¼ä¸¥æ ¼ä¸€è‡´ï¼ˆç³»ç»Ÿå°†éªŒè¯ï¼‰ï¼Œå¦åˆ™ä¸è¦è¿”å› improvements
      "carbonImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 }
    }
  ]
}

è¦æ±‚ï¼ˆåŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1) å­æ¨¡å—ä¸å•ä½ï¼šæ‰€æœ‰ after å€¼å¿…é¡»ä¸åŸºçº¿é”®ä¸€ä¸€å¯¹åº”ï¼Œå•ä½ä¸¥æ ¼ä¸€è‡´ï¼ˆç¢³æ’=kgCO2eï¼Œæ—¶é—´=å¤©ï¼‰ã€‚
2) æ•°å€¼åˆæ³•æ€§ï¼š
   - timeAfter å„é”®å¿…é¡»æ˜¯æ­£æ•´æ•°ï¼ˆ>=1ï¼‰ï¼›ä¸å¾—è¿”å›è´Ÿæ•°/0/ç™¾åˆ†å·/å­—ç¬¦ä¸²ã€‚
   - carbonAfter å„é”®å¿…é¡»æ˜¯éè´Ÿæ•°ï¼ˆ>=0ï¼‰ï¼Œå¯ä¿ç•™1ä½å°æ•°ï¼›ä¸å¾—è¿”å›è´Ÿæ•°/ç™¾åˆ†å·/å­—ç¬¦ä¸²ã€‚
   - å¯¹äºä¸å—å½±å“çš„é”®ï¼Œå°† after è®¾ç½®ä¸ºä¸åŸºçº¿ç›¸åŒçš„å€¼ã€‚
3) åˆç†èŒƒå›´ï¼ˆè¯·åŸºäºåŸºçº¿åšä¿å®ˆä¼°è®¡å¹¶é¿å…ç¦»è°±å€¼ï¼‰ï¼š
   - timeAfter[k] åº”åœ¨ [max(1, round(åŸºçº¿[k]*0.5)), round(åŸºçº¿[k]*1.3)] èŒƒå›´å†…ã€‚
   - carbonAfter[k] åº”åœ¨ [0, åŸºçº¿[k]*1.3] èŒƒå›´å†…ã€‚
4) è®¡ç®—ä¸€è‡´æ€§ï¼ˆè‹¥ç»™å‡º improvementsï¼‰ï¼š
   - ä½¿ç”¨å…¬å¼ after = round(åŸºçº¿ * (1 - improvement/100))ï¼ˆæ—¶é—´å››èˆäº”å…¥åˆ°å¤©ï¼Œç¢³æ’å››èˆäº”å…¥åˆ°1ä½å°æ•°ï¼‰ã€‚
   - improvement>0 è¡¨ç¤ºå‡å°‘ï¼ˆæ”¹è¿›ï¼‰ï¼Œ<0 è¡¨ç¤ºå¢åŠ ï¼ˆæƒè¡¡ï¼‰ã€‚
   - è¯·ç¡®ä¿ improvements ä¸ after ä¸€è‡´ï¼ˆä¾‹å¦‚ improvement=20ï¼Œåˆ™ afterâ‰ˆåŸºçº¿*0.8ï¼‰ã€‚
5) åªè¿”å›åˆæ³•JSONï¼›ä¸è¦è¿”å›ä»¥ä¸‹äººç±»å¯è¯»æ±‡æ€»å­—æ®µï¼štimeImprovementã€carbonReductionï¼ˆè¿™äº›ç”±ç³»ç»Ÿé€šè¿‡å‰åå¯¹æ¯”è‡ªåŠ¨è®¡ç®—ï¼‰ã€‚
7) è¯·ç¡®ä¿ carbonImprovements å’Œ timeImprovements çš„é”®ä¸â€œå­æ¨¡å—ï¼ˆé”®â†’ä¸­æ–‡åï¼‰â€å®Œå…¨å¯¹åº”ï¼Œç³»ç»Ÿå°†æ®æ­¤å±•ç¤ºâ€œæ¿å—å: å‡å°‘/å¢åŠ X%â€ã€‚
6) å¦‚æœç¼ºä¹ä¾æ®ï¼Œè¯·å°† after è®¾ç½®ä¸ºåŸºçº¿å€¼è€Œä¸æ˜¯è‡†æµ‹ã€‚`;

                console.log('AIæç¤ºè¯:', prompt);

                // è°ƒç”¨çœŸå®AI API
                console.log('å¼€å§‹è°ƒç”¨AI API...');
                const response = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-ai/DeepSeek-V3',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.error('AI APIå“åº”é”™è¯¯:', response.status, response.statusText);
                    throw new Error('AI APIè°ƒç”¨å¤±è´¥');
                }

                const data = await response.json();
                console.log('AI APIå“åº”æ•°æ®:', data);
                const aiResponse = data.choices[0].message.content;
                console.log('AIè¿”å›å†…å®¹:', aiResponse);

                // è§£æAIè¿”å›çš„JSON
                let suggestions;
                try {
                    // å°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        console.log('æå–çš„JSON:', jsonMatch[0]);
                        suggestions = JSON.parse(jsonMatch[0]);
                        console.log('è§£æåçš„å»ºè®®:', suggestions);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (suggestions.suggestions && Array.isArray(suggestions.suggestions)) {
                            suggestions.suggestions.forEach((suggestion, index) => {
                                // ç¡®ä¿æœ‰æ”¹è¿›ç™¾åˆ†æ¯”æ•°æ®
                                if (!suggestion.carbonImprovements || !suggestion.timeImprovements) {
                                    console.warn(`å»ºè®®${index + 1}ç¼ºå°‘æ”¹è¿›ç™¾åˆ†æ¯”æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼`);
                                    suggestion.carbonImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 8,
                                        usage: 20,
                                        recycling: 5,
                                        decomposition: 2
                                    };
                                    suggestion.timeImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 5,
                                        usage: 8,
                                        recycling: 12,
                                        decomposition: 5
                                    };
                                }
                                
                                // éªŒè¯ç™¾åˆ†æ¯”èŒƒå›´
                                Object.keys(suggestion.carbonImprovements).forEach(phase => {
                                    if (suggestion.carbonImprovements[phase] < -50 || suggestion.carbonImprovements[phase] > 100) {
                                        suggestion.carbonImprovements[phase] = Math.max(-50, Math.min(100, suggestion.carbonImprovements[phase]));
                                    }
                                });
                                
                                Object.keys(suggestion.timeImprovements).forEach(phase => {
                                    if (suggestion.timeImprovements[phase] < -50 || suggestion.timeImprovements[phase] > 100) {
                                        suggestion.timeImprovements[phase] = Math.max(-50, Math.min(100, suggestion.timeImprovements[phase]));
                                    }
                                });
                            });
                        }
                    } else {
                        console.error('æœªæ‰¾åˆ°JSONæ ¼å¼å†…å®¹');
                        throw new Error('æ— æ³•è§£æAIè¿”å›çš„JSON');
                    }
                } catch (parseError) {
                    console.error('AIè¿”å›å†…å®¹è§£æå¤±è´¥:', parseError);
                    console.error('AIè¿”å›å†…å®¹:', aiResponse);
                    throw parseError;
                }

                // æ¸²æŸ“å»ºè®®
                console.log('å¼€å§‹æ¸²æŸ“å»ºè®®:', area, suggestions);
                
                // ç¼“å­˜å»ºè®®ä¾›åç»­ä½¿ç”¨
                if (!window.lastSuggestionsCache) window.lastSuggestionsCache = {};
                window.lastSuggestionsCache[area] = suggestions.suggestions || suggestions;
                
                renderSuggestions(area, suggestions.suggestions || suggestions);

            } catch (error) {
                console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AIæœåŠ¡æš‚ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
                }
            }
        }

        // è®¡ç®—æ—¶é—´å˜åŒ–ï¼ˆåŸºäºAIç»“æœï¼‰
        function computeTimeChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const timeline = analysisData.timeline || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // ä»¥â€œå½“å‰å€¼â€ä¸ºåŸºçº¿è¿›è¡Œå¯¹æ¯”ï¼Œè€Œä¸æ˜¯ originalDurationï¼Œé¿å…å—åˆ°å†å²é‡‡çº³å½±å“
            const beforeTotal = keys.reduce((sum, k) => sum + (timeline[k]?.duration || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: 'æ—¶é—´: æ— å˜åŒ–' };
            }
            // ä¼˜å…ˆä½¿ç”¨ timeAfter
            let afterTotal = 0;
            let hasAfter = suggestion && suggestion.timeAfter && typeof suggestion.timeAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const raw = suggestion.timeAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // è§†ä¸ºâ€œæ–°å€¼ï¼ˆç»å¯¹å€¼ï¼‰â€
                            normalized = raw;
                        } else if (raw === 0) {
                            // ä¸å˜
                            normalized = base;
                        } else {
                            // è´Ÿæ•°ï¼šè§†ä¸ºâ€œç›¸å¯¹å˜åŒ–ï¼ˆå¤©ï¼‰â€
                            normalized = Math.max(1, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.timeImprovements && typeof suggestion.timeImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const pct = suggestion.timeImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(1, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: 'æ—¶é—´: æ— å˜åŒ–' };
            }
            const delta = Math.round(beforeTotal - afterTotal);
            if (delta > 0) {
                return { isImprovement: true, displayText: `æ—¶é—´: å‡å°‘ ${delta}å¤©` };
            } else if (delta < 0) {
                return { isImprovement: false, displayText: `æ—¶é—´: å¢åŠ  ${Math.abs(delta)}å¤©` };
            }
            return { isImprovement: true, displayText: 'æ—¶é—´: æ— å˜åŒ–' };
        }

        // è®¡ç®—ç¢³æ’æ”¾å˜åŒ–ï¼ˆåŸºäºAIç»“æœï¼‰
        function computeCarbonChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // ä»¥â€œå½“å‰å€¼â€ä¸ºåŸºçº¿è¿›è¡Œå¯¹æ¯”
            const beforeTotal = keys.reduce((sum, k) => sum + (emissions[k]?.value || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: 'ç¢³æ’æ”¾: æ— å˜åŒ–' };
            }
            // ä¼˜å…ˆä½¿ç”¨ carbonAfter
            let afterTotal = 0;
            const hasAfter = suggestion && suggestion.carbonAfter && typeof suggestion.carbonAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const raw = suggestion.carbonAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // è§†ä¸ºâ€œæ–°å€¼ï¼ˆç»å¯¹å€¼kgCO2eï¼‰â€
                            normalized = Math.max(0, raw);
                        } else if (raw === 0) {
                            // ä¸å˜
                            normalized = base;
                        } else {
                            // è´Ÿæ•°ï¼šè§†ä¸ºâ€œç›¸å¯¹å˜åŒ–ï¼ˆkgCO2eï¼‰â€ï¼Œbase + delta
                            normalized = Math.max(0, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.carbonImprovements && typeof suggestion.carbonImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const pct = suggestion.carbonImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(0, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: 'ç¢³æ’æ”¾: æ— å˜åŒ–' };
            }
            const deltaPct = beforeTotal > 0 ? Math.round(((beforeTotal - afterTotal) / beforeTotal) * 100) : 0;
            if (deltaPct > 0) {
                return { isImprovement: true, displayText: `ç¢³æ’æ”¾: å‡å°‘ ${deltaPct}%` };
            } else if (deltaPct < 0) {
                return { isImprovement: false, displayText: `ç¢³æ’æ”¾: å¢åŠ  ${Math.abs(deltaPct)}%` };
            }
            return { isImprovement: true, displayText: 'ç¢³æ’æ”¾: æ— å˜åŒ–' };
        }

        // é€æ¿å—å˜åŒ–æ˜ç»†ï¼ˆç¢³æ’ä¸æ—¶é—´ï¼‰
        function computePhaseChangeDetails(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const timeline = analysisData.timeline || {};
            const carbonKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const timeKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const carbonLabel = {procurement:'åŸæ–™é‡‡è´­',manufacturing:'ç”Ÿäº§åˆ¶é€ ',logistics:'ç‰©æµè¿è¾“',usage:'äº§å“ä½¿ç”¨',recycling:'å›æ”¶å¤„ç†',decomposition:'è‡ªç„¶é™è§£'};
            const timeLabel = {procurement:'åŸæ–™é‡‡è´­',manufacturing:'ç”Ÿäº§åˆ¶é€ ',logistics:'ç‰©æµè¿è¾“',usage:'äº§å“ä½¿ç”¨',recycling:'å›æ”¶å¤„ç†',decomposition:'è‡ªç„¶é™è§£'};

            const carbonItems = carbonKeys.map(k => {
                const base = emissions[k]?.value ?? 0;
                let after;
                if (suggestion?.carbonAfter && typeof suggestion.carbonAfter[k] === 'number') {
                    const raw = suggestion.carbonAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(0, base + raw);
                } else if (suggestion?.carbonImprovements && typeof suggestion.carbonImprovements[k] === 'number') {
                    const pct = suggestion.carbonImprovements[k];
                    after = Math.max(0, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? 'â†“' : (deltaPct < 0 ? 'â†‘' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${carbonLabel[k]}: ${base}â†’${after} (${pctText})`;
            });

            const timeItems = timeKeys.map(k => {
                const base = timeline[k]?.duration ?? 0;
                let after;
                if (suggestion?.timeAfter && typeof suggestion.timeAfter[k] === 'number') {
                    const raw = suggestion.timeAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(1, base + raw);
                } else if (suggestion?.timeImprovements && typeof suggestion.timeImprovements[k] === 'number') {
                    const pct = suggestion.timeImprovements[k];
                    after = Math.max(1, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? 'â†“' : (deltaPct < 0 ? 'â†‘' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${timeLabel[k]}: ${base}â†’${after} (${pctText})`;
            });

            return {
                carbonHtml: carbonItems.join('ã€ '),
                timeHtml: timeItems.join('ã€ ')
            };
        }

        // æ¸²æŸ“å»ºè®®å‡½æ•°
        window.renderSuggestions = function(area, suggestions) {
            console.log('å¼€å§‹æ¸²æŸ“å»ºè®®:', area, suggestions);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('æ‰¾ä¸åˆ°suggestionsContentå…ƒç´ ');
                return;
            }

            if (!suggestions || suggestions.length === 0) {
                suggestionsDiv.innerHTML = '<div class="no-suggestions">æš‚æ— ä¼˜åŒ–å»ºè®®</div>';
                return;
            }

            const suggestionsHTML = suggestions.map((suggestion, index) => {
                const isAccepted = window.acceptedSuggestions.includes(suggestion.title);
                
                // è®¡ç®—æ—¶é—´æ”¹è¿›ï¼ˆåŸºäºAIç»“æœå¯¹æ¯”åŸºçº¿ï¼‰
                const timeEffect = computeTimeChangeSummary(suggestion);
                const carbonEffect = computeCarbonChangeSummary(suggestion);
                const phaseDetails = computePhaseChangeDetails(suggestion);
                
                return `
                    <div class="suggestion-card ${isAccepted ? 'accepted' : ''}" data-index="${index}" data-suggestion-title="${suggestion.title}">
                        <div class="suggestion-header">
                            <div class="suggestion-icon">
                                <i class="${suggestion.icon}"></i>
                            </div>
                            <div class="suggestion-title">
                                <h4>${suggestion.title}</h4>
                                <div class="improvement-metrics">
                                    <div class="metric time-metric ${timeEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-clock"></i>
                                        <span>${timeEffect.displayText}</span>
                                    </div>
                                    <div class="metric carbon-metric ${carbonEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-leaf"></i>
                                        <span>${carbonEffect.displayText}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <p class="suggestion-desc">${suggestion.desc}</p>
                            <div class="suggestion-details">
                                <span class="sub-project">å­é¡¹ç›®: ${suggestion.subProject}</span>
                                <div class="phase-details" style="margin-top:8px; font-size: 12px; color:#4b5563; line-height:1.6;">
                                    <div><strong>ç¢³æ’æ”¾</strong>ï¼š${phaseDetails.carbonHtml}</div>
                                    <div><strong>æ—¶é—´</strong>ï¼š${phaseDetails.timeHtml}</div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-actions">
                            ${isAccepted ? 
                                '<div class="accepted-status"><i class="fas fa-check"></i> å·²é‡‡çº³</div>' :
                                `<button class="btn btn-success btn-sm" onclick="acceptSuggestion('${suggestion.title}', event)">
                                    <i class="fas fa-check"></i> é‡‡çº³å»ºè®®
                                </button>`
                            }
                            <button class="btn btn-primary btn-sm" onclick="askAI('${suggestion.title}', '${area}')">
                                <i class="fas fa-robot"></i> è¯¢é—®AI
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            suggestionsDiv.innerHTML = suggestionsHTML;
            console.log('å»ºè®®æ¸²æŸ“å®Œæˆ');
        };

        // è§£ææ”¹è¿›æ•ˆæœå­—ç¬¦ä¸²
        function parseImprovementEffect(effectString, type) {
            if (!effectString) {
                return { 
                    isImprovement: true, 
                    value: '0%',
                    displayText: type === 'time' ? 'æ—¶é—´: æ— å˜åŒ–' : 'ç¢³æ’æ”¾: æ— å˜åŒ–'
                };
            }
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«"å‡å°‘"æˆ–"å¢åŠ "
            const isImprovement = effectString.includes('å‡å°‘') || effectString.includes('é™ä½');
            const isTradeoff = effectString.includes('å¢åŠ ') || effectString.includes('æé«˜');
            
            // æå–æ•°å€¼å’Œå•ä½
            const match = effectString.match(/(\d+(?:\.\d+)?)([%ä¸ªæœˆå¤©å°æ—¶])/);
            if (match) {
                const value = parseFloat(match[1]);
                const unit = match[2];
                
                // å¦‚æœæ•°å€¼ä¸ºè´Ÿæ•°ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º"å¢åŠ "
                if (value < 0) {
                    const absValue = Math.abs(value);
                    const displayText = type === 'time' ? 
                        `æ—¶é—´: å¢åŠ  ${absValue}${unit}` : 
                        `ç¢³æ’æ”¾: å¢åŠ  ${absValue}${unit}`;
                    
                    return {
                        isImprovement: false,
                        value: absValue + unit,
                        displayText: displayText
                    };
                } else {
                    const displayText = type === 'time' ? 
                        `æ—¶é—´: å‡å°‘ ${value}${unit}` : 
                        `ç¢³æ’æ”¾: å‡å°‘ ${value}${unit}`;
                    
                    return {
                        isImprovement: true,
                        value: value + unit,
                        displayText: displayText
                    };
                }
            }
            
            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ•°å€¼ï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯
            let displayText = '';
            if (type === 'time') {
                if (isImprovement) {
                    displayText = `æ—¶é—´: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `æ—¶é—´: ${effectString}`;
                } else {
                    displayText = `æ—¶é—´: ${effectString}`;
                }
            } else {
                if (isImprovement) {
                    displayText = `ç¢³æ’æ”¾: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `ç¢³æ’æ”¾: ${effectString}`;
                } else {
                    displayText = `ç¢³æ’æ”¾: ${effectString}`;
                }
            }
            
            return { 
                isImprovement: isImprovement || !isTradeoff, 
                value: effectString,
                displayText: displayText
            };
        }

        // å¤‡ç”¨å»ºè®®ç”Ÿæˆå‡½æ•° - å¢åŠ æ”¹è¿›ç™¾åˆ†æ¯”å­—æ®µ
        window.getFallbackSuggestions = function(area, productTypeName) {
            const fallbackSuggestions = {
                'ææ–™é€‰æ‹©': [
                    {
                        icon: 'fas fa-seedling',
                        title: `${productTypeName}ç”Ÿç‰©åŸºææ–™æ›¿ä»£`,
                        timeImprovement: 'å‡å°‘25%åŠ å·¥æ—¶é—´',
                        carbonReduction: 'é™ä½60%ææ–™æ’æ”¾',
                        desc: `é’ˆå¯¹${productTypeName}ç‰¹ç‚¹ï¼Œé‡‡ç”¨ç”Ÿç‰©é™è§£ææ–™æ›¿ä»£ä¼ ç»Ÿææ–™ï¼Œå‡å°‘åŒ–å­¦å¤„ç†å·¥åºå’Œç¯å¢ƒå½±å“`,
                        subProject: 'ç”Ÿç‰©åŸºææ–™é€‰æ‹©',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 30,
                            recycling: 8,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 20,
                            logistics: 5,
                            usage: 10,
                            recycling: 12,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName}å¾ªç¯ææ–™åº”ç”¨`,
                        timeImprovement: 'èŠ‚çœ30%åˆ¶å¤‡æ—¶é—´',
                        carbonReduction: 'å‡å°‘50%åŸæ–™æ’æ”¾',
                        desc: `å»ºç«‹${productTypeName}é—­ç¯ææ–™å¾ªç¯ä½“ç³»ï¼Œå®ç°åºŸæ–™å†åˆ©ç”¨ï¼Œé™ä½åŸææ–™é‡‡è´­æˆæœ¬`,
                        subProject: 'å›æ”¶ææ–™åº”ç”¨',
                        carbonImprovements: {
                            procurement: 25,
                            manufacturing: 10,
                            logistics: 5,
                            usage: 15,
                            recycling: 20,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 18,
                            manufacturing: 12,
                            logistics: 5,
                            usage: 8,
                            recycling: 25,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-feather-alt',
                        title: `${productTypeName}è½»é‡åŒ–è®¾è®¡`,
                        timeImprovement: 'ç¼©çŸ­20%è¿è¾“æ—¶é—´',
                        carbonReduction: 'é™ä½40%ç‰©æµæ’æ”¾',
                        desc: `é‡‡ç”¨è½»é‡åŒ–ææ–™å’Œç»“æ„è®¾è®¡ï¼Œå‡å°‘${productTypeName}è¿è¾“æˆæœ¬å’Œæ’æ”¾`,
                        subProject: 'è½»é‡åŒ–ç»“æ„è®¾è®¡',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 10,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 5,
                            recycling: 8,
                            decomposition: 3
                        }
                    }
                ],
                'ç”Ÿäº§å·¥è‰º': [
                    {
                        icon: 'fas fa-cogs',
                        title: `${productTypeName}ç²¾ç›Šç”Ÿäº§æµç¨‹`,
                        timeImprovement: 'ç¼©çŸ­35%ç”Ÿäº§å‘¨æœŸ',
                        carbonReduction: 'é™ä½40%å·¥è‰ºæ’æ”¾',
                        desc: `é’ˆå¯¹${productTypeName}ç‰¹ç‚¹å®æ–½ç²¾ç›Šç”Ÿäº§ç†å¿µï¼Œæ¶ˆé™¤æµªè´¹å’Œå†—ä½™å·¥åº`,
                        subProject: 'ç²¾ç›Šç”Ÿäº§æµç¨‹',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 8,
                            usage: 15,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 12,
                            manufacturing: 30,
                            logistics: 5,
                            usage: 8,
                            recycling: 10,
                            decomposition: 3
                        }
                    },
                    {
                        icon: 'fas fa-bolt',
                        title: `${productTypeName}æ¸…æ´èƒ½æºè½¬æ¢`,
                        timeImprovement: 'å‡å°‘15%èƒ½è€—æ—¶é—´',
                        carbonReduction: 'é™ä½70%èƒ½æºæ’æ”¾',
                        desc: `ä¸º${productTypeName}ç”Ÿäº§é‡‡ç”¨å¤ªé˜³èƒ½ã€é£èƒ½ç­‰æ¸…æ´èƒ½æºæ›¿ä»£ä¼ ç»Ÿèƒ½æº`,
                        subProject: 'æ¸…æ´èƒ½æºè½¬æ¢',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 60,
                            logistics: 10,
                            usage: 20,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 3,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-fire',
                        title: `${productTypeName}ä½™çƒ­å›æ”¶ç³»ç»Ÿ`,
                        timeImprovement: 'æå‡30%èƒ½æ•ˆ',
                        carbonReduction: 'å‡å°‘35%çƒ­èƒ½æŸå¤±',
                        desc: `å®‰è£…${productTypeName}ä½™çƒ­å›æ”¶ç³»ç»Ÿï¼Œæé«˜èƒ½æºåˆ©ç”¨æ•ˆç‡`,
                        subProject: 'ä½™çƒ­å›æ”¶ç³»ç»Ÿ',
                        carbonImprovements: {
                            procurement: 3,
                            manufacturing: 25,
                            logistics: 5,
                            usage: 10,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 20,
                            logistics: 2,
                            usage: 5,
                            recycling: 10,
                            decomposition: 2
                        }
                    }
                ],
                'ä¾›åº”é“¾ç®¡ç†': [
                    {
                        icon: 'fas fa-map',
                        title: `${productTypeName}å°±è¿‘é‡‡è´­ç­–ç•¥`,
                        timeImprovement: 'å‡å°‘40%è¿è¾“æ—¶é—´',
                        carbonReduction: 'é™ä½45%ç‰©æµæ’æ”¾',
                        desc: `ä¸º${productTypeName}ä¼˜å…ˆé€‰æ‹©æœ¬åœ°ä¾›åº”å•†ï¼Œå‡å°‘è¿è¾“è·ç¦»å’Œæ—¶é—´`,
                        subProject: 'å°±è¿‘é‡‡è´­ç­–ç•¥',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 8,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 25,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-chart-line',
                        title: `${productTypeName}æ•°å­—åŒ–ç®¡ç†å¹³å°`,
                        timeImprovement: 'æå‡50%å†³ç­–æ•ˆç‡',
                        carbonReduction: 'å‡å°‘35%ç®¡ç†æ’æ”¾',
                        desc: `å»ºç«‹${productTypeName}æ•°å­—åŒ–ç®¡ç†å¹³å°ï¼Œå®ç°æ•°æ®é©±åŠ¨å†³ç­–`,
                        subProject: 'æ•°å­—åŒ–ç®¡ç†å¹³å°',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 25,
                            usage: 10,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 30,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 15,
                            recycling: 20,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-users',
                        title: `${productTypeName}æ•æ·å›¢é˜Ÿåä½œ`,
                        timeImprovement: 'å‡å°‘45%æ²Ÿé€šæ—¶é—´',
                        carbonReduction: 'é™ä½30%åè°ƒæˆæœ¬',
                        desc: `é‡‡ç”¨æ•æ·å·¥ä½œæ–¹æ³•ï¼Œæé«˜${productTypeName}å›¢é˜Ÿåä½œæ•ˆç‡`,
                        subProject: 'æ•æ·å›¢é˜Ÿåä½œ',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 12,
                            logistics: 8,
                            usage: 5,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 20,
                            manufacturing: 18,
                            logistics: 10,
                            usage: 10,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                'äº§å“è®¾è®¡': [
                    {
                        icon: 'fas fa-microchip',
                        title: `${productTypeName}æ™ºèƒ½åŒ–å‡çº§`,
                        timeImprovement: 'å‡å°‘45%å¤„ç†æ—¶é—´',
                        carbonReduction: 'é™ä½40%ç¢³æ’æ”¾',
                        desc: `ä¸º${productTypeName}é‡‡ç”¨AIå’Œç‰©è”ç½‘æŠ€æœ¯ä¼˜åŒ–æµç¨‹ï¼Œå®ç°æ™ºèƒ½ç›‘æ§`,
                        subProject: 'æ™ºèƒ½ä¼ æ„Ÿå™¨é›†æˆ',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 30,
                            recycling: 10,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 15,
                            usage: 20,
                            recycling: 15,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-robot',
                        title: `${productTypeName}è‡ªåŠ¨åŒ–æ”¹é€ `,
                        timeImprovement: 'ç¼©çŸ­55%æ“ä½œæ—¶é—´',
                        carbonReduction: 'å‡å°‘35%èƒ½è€—',
                        desc: `å¼•å…¥${productTypeName}æœºå™¨äººå’Œè‡ªåŠ¨åŒ–äº§çº¿ï¼Œå‡å°‘äººå·¥å¹²é¢„`,
                        subProject: 'è‡ªåŠ¨åŒ–æ§åˆ¶ç³»ç»Ÿ',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 30,
                            logistics: 15,
                            usage: 20,
                            recycling: 12,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 15,
                            usage: 15,
                            recycling: 18,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-brain',
                        title: `${productTypeName}ç®—æ³•ä¼˜åŒ–`,
                        timeImprovement: 'æå‡65%è®¡ç®—æ•ˆç‡',
                        carbonReduction: 'é™ä½30%æœåŠ¡å™¨æ’æ”¾',
                        desc: `ä¼˜åŒ–${productTypeName}æ ¸å¿ƒç®—æ³•ï¼Œå‡å°‘è®¡ç®—èµ„æºéœ€æ±‚`,
                        subProject: 'æœºå™¨å­¦ä¹ ç®—æ³•ä¼˜åŒ–',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                'åŒ…è£…æ–¹æ¡ˆ': [
                    {
                        icon: 'fas fa-box-open',
                        title: `${productTypeName}ç®€çº¦åŒ…è£…è®¾è®¡`,
                        timeImprovement: 'å‡å°‘30%åŒ…è£…æ—¶é—´',
                        carbonReduction: 'é™ä½50%åŒ…è£…ææ–™',
                        desc: `ä¸º${productTypeName}é‡‡ç”¨ç®€çº¦åŒ…è£…è®¾è®¡ï¼Œå‡å°‘ææ–™ä½¿ç”¨`,
                        subProject: 'ç®€çº¦åŒ…è£…è®¾è®¡',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 5,
                            recycling: 15,
                            decomposition: 8
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 20,
                            decomposition: 10
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName}å¯å›æ”¶åŒ…è£…ææ–™`,
                        timeImprovement: 'èŠ‚çœ25%å¤„ç†æ—¶é—´',
                        carbonReduction: 'å‡å°‘40%åŒ…è£…æ’æ”¾',
                        desc: `ä½¿ç”¨${productTypeName}å¯å›æ”¶åŒ…è£…ææ–™ï¼Œå»ºç«‹åŒ…è£…å›æ”¶ä½“ç³»`,
                        subProject: 'å¯å›æ”¶åŒ…è£…ææ–™',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 25,
                            decomposition: 12
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 15,
                            usage: 2,
                            recycling: 30,
                            decomposition: 15
                        }
                    },
                    {
                        icon: 'fas fa-leaf',
                        title: `${productTypeName}ç»¿è‰²åŒ…è£…è®¤è¯`,
                        timeImprovement: 'æå‡20%å“ç‰Œä»·å€¼',
                        carbonReduction: 'é™ä½25%ç¯å¢ƒå½±å“',
                        desc: `ä¸º${productTypeName}è·å¾—ç»¿è‰²åŒ…è£…è®¤è¯ï¼Œæå‡å“ç‰Œå½¢è±¡`,
                        subProject: 'ç»¿è‰²åŒ…è£…è®¤è¯',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 3,
                            logistics: 15,
                            usage: 8,
                            recycling: 18,
                            decomposition: 10
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 3,
                            logistics: 10,
                            usage: 5,
                            recycling: 22,
                            decomposition: 12
                        }
                    }
                ]
            };

            return fallbackSuggestions[area] || fallbackSuggestions['äº§å“è®¾è®¡'];
        }

        // æ›´æ–°é‡‡çº³å»ºè®®åçš„æ•°æ®å˜åŒ–å‡½æ•°
        window.updateDataAfterAcceptance = function(suggestionTitle) {
            // æŸ¥æ‰¾å¯¹åº”çš„å»ºè®®æ•°æ®
            let suggestionData = null;
            if (window.lastSuggestionsCache && window.currentSelectedArea) {
                const suggestions = window.lastSuggestionsCache[window.currentSelectedArea];
                if (suggestions) {
                    suggestionData = suggestions.find(s => s.title === suggestionTitle);
                }
            }
            
            if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                // æ›´æ–°ç¢³æ’æ”¾æ•°æ®
                if (window.analysisData && window.analysisData.emissions) {
                    Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                        if (window.analysisData.emissions[phase]) {
                            const improvement = suggestionData.carbonImprovements[phase];
                            const currentValue = window.analysisData.emissions[phase].value;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.emissions[phase].value = newValue;
                            
                            // æ›´æ–°æ˜¾ç¤º
                            const emissionCard = document.querySelector(`[onclick*="${phase}"]`);
                            if (emissionCard) {
                                const valueElement = emissionCard.querySelector('.emission-value');
                                if (valueElement) {
                                    valueElement.textContent = newValue;
                                    valueElement.style.color = '#28a745'; // ç»¿è‰²è¡¨ç¤ºæ”¹è¿›
                                }

                            }
                        }
                    });
                }
                
                // æ›´æ–°æ—¶é—´æ•°æ®
                if (window.analysisData && window.analysisData.timeline) {
                    Object.keys(suggestionData.timeImprovements).forEach(phase => {
                        if (window.analysisData.timeline[phase]) {
                            const improvement = suggestionData.timeImprovements[phase];
                            const currentValue = window.analysisData.timeline[phase].duration;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.timeline[phase].duration = newValue;
                            window.analysisData.timeline[phase].improved = true;
                            window.analysisData.timeline[phase].reductionAmount = currentValue - newValue;
                            
                            // æ›´æ–°æ˜¾ç¤º
                            const timelineCard = document.querySelector(`[data-phase="${phase}"]`);
                            if (timelineCard) {
                                const valueElement = timelineCard.querySelector('.duration-value');
                                if (valueElement) {
                                    valueElement.textContent = `${newValue} (-${currentValue - newValue})`;
                                    valueElement.classList.add('improved');
                                    valueElement.style.color = '#28a745'; // ç»¿è‰²è¡¨ç¤ºæ”¹è¿›
                                }
                            }
                        }
                    });
                }
            }
        };

        // ç´¯ç§¯è®¡ç®—æ‰€æœ‰å·²é‡‡çº³å»ºè®®çš„æ•ˆæœ
        window.calculateCumulativeImprovements = function() {
            if (!window.acceptedSuggestions || window.acceptedSuggestions.length === 0) {
                return { carbon: {}, time: {} };
            }

            const cumulativeCarbon = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };
            
            const cumulativeTime = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };

            // éå†æ‰€æœ‰å·²é‡‡çº³çš„å»ºè®®
            window.acceptedSuggestions.forEach(suggestionTitle => {
                // åœ¨æ‰€æœ‰ç¼“å­˜ä¸­æŸ¥æ‰¾å»ºè®®æ•°æ®
                Object.keys(window.acceptedSuggestionsByArea || {}).forEach(area => {
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        const suggestions = window.lastSuggestionsCache[area];
                        const suggestionData = suggestions.find(s => s.title === suggestionTitle);
                        
                        if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                            // ç´¯ç§¯ç¢³æ’æ”¾æ”¹è¿›
                            Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                                if (cumulativeCarbon.hasOwnProperty(phase)) {
                                    cumulativeCarbon[phase] += suggestionData.carbonImprovements[phase];
                                }
                            });
                            
                            // ç´¯ç§¯æ—¶é—´æ”¹è¿›
                            Object.keys(suggestionData.timeImprovements).forEach(phase => {
                                if (cumulativeTime.hasOwnProperty(phase)) {
                                    cumulativeTime[phase] += suggestionData.timeImprovements[phase];
                                }
                            });
                        }
                    }
                });
            });

            return { carbon: cumulativeCarbon, time: cumulativeTime };
        };

        // æ›´æ–°æ‰€æœ‰æ•°æ®å¡ç‰‡æ˜¾ç¤º
        window.updateAllDataCards = function() {
            const improvements = window.calculateCumulativeImprovements();
            
            // å…ˆæ›´æ–°ç¢³æ’æ”¾ä¸æ—¶é—´æ•°æ®ï¼Œå†ç»Ÿä¸€åˆ·æ–°UIï¼Œç¡®ä¿æ˜¾ç¤ºçš„æ˜¯æœ€æ–°æ•°æ®
            // æ›´æ–°ç¢³æ’æ”¾æ•°æ®å¡ç‰‡ï¼ˆå†™å…¥ originalValue ä»¥ä¾¿å¡ç‰‡é‡æ¸²æŸ“æ—¶æ˜¾ç¤ºâ€œæ–°å€¼ (Â±å·®)â€ï¼‰
            if (window.analysisData && window.analysisData.emissions) {
                const totalBefore = Object.values(window.analysisData.emissions).reduce((s, d) => s + (d.originalValue || d.value), 0);
                Object.keys(improvements.carbon).forEach(phase => {
                    if (window.analysisData.emissions[phase]) {
                        const originalValue = window.analysisData.emissions[phase].originalValue || window.analysisData.emissions[phase].value;
                        const improvement = improvements.carbon[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // æ›´æ–°æ•°æ®
                        window.analysisData.emissions[phase].value = newValue;
                        window.analysisData.emissions[phase].originalValue = originalValue;
                        // æ­¤å¤„ä¸ç›´æ¥æ›´æ–°DOMï¼Œäº¤ç”± refreshLeanTimelineData()+ç”Ÿæˆå¡ç‰‡å‡½æ•°ç»Ÿä¸€æ¸²æŸ“
                    }
                });
                const totalAfter = Object.values(window.analysisData.emissions).reduce((s, d) => s + d.value, 0);
                window.__combinedCarbon__ = { before: Math.round(totalBefore), after: Math.round(totalAfter) };
            }
            
            // æ›´æ–°æ—¶é—´æ•°æ®å¡ç‰‡
            if (window.analysisData && window.analysisData.timeline) {
                const totalBeforeTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + (d.originalDuration || d.duration), 0);
                Object.keys(improvements.time).forEach(phase => {
                    if (window.analysisData.timeline[phase]) {
                        const originalValue = window.analysisData.timeline[phase].originalDuration || window.analysisData.timeline[phase].duration;
                        const improvement = improvements.time[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // æ›´æ–°æ•°æ®
                        window.analysisData.timeline[phase].duration = newValue;
                        window.analysisData.timeline[phase].originalDuration = originalValue;
                        window.analysisData.timeline[phase].improved = improvement > 0;
                        window.analysisData.timeline[phase].reductionAmount = originalValue - newValue;
                        
                        // DOMæ›´æ–°å°†é€šè¿‡refreshLeanTimelineData()ç»Ÿä¸€å¤„ç†
                    }
                });
                const totalAfterTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + d.duration, 0);
                window.__combinedTime__ = { before: Math.round(totalBeforeTime), after: Math.round(totalAfterTime) };
            }
            
            // æœ€ååˆ·æ–°Leanæ¨¡å—çš„æ—¶é—´ä¸ç¢³æ’æ•°æ®æ˜¾ç¤ºï¼ˆæ­¤æ—¶analysisDataå·²æ›´æ–°ï¼‰
            if (typeof refreshLeanTimelineData === 'function') {
                refreshLeanTimelineData();
            }
            if (typeof refreshLeanEmissionData === 'function') {
                refreshLeanEmissionData();
            }
        };

        // æ·±åº¦åˆ†æAIè°ƒç”¨å‡½æ•° - ä½¿ç”¨çœŸå®AI API
        async function callSuggestionAI(question, suggestion) {
            try {
                // è·å–å½“å‰æ–‡æ¡£å’Œäº§å“ä¿¡æ¯
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);

                // æ„å»ºå®Œæ•´AIæç¤ºè¯ï¼ˆåŒ…å«ä¸Šä¸‹æ–‡ï¼Œä½†è¦æ±‚å›ç­”ç®€æ´ï¼‰
                const prompt = `ä½œä¸ºç¢³æ’æ”¾ä¸“å®¶ï¼ŒåŸºäºä»¥ä¸‹å®Œæ•´ä¿¡æ¯å›ç­”é—®é¢˜ï¼š"${question}"

ã€äº§å“ä¿¡æ¯ã€‘ï¼š
äº§å“ç±»å‹ï¼š${productTypeName}
æ–‡æ¡£æ‘˜è¦ï¼š${documentContent.substring(0, 300)}...

ã€è¡¥å……æ•°æ®ã€‘ï¼š
${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join('\n')}

ã€å½“å‰å»ºè®®ã€‘ï¼š
æ ‡é¢˜ï¼š${suggestion.title}
æè¿°ï¼š${suggestion.description}

è¦æ±‚ï¼šåŸºäºä»¥ä¸Šå®Œæ•´ä¿¡æ¯å›ç­”ï¼Œä½†å›ç­”è¦ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡60å­—ï¼Œé‡ç‚¹è¯´æ˜ä¸é—®é¢˜ç›¸å…³çš„æ ¸å¿ƒè¦ç‚¹ã€‚`;

                // æ§åˆ¶å°è°ƒè¯•æ—¥å¿— - AIè¾“å…¥
                console.log('=================== AIå»ºè®®å’¨è¯¢è°ƒç”¨ ===================');
                console.log('ğŸ”¹ ç”¨æˆ·é—®é¢˜:', question);
                console.log('ğŸ”¹ å’¨è¯¢å»ºè®®:', suggestion);
                console.log('ğŸ”¹ äº§å“ç±»å‹:', productTypeName);
                console.log('ğŸ”¹ æ–‡æ¡£å†…å®¹é•¿åº¦:', documentContent.length, 'å­—ç¬¦');
                console.log('ğŸ”¹ è¡¥å……æ•°æ®:', supplementData);
                console.log('ğŸ”¹ APIç«¯ç‚¹:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('ğŸ”¹ æ¨¡å‹:', 'deepseek-ai/DeepSeek-V3');
                console.log('ğŸ“¤ å®Œæ•´AIæç¤ºè¯:');
                console.log(prompt);
                const requestBody = {
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 200, // å‡å°‘tokenæ•°é‡ä»¥æ§åˆ¶å›ç­”é•¿åº¦
                    temperature: 0.7
                };
                console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:');
                console.log(JSON.stringify(requestBody, null, 2));

                // è°ƒç”¨çœŸå®AI API
                const response = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // æ§åˆ¶å°è°ƒè¯•æ—¥å¿— - APIå“åº”
                console.log('ğŸ“¥ APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('âŒ AI APIè°ƒç”¨å¤±è´¥:', response.status, response.statusText);
                    throw new Error('AI APIè°ƒç”¨å¤±è´¥');
                }

                const data = await response.json();
                console.log('ğŸ“¥ AIå®Œæ•´å“åº”æ•°æ®:');
                console.log(JSON.stringify(data, null, 2));
                
                const aiResponse = data.choices[0].message.content;
                console.log('ğŸ“„ AIè¿”å›å†…å®¹:');
                console.log(aiResponse);
                console.log('ğŸ“Š å›ç­”å­—æ•°:', aiResponse.length);
                console.log('===============================================');
                
                return aiResponse;
            } catch (error) {
                console.error('æ·±åº¦åˆ†æAIè°ƒç”¨é”™è¯¯:', error);
                throw error;
            }
        }

        // å¤‡ç”¨æ·±åº¦åˆ†æAIå›å¤ï¼ˆå½“çœŸå®AI APIä¸å¯ç”¨æ—¶ï¼‰
        function generateFallbackSuggestionAIResponse(question, suggestion) {
            const productTypeName = getDocumentTypeName(window.currentAnalysis?.documentType || 'general');
            
            return `ğŸ¤– **AIæ·±åº¦åˆ†æ** - ${suggestion.title}

åŸºäºæ‚¨çš„é—®é¢˜"${question}"ï¼Œæˆ‘ä¸ºæ‚¨æä¾›ä»¥ä¸‹ä¸“ä¸šåˆ†æï¼š

**äº§å“èƒŒæ™¯**ï¼š
å½“å‰åˆ†æçš„äº§å“ç±»å‹ï¼š${productTypeName}

**æ ¸å¿ƒè¦ç‚¹**ï¼š
${suggestion.description}

**ä¸“ä¸šå»ºè®®**ï¼š
1. å»ºè®®å…ˆè¿›è¡Œå¯è¡Œæ€§è¯„ä¼°å’Œè¯•ç‚¹æµ‹è¯•
2. åˆ¶å®šè¯¦ç»†çš„å®æ–½è®¡åˆ’å’Œæ—¶é—´è¡¨
3. å»ºç«‹ç›‘æ§å’Œè¯„ä¼°æœºåˆ¶
4. æ³¨é‡å‘˜å·¥åŸ¹è®­å’Œå‚ä¸

**é¢„æœŸæ”¶ç›Š**ï¼š
- æ—¶é—´æ•ˆç‡: ${suggestion.timeImprovement || 'æ˜¾è‘—æå‡'}
- ç¢³æ’æ”¾: ${suggestion.carbonReduction || 'å¤§å¹…å‡å°‘'}
- é•¿æœŸä»·å€¼: æå‡ä¼ä¸šç«äº‰åŠ›

**æ³¨æ„**ï¼šå½“å‰ä¸ºå¤‡ç”¨å›å¤æ¨¡å¼ï¼Œå»ºè®®åœ¨ç½‘ç»œæ­£å¸¸æ—¶é‡æ–°è¯¢é—®ä»¥è·å¾—æ›´ç²¾å‡†çš„AIåˆ†æã€‚

å¦‚éœ€æ›´è¯¦ç»†çš„åˆ†æï¼Œè¯·å…·ä½“è¯¢é—®å¯è¡Œæ€§ã€å®æ–½æ­¥éª¤ã€æ•ˆæœè¯„ä¼°æˆ–é£é™©è¯„ä¼°ç­‰æ–¹é¢çš„é—®é¢˜ã€‚`;
        }

        // æ¸²æŸ“å¯¹è¯å†å²
        function renderChatHistory(moduleType, emissionType) {
            const history = window.aiChatHistory[moduleType] || [];
            const relevantHistory = history.filter(item => item.emissionType === emissionType);
            
            if (relevantHistory.length === 0) {
                return '<p class="no-history">æš‚æ— å¯¹è¯è®°å½•ï¼Œå¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è¯¢é—®å§ï¼</p>';
            }
            
            return relevantHistory.map(item => `
                <div class="history-item">
                    <div class="history-question">
                        <i class="fas fa-user"></i> <strong>é—®ï¼š</strong>${item.question}
                    </div>
                    <div class="history-answer">
                        <i class="fas fa-robot"></i> <strong>ç­”ï¼š</strong>${item.answer}
                    </div>
                    <div class="history-time">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // ä¿å­˜AIå¯¹è¯è®°å½•
        function saveAIChatHistory(moduleType, emissionType, question, answer) {
            if (!window.aiChatHistory[moduleType]) {
                window.aiChatHistory[moduleType] = [];
            }
            
            window.aiChatHistory[moduleType].push({
                emissionType: emissionType,
                question: question,
                answer: answer,
                timestamp: new Date().toLocaleString()
            });
        }

        // æ›´æ–°å¯¹è¯å†å²æ˜¾ç¤º
        function updateChatHistoryDisplay(moduleType, emissionType) {
            const historyMessages = document.getElementById('historyMessages');
            if (historyMessages) {
                historyMessages.innerHTML = renderChatHistory(moduleType, emissionType);
            }
        }

        // ç»§ç»­å¯¹è¯åŠŸèƒ½
        function continueConversation() {
            const aiQuestion = document.getElementById('aiQuestion');
            const aiResponse = document.getElementById('aiResponse');
            if (aiQuestion) {
                aiQuestion.value = '';
                aiQuestion.focus();
            }
            if (aiResponse) {
                aiResponse.style.display = 'none';
            }
        }

        console.log('ç¢³æ’æ”¾ç®¡ç†ç³»ç»Ÿæ”¹è¿›åŠŸèƒ½å·²åŠ è½½');

        // ==================== Scrumæ¨¡å—åŠŸèƒ½ ====================
        
        // Scrumä»»åŠ¡æ•°æ®
        window.scrumTasks = {
            todo: [
                {
                    id: 'task-1',
                    title: 'å®æ–½ç»¿è‰²ä¾›åº”å•†ç­›é€‰',
                    description: 'å»ºç«‹ä¾›åº”å•†ç¯ä¿è¯„ä¼°æ ‡å‡†ï¼Œä¼˜å…ˆé€‰æ‹©ä½ç¢³æ’æ”¾çš„ä¾›åº”å•†',
                    assignee: 'å¼ æ˜',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: '2024-03-01',
                    endDate: '2024-03-05',
                    tags: ['é‡‡è´­ä¼˜åŒ–', 'ä¾›åº”é“¾']
                },
                {
                    id: 'task-2',
                    title: 'ä¼˜åŒ–ç‰©æµè¿è¾“è·¯çº¿',
                    description: 'é‡æ–°è§„åˆ’è¿è¾“è·¯çº¿ï¼Œå‡å°‘è¿è¾“è·ç¦»å’Œç¢³æ’æ”¾',
                    assignee: 'æå',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: '2024-03-02',
                    endDate: '2024-03-04',
                    tags: ['ç‰©æµä¼˜åŒ–']
                },
                {
                    id: 'task-3',
                    title: 'å¯¼å…¥ç”Ÿç‰©åŸºææ–™',
                    description: 'é‡‡ç”¨ç”Ÿç‰©é™è§£ææ–™æ›¿ä»£ä¼ ç»Ÿææ–™ï¼Œå‡å°‘ç¯å¢ƒå½±å“',
                    assignee: 'ç‹èŠ³',
                    priority: 'high',
                    storyPoints: 13,
                    startDate: '2024-03-03',
                    endDate: '2024-03-10',
                    tags: ['ææ–™é€‰æ‹©', 'ç¯ä¿']
                },
                {
                    id: 'task-4',
                    title: 'å»ºç«‹ä½™çƒ­å›æ”¶ç³»ç»Ÿ',
                    description: 'å®‰è£…ä½™çƒ­å›æ”¶è®¾å¤‡ï¼Œæé«˜èƒ½æºåˆ©ç”¨æ•ˆç‡',
                    assignee: 'é™ˆå¼º',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: '2024-03-06',
                    endDate: '2024-03-12',
                    tags: ['èƒ½æºä¼˜åŒ–']
                }
            ],
            'in-progress': [
                {
                    id: 'task-5',
                    title: 'æ¸…æ´èƒ½æºè½¬æ¢',
                    description: 'å°†ç”Ÿäº§çº¿æ”¹ä¸ºä½¿ç”¨å¤ªé˜³èƒ½å’Œé£èƒ½',
                    assignee: 'åˆ˜æ´‹',
                    priority: 'high',
                    storyPoints: 21,
                    startDate: '2024-02-26',
                    endDate: '2024-03-08',
                    progress: 60,
                    tags: ['æ¸…æ´èƒ½æº']
                },
                {
                    id: 'task-6',
                    title: 'ç²¾ç›Šç”Ÿäº§æµç¨‹æ”¹è¿›',
                    description: 'æ¶ˆé™¤ç”Ÿäº§æµªè´¹ï¼Œä¼˜åŒ–å·¥è‰ºæµç¨‹',
                    assignee: 'èµµæ•',
                    priority: 'medium',
                    storyPoints: 13,
                    startDate: '2024-02-28',
                    endDate: '2024-03-06',
                    progress: 80,
                    tags: ['ç”Ÿäº§ä¼˜åŒ–']
                },
                {
                    id: 'task-7',
                    title: 'æ™ºèƒ½ç›‘æ§ç³»ç»Ÿé›†æˆ',
                    description: 'éƒ¨ç½²IoTä¼ æ„Ÿå™¨å®ç°å®æ—¶ç›‘æ§',
                    assignee: 'å­™æ°',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: '2024-03-01',
                    endDate: '2024-03-05',
                    progress: 40,
                    tags: ['æ™ºèƒ½åŒ–']
                }
            ],
            done: [
                {
                    id: 'task-8',
                    title: 'ç¯ä¿åŒ…è£…ææ–™é‡‡è´­',
                    description: 'é‡‡è´­å¯å›æ”¶åŒ…è£…ææ–™ï¼Œå»ºç«‹åŒ…è£…å›æ”¶ä½“ç³»',
                    assignee: 'å‘¨ç³',
                    priority: 'low',
                    storyPoints: 5,
                    startDate: '2024-02-20',
                    endDate: '2024-02-25',
                    completedDate: '2024-02-25',
                    tags: ['åŒ…è£…ä¼˜åŒ–']
                },
                {
                    id: 'task-9',
                    title: 'å›¢é˜Ÿç¯ä¿åŸ¹è®­',
                    description: 'å¯¹å…¨ä½“å‘˜å·¥è¿›è¡Œç¢³æ’æ”¾ç®¡ç†åŸ¹è®­',
                    assignee: 'å´ç¼',
                    priority: 'medium',
                    storyPoints: 3,
                    startDate: '2024-02-15',
                    endDate: '2024-02-18',
                    completedDate: '2024-02-18',
                    tags: ['åŸ¹è®­']
                },
                {
                    id: 'task-10',
                    title: 'ç¢³æ’æ”¾åŸºçº¿æµ‹é‡',
                    description: 'å»ºç«‹äº§å“ç¢³æ’æ”¾åŸºçº¿æ•°æ®',
                    assignee: 'é©¬å¼º',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: '2024-02-10',
                    endDate: '2024-02-15',
                    completedDate: '2024-02-15',
                    tags: ['æ•°æ®æ”¶é›†']
                },
                {
                    id: 'task-11',
                    title: 'ä¾›åº”å•†è¯„ä¼°æ ‡å‡†åˆ¶å®š',
                    description: 'åˆ¶å®šç¯ä¿ä¾›åº”å•†è¯„ä¼°æ ‡å‡†å’Œæµç¨‹',
                    assignee: 'é»„ä¸½',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: '2024-02-12',
                    endDate: '2024-02-16',
                    completedDate: '2024-02-16',
                    tags: ['æ ‡å‡†åˆ¶å®š']
                },
                {
                    id: 'task-12',
                    title: 'ç¯ä¿è®¤è¯ç”³è¯·',
                    description: 'ç”³è¯·ISO 14001ç¯å¢ƒç®¡ç†ä½“ç³»è®¤è¯',
                    assignee: 'æ—å³°',
                    priority: 'low',
                    storyPoints: 3,
                    startDate: '2024-02-08',
                    endDate: '2024-02-12',
                    completedDate: '2024-02-12',
                    tags: ['è®¤è¯']
                }
            ],
            __auto: false,          // æ ‡è®°ä¸ºéè‡ªåŠ¨ç”Ÿæˆï¼ˆé¢„è®¾æ•°æ®ï¼‰
            __aiGenerated: false    // æ ‡è®°ä¸ºéAIç”Ÿæˆ
        };

        // å›¢é˜Ÿæˆå‘˜æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼Œä»…ç”¨äºå¤´åƒæ˜¾ç¤ºï¼‰
        window.teamMembers = [
            { name: 'å¼ æ˜', avatar: 'ğŸ‘¨â€ğŸ’¼' },
            { name: 'æå', avatar: 'ğŸš›' },
            { name: 'ç‹èŠ³', avatar: 'ğŸ‘©â€ğŸ”¬' },
            { name: 'é™ˆå¼º', avatar: 'ğŸ”§' },
            { name: 'åˆ˜æ´‹', avatar: 'âš¡' },
            { name: 'èµµæ•', avatar: 'ğŸ‘©â€ğŸ­' },
            { name: 'å­™æ°', avatar: 'ğŸ’»' },
            { name: 'å‘¨ç³', avatar: 'ğŸ“¦' },
            { name: 'å´ç¼', avatar: 'ğŸ‘©â€ğŸ«' },
            { name: 'é©¬å¼º', avatar: 'ğŸ“Š' },
            { name: 'é»„ä¸½', avatar: 'ğŸ“‹' },
            { name: 'æ—å³°', avatar: 'ğŸ¯' }
        ];

        // [ADDED] æ ¹æ®ä¸Šä¸‹æ–‡è‡ªåŠ¨ç”ŸæˆScrumä»»åŠ¡è®¡åˆ’ï¼ˆAIä¼˜å…ˆï¼Œå¤±è´¥æ—¶ä½¿ç”¨è§„åˆ™å›é€€ï¼‰
        window.ensureScrumPlanReady = async function() {
            try {
                // å·²ç”Ÿæˆä¸”æ— éœ€åˆ·æ–°åˆ™è·³è¿‡ï¼ˆåªæœ‰AIç”Ÿæˆçš„ä»»åŠ¡æ‰è·³è¿‡ï¼‰
                if (window.scrumTasks && window.scrumTasks.__auto === true && window.scrumTasks.__aiGenerated === true && !window.__scrumNeedsRefresh) {
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½å ä½
                const kanbanContainer = document.getElementById('kanban-view');
                if (kanbanContainer) {
                    kanbanContainer.querySelectorAll('.task-list').forEach(list => list.innerHTML = '<div class="loading-suggestions" style="padding:20px 10px;">\n                        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŸºäºæ–‡æ¡£ä¸åˆ†æç»“æœè‡ªåŠ¨ç”ŸæˆSprintä»»åŠ¡...\n                    </div>');
                }

                await window.generateScrumPlanFromContext();
                window.__scrumNeedsRefresh = false;
            } catch (e) {
                console.error('ç”ŸæˆScrumè®¡åˆ’å¤±è´¥:', e);
            }
        };

        window.generateScrumPlanFromContext = async function() {
            console.log('ğŸš€ =================== Scrum AI ä»»åŠ¡è®¡åˆ’ç”Ÿæˆå¼€å§‹ ===================');
            
            // æ±‡æ€»ä¸Šä¸‹æ–‡
            const rawDocContent = (window.documentAIContent && window.documentAIContent.content) ? window.documentAIContent.content.slice(0, 2000) : '';
            // æ¸…ç†æ–‡æ¡£å†…å®¹ä¸­çš„å¤šä½™æ¢è¡Œç¬¦å’Œç©ºç™½å­—ç¬¦
            const docContent = rawDocContent
                .replace(/\n{3,}/g, '\n\n')  // å°†3ä¸ªä»¥ä¸Šè¿ç»­æ¢è¡Œæ›¿æ¢ä¸º2ä¸ª
                .replace(/[ \t]+\n/g, '\n')   // åˆ é™¤è¡Œå°¾ç©ºç™½
                .replace(/\n[ \t]+/g, '\n')   // åˆ é™¤è¡Œé¦–ç©ºç™½
                .replace(/[ \t]{2,}/g, ' ')   // å°†å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
                .trim();
            
            const supplementData = window.supplementData || {};
            const productType = window.currentAnalysis?.documentType || 'general';
            const productTypeName = (typeof getDocumentTypeName === 'function') ? getDocumentTypeName(productType) : productType;
            const analysis = window.analysisData || {};
            const accepted = Array.isArray(window.acceptedSuggestions) ? window.acceptedSuggestions : [];
            const acceptedByArea = window.acceptedSuggestionsByArea || {};

            // å°†ç¼“å­˜å»ºè®®æ‹å¹³ä»¥ä¾¿åœ¨æç¤ºä¸­å¼•ç”¨
            const cachedAreas = Object.keys(window.lastSuggestionsCache || {});
            const cachedSuggestions = cachedAreas.reduce((acc, area) => {
                const items = (window.lastSuggestionsCache[area] || []).map(s => ({ area, title: s.title, desc: s.desc }));
                return acc.concat(items);
            }, []);

            // æ‰“å°æ”¶é›†åˆ°çš„ä¸Šä¸‹æ–‡æ•°æ®
            console.log('ğŸ“‹ æ”¶é›†çš„ä¸Šä¸‹æ–‡æ•°æ®:');
            console.log('  ğŸ“„ æ–‡æ¡£å†…å®¹é•¿åº¦:', docContent.length);
            console.log('  ğŸ·ï¸ äº§å“ç±»å‹:', productTypeName);
            console.log('  ğŸ“Š åˆ†ææ•°æ®:', analysis);
            console.log('  âœ… å·²é‡‡çº³å»ºè®®:', accepted);
            console.log('  ğŸ¯ æŒ‰é¢†åŸŸåˆ†ç»„çš„å»ºè®®:', acceptedByArea);
            console.log('  ğŸ’¡ ç¼“å­˜å»ºè®®æ•°é‡:', cachedSuggestions.length);
            console.log('  ğŸ“ è¡¥å……ä¿¡æ¯:', supplementData);

            // æ„é€ æç¤ºè¯
            const prompt = `ä½ æ˜¯æ•æ·é¡¹ç›®ç»ç†ã€‚è¯·åŸºäºä»¥ä¸‹çœŸå®ä¸Šä¸‹æ–‡ï¼Œä¸ºå½“å‰äº§å“ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œçš„Sprintä»»åŠ¡è®¡åˆ’ï¼ˆJSONï¼‰ã€‚\n\n` +
            `ã€äº§å“ç±»å‹ã€‘${productTypeName}\n` +
            `ã€æ–‡æ¡£æ‘˜è¦ã€‘${docContent}\n` +
            `ã€è¡¥å……ä¿¡æ¯ã€‘${JSON.stringify(supplementData)}\n` +
            `ã€å½“å‰åˆ†ææ•°æ®-ç¢³æ’ã€‘${JSON.stringify(analysis.emissions || {})}\n` +
            `ã€å½“å‰åˆ†ææ•°æ®-æ—¶é—´ã€‘${JSON.stringify(analysis.timeline || {})}\n` +
            `ã€å·²é‡‡çº³å»ºè®®ã€‘${JSON.stringify(accepted)}\n` +
            `ã€å»ºè®®ç¼“å­˜æ‘˜è¦ã€‘${JSON.stringify(cachedSuggestions).slice(0, 2000)}\n\n` +
            `è¯·è¾“å‡ºä¸¥æ ¼JSONæ ¼å¼çš„ä¸­æ–‡ä»»åŠ¡è®¡åˆ’ï¼š{\n  "sprint": {"name": "Sprint 1", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"},\n  "tasks": [\n    {"title":"ä¸­æ–‡ä»»åŠ¡åç§°","desc":"ä¸­æ–‡ä»»åŠ¡æè¿°","assignee":"(å¯ä¸ºç©º)","priority":"high|medium|low","storyPoints":8,"startDate":"YYYY-MM-DD","endDate":"YYYY-MM-DD","status":"todo|in-progress|done","tags":["ææ–™é€‰æ‹©"],"relatedSuggestion":"(è‹¥æœ‰)"}\n  ]\n}\n` +
            `è¦æ±‚ï¼š\n1) æ‰€æœ‰ä»»åŠ¡æ ‡é¢˜(title)å’Œæè¿°(desc)å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼›\n2) ä»»åŠ¡éœ€å¯æ‰§è¡Œï¼Œè¦†ç›–å…³é”®å·²é‡‡çº³å»ºè®®æˆ–é«˜å½±å“æ¿å—ï¼›\n3) æ‰€æœ‰æ—¶é—´ä»¥æ—¥ä¸ºæœ€å°å•ä½ï¼Œä»»åŠ¡æŒç»­æ—¶é—´1-30å¤©ï¼›\n4) startDateå’ŒendDateå¿…é¡»æ˜¯æœ‰æ•ˆçš„YYYY-MM-DDæ ¼å¼æ—¥æœŸï¼›\n5) ä¾‹å¦‚ï¼š3å¤©ä»»åŠ¡ä»ä»Šå¤©å¼€å§‹ï¼ŒæŒç»­åˆ°ç¬¬3å¤©ï¼›7å¤©ä»»åŠ¡ä»å¼€å§‹æ—¥æœŸæŒç»­åˆ°ç¬¬7å¤©ï¼›\n6) å¦‚æ— æ˜ç¡®è´Ÿè´£äººï¼Œassigneeç•™ç©ºï¼›\n7) ä¸¥æ ¼è¿”å›JSONï¼Œä¸è¦å¤šä½™æ–‡æœ¬ï¼Œä¸è¦è‹±æ–‡ä»»åŠ¡åç§°ã€‚`;

            // æ‰“å°å®Œæ•´çš„AIè¾“å…¥
            console.log('ğŸ¤– AIè¾“å…¥æç¤ºè¯:');
            console.log('â”'.repeat(80));
            console.log(prompt);
            console.log('â”'.repeat(80));

            // æ„å»ºè¯·æ±‚å‚æ•°
            const requestData = {
                model: 'deepseek-ai/DeepSeek-V3',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 1200,
                temperature: 0.5
            };

            console.log('ğŸ“¤ AI API è¯·æ±‚å‚æ•°:');
            console.log('  ğŸ”— URL: https://api-inference.modelscope.cn/v1/chat/completions');
            console.log('  ğŸ“¦ è¯·æ±‚ä½“:', JSON.stringify(requestData, null, 2));

            let plan;
            try {
                console.log('â³ æ­£åœ¨è°ƒç”¨AI API...');
                const startTime = Date.now();
                
                const res = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify(requestData)
                });

                const responseTime = Date.now() - startTime;
                console.log(`âš¡ AI API å“åº”æ—¶é—´: ${responseTime}ms`);
                console.log('ğŸ“¥ AI API å“åº”çŠ¶æ€:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('âŒ AI API é”™è¯¯å“åº”:', errorText);
                    throw new Error(`AI APIå¤±è´¥: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('ğŸ“¥ AI API å®Œæ•´å“åº”æ•°æ®:');
                console.log(JSON.stringify(data, null, 2));

                const content = data.choices?.[0]?.message?.content || '';
                console.log('ğŸ” AI è¿”å›çš„å†…å®¹:');
                console.log('â”'.repeat(80));
                console.log(content);
                console.log('â”'.repeat(80));

                // æå–JSONéƒ¨åˆ†
                const match = content.match(/\{[\s\S]*\}/);
                if (match) {
                    const jsonString = match[0];
                    console.log('ğŸ”„ æå–çš„JSONå­—ç¬¦ä¸²:');
                    console.log(jsonString);
                    
                    try {
                        plan = JSON.parse(jsonString);
                        console.log('âœ… JSONè§£ææˆåŠŸï¼');
                        console.log('ğŸ“‹ è§£æåçš„è®¡åˆ’æ•°æ®:');
                        console.log(JSON.stringify(plan, null, 2));
                    } catch (parseError) {
                        console.error('âŒ JSONè§£æå¤±è´¥:', parseError);
                        console.error('ğŸ”¤ åŸå§‹JSONå­—ç¬¦ä¸²:', jsonString);
                        throw new Error('AIè¿”å›çš„JSONæ ¼å¼é”™è¯¯');
                    }
                } else {
                    console.error('âŒ æœªåœ¨AIå“åº”ä¸­æ‰¾åˆ°JSONæ ¼å¼æ•°æ®');
                    console.error('ğŸ“„ AIå®Œæ•´å“åº”:', content);
                    throw new Error('AIè¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼ŒæœªåŒ…å«JSONæ•°æ®');
                }

            } catch (e) {
                console.error('âŒ AIè°ƒç”¨å¤±è´¥:', e);
                console.warn('ğŸ”„ ä½¿ç”¨è§„åˆ™å›é€€ç”ŸæˆScrumè®¡åˆ’');
                plan = buildScrumPlanFallback(acceptedByArea, analysis);
                console.log('ğŸ› ï¸ å›é€€ç”Ÿæˆçš„è®¡åˆ’:', plan);
            }

            // åˆ†æAIè¿”å›çš„è®¡åˆ’æ•°æ®
            console.log('ğŸ” =================== AIè¿”å›æ•°æ®åˆ†æ ===================');
            console.log('ğŸ“‹ ç”Ÿæˆçš„è®¡åˆ’æ•°æ®:', plan);
            console.log('ğŸ“Š è®¡åˆ’æ•°æ®ç±»å‹:', typeof plan);
            console.log('ğŸ“ è®¡åˆ’åŒ…å«çš„ä»»åŠ¡:', plan?.tasks);
            console.log('ğŸ¯ Sprintä¿¡æ¯:', plan?.sprint);

            // æ˜ å°„åˆ°æœ¬åœ°ç»“æ„
            const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
            const tasks = Array.isArray(plan?.tasks) ? plan.tasks : [];
            
            console.log('ğŸ”„ =================== ä»»åŠ¡æ•°æ®å¤„ç† ===================');
            console.log('ğŸ“¦ æå–çš„ä»»åŠ¡æ•°ç»„:', tasks);
            console.log('ğŸ”¢ ä»»åŠ¡æ•°ç»„é•¿åº¦:', tasks.length);
            
            // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œè®°å½•è¯¦ç»†ä¿¡æ¯
            if (tasks.length === 0) {
                console.warn('âš ï¸ è­¦å‘Šï¼šAIæœªè¿”å›ä»»ä½•ä»»åŠ¡æ•°æ®');
                console.log('ğŸ” åŸå§‹è®¡åˆ’å¯¹è±¡:', JSON.stringify(plan, null, 2));
            }

            const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
            const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';

            tasks.forEach((t, idx) => {
                console.log(`ğŸ“‹ å¤„ç†ä»»åŠ¡ ${idx + 1}:`, t);
                
                const task = {
                    id: `ai-${Date.now()}-${idx}`,
                    title: t.title || `ä»»åŠ¡${idx+1}`,
                    description: t.desc || '',
                    assignee: t.assignee || (window.teamMembers?.[idx % (window.teamMembers.length||1)]?.name || ''),
                    priority: normalizePriority(t.priority),
                    storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                    startDate: t.startDate || new Date().toISOString().slice(0,10),
                    endDate: t.endDate || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                    tags: Array.isArray(t.tags) ? t.tags : [],
                    progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                };
                
                const normalizedStatus = normalizeStatus(t.status);
                console.log(`âœ… æ ‡å‡†åŒ–ä»»åŠ¡ ${idx + 1}:`, task);
                console.log(`ğŸ“Œ åˆ†é…åˆ°çŠ¶æ€: ${normalizedStatus}`);
                
                buckets[normalizedStatus].push(task);
            });

            window.scrumTasks = Object.assign(buckets, { __auto: true, __aiGenerated: true });

            console.log('ğŸ¯ =================== æœ€ç»ˆä»»åŠ¡æ•°æ®ç»“æ„ ===================');
            console.log('ğŸ“Š å®Œæ•´çš„scrumTasksæ•°æ®ç»“æ„:', window.scrumTasks);
            
            // è¯¦ç»†åˆ†ææ¯ä¸ªçŠ¶æ€çš„ä»»åŠ¡
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const statusTasks = window.scrumTasks[status];
                    console.log(`ğŸ“‹ çŠ¶æ€"${status}"çš„ä»»åŠ¡è¯¦æƒ…:`);
                    console.log(`  ğŸ“Š ä»»åŠ¡æ•°é‡: ${statusTasks.length}`);
                    console.log(`  ğŸ“¦ æ•°æ®ç±»å‹: ${Array.isArray(statusTasks) ? 'Array' : typeof statusTasks}`);
                    console.log(`  ğŸ“ ä»»åŠ¡åˆ—è¡¨:`, statusTasks);
                    
                    // åˆ†ææ¯ä¸ªä»»åŠ¡çš„å…³é”®å±æ€§
                    statusTasks.forEach((task, idx) => {
                        console.log(`    ğŸ“‹ ä»»åŠ¡${idx + 1}: "${task.title}"`, {
                            id: task.id,
                            priority: task.priority,
                            storyPoints: task.storyPoints,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            assignee: task.assignee,
                            tags: task.tags
                        });
                    });
                }
            });

            // è®¡ç®—æ€»ä»»åŠ¡æ•°
            const totalTasks = Object.keys(window.scrumTasks)
                .filter(key => key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]))
                .reduce((sum, status) => sum + window.scrumTasks[status].length, 0);
            console.log(`ğŸ“Š ä»»åŠ¡ç»Ÿè®¡: æ€»è®¡ ${totalTasks} ä¸ªä»»åŠ¡`);
            
            // éªŒè¯æ•°æ®å®Œæ•´æ€§
            if (totalTasks === 0) {
                console.error('âŒ ä¸¥é‡é”™è¯¯ï¼šæ²¡æœ‰ç”Ÿæˆä»»ä½•æœ‰æ•ˆä»»åŠ¡ï¼');
            } else {
                console.log('âœ… ä»»åŠ¡æ•°æ®éªŒè¯é€šè¿‡');
            }

            // æ¸²æŸ“
            console.log('ğŸ¨ =================== å¼€å§‹æ¸²æŸ“ç”˜ç‰¹å›¾ ===================');
            console.log('â³ è°ƒç”¨renderGanttChart()å‡½æ•°...');
            renderGanttChart();
            console.log('ğŸ¯ =================== Scrum AI ä»»åŠ¡è®¡åˆ’ç”Ÿæˆå®Œæˆ ===================');
        };

        function buildScrumPlanFallback(acceptedByArea, analysis) {
            const tasks = [];
            const today = new Date();
            let dayOffset = 0;
            Object.keys(acceptedByArea || {}).forEach(area => {
                (acceptedByArea[area] || []).forEach((title, idx) => {
                    const start = new Date(today.getTime() + dayOffset*86400000);
                    const end = new Date(start.getTime() + (2 + (idx%3))*86400000);
                    tasks.push({
                        title: `${area} - æ‰§è¡Œã€Œ${title}ã€`,
                        desc: 'æ ¹æ®å·²é‡‡çº³å»ºè®®è½å®æ‰§è¡Œã€éªŒè¯ä¸å¤ç›˜',
                        priority: idx%2===0 ? 'high' : 'medium',
                        storyPoints: [3,5,8,13][idx%4],
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: idx%3===0 ? 'in-progress' : 'todo',
                        tags: [area]
                    });
                    dayOffset += 1;
                });
            });
            // è‹¥å°šæœªé‡‡çº³å»ºè®®ï¼ŒåŸºäºé«˜å€¼æ¿å—ç”ŸæˆåŸºæœ¬ä»»åŠ¡
            if (tasks.length === 0 && analysis?.emissions) {
                const sorted = Object.entries(analysis.emissions).sort((a,b)=> (b[1].value||0) - (a[1].value||0)).slice(0,3);
                sorted.forEach(([k,v],i)=>{
                    const start = new Date(today.getTime() + i*86400000);
                    const end = new Date(start.getTime() + 3*86400000);
                    tasks.push({
                        title: `é™ä½ã€Œ${k}ã€é˜¶æ®µæ’æ”¾`,
                        desc: 'åˆ¶å®šå¹¶æ‰§è¡Œé™ç¢³ä¸¾æªï¼Œè·Ÿè¸ªæŒ‡æ ‡',
                        priority: i===0?'high':'medium',
                        storyPoints: [8,5,3][i] || 5,
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: 'todo',
                        tags: ['é™ç¢³']
                    });
                });
            }
            return { sprint: {}, tasks };
        }

        // åˆ‡æ¢Scrumè§†å›¾
        window.switchScrumView = function(viewType) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
            
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.scrum-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­è§†å›¾
            const viewElement = document.getElementById(`${viewType}-view`);
            if (viewElement) {
                viewElement.style.display = 'block';
            }
            
            // æ ¹æ®è§†å›¾ç±»å‹æ¸²æŸ“ç›¸åº”å†…å®¹
            switch(viewType) {
                case 'kanban':
                    // å–æ¶ˆçœ‹æ¿æ¸²æŸ“ï¼Œä»…ä¿ç•™ç”˜ç‰¹å›¾
                    break;
                case 'gantt':
                    renderGanttChart();
                    break;
            }
        };

        // æ¸²æŸ“Kanbançœ‹æ¿
        window.renderKanbanBoard = function() {
            // æ£€æŸ¥æ•°æ®ç»“æ„
            if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                console.warn('scrumTasks æ•°æ®ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯');
                return;
            }
            
            Object.keys(window.scrumTasks).forEach(status => {
                // è·³è¿‡ç‰¹æ®Šæ ‡è®°
                if (status === '__auto') return;
                
                const taskList = document.getElementById(`${status === 'in-progress' ? 'in-progress' : status}-tasks`);
                if (!taskList) {
                    console.warn(`æ‰¾ä¸åˆ°çŠ¶æ€ä¸º ${status} çš„ä»»åŠ¡åˆ—è¡¨å®¹å™¨`);
                    return;
                }
                
                const tasks = window.scrumTasks[status];
                
                // ç¡®ä¿ tasks æ˜¯æ•°ç»„
                if (!Array.isArray(tasks)) {
                    console.warn(`çŠ¶æ€ ${status} çš„ä»»åŠ¡ä¸æ˜¯æ•°ç»„:`, tasks);
                    taskList.innerHTML = '<div class="no-tasks">æš‚æ— ä»»åŠ¡</div>';
                    return;
                }
                
                taskList.innerHTML = tasks.map(task => {
                    const priorityColor = {
                        high: '#dc3545',
                        medium: '#ffc107',
                        low: '#28a745'
                    };
                    
                    const progressBar = task.progress ? `
                        <div class="task-progress">
                            <div class="progress-bar-task">
                                <div class="progress-fill-task" style="width: ${task.progress}%"></div>
                            </div>
                            <span class="progress-text">${task.progress}%</span>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="task-card" data-task-id="${task.id}" draggable="true" 
                             ondragstart="handleTaskDragStart(event)" 
                             ondragend="handleTaskDragEnd(event)">
                            <div class="task-header">
                                <div class="task-priority" style="background-color: ${priorityColor[task.priority]}"></div>
                                <div class="task-points">${task.storyPoints} SP</div>
                            </div>
                            <h4 class="task-title">${task.title}</h4>
                            <p class="task-description">${task.description}</p>
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
                            </div>
                            ${progressBar}
                            <div class="task-footer">
                                <div class="task-assignee">
                                    <span class="assignee-avatar">${getTeamMemberAvatar(task.assignee)}</span>
                                    <span class="assignee-name">${task.assignee}</span>
                                </div>
                                <div class="task-dates">
                                    <small>${task.startDate} - ${task.endDate}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // æ›´æ–°ä»»åŠ¡è®¡æ•°
                const column = taskList.closest('.kanban-column');
                const countElement = column.querySelector('.task-count');
                countElement.textContent = tasks.length;
            });
            
            // è®¾ç½®æ‹–æ‹½åŒºåŸŸ
            setupKanbanDragAndDrop();
        };

        // è·å–å›¢é˜Ÿæˆå‘˜å¤´åƒ
        function getTeamMemberAvatar(memberName) {
            const member = window.teamMembers.find(m => m.name === memberName);
            return member ? member.avatar : 'ğŸ‘¤';
        }

        // è®¾ç½®Kanbanæ‹–æ‹½åŠŸèƒ½
        function setupKanbanDragAndDrop() {
            // ä¸ºæ¯ä¸ªåˆ—è®¾ç½®æ‹–æ‹½ç›®æ ‡
            document.querySelectorAll('.task-list').forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
            });
        }

        // æ‹–æ‹½å¼€å§‹
        window.handleTaskDragStart = function(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.taskId);
            event.target.classList.add('dragging');
        };

        // æ‹–æ‹½ç»“æŸ
        window.handleTaskDragEnd = function(event) {
            event.target.classList.remove('dragging');
        };

        // æ‹–æ‹½æ‚¬åœ
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        // æ”¾ç½®ä»»åŠ¡
        function handleDrop(event) {
            event.preventDefault();
            const taskId = event.dataTransfer.getData('text/plain');
            const targetStatus = event.currentTarget.id.replace('-tasks', '').replace('in-progress', 'in-progress');
            
            // ç§»åŠ¨ä»»åŠ¡åˆ°æ–°çŠ¶æ€
            moveTask(taskId, targetStatus);
            
            // é‡æ–°æ¸²æŸ“çœ‹æ¿
            // å–æ¶ˆçœ‹æ¿æ¸²æŸ“ï¼Œä»…ä¿ç•™ç”˜ç‰¹å›¾
            
            // ç§»é™¤æ‹–æ‹½æ ·å¼
            event.currentTarget.classList.remove('drag-over');
        }

        // ç§»åŠ¨ä»»åŠ¡
        function moveTask(taskId, newStatus) {
            let taskToMove = null;
            let fromStatus = null;
            
            // æ‰¾åˆ°ä»»åŠ¡å¹¶ä»åŸä½ç½®ç§»é™¤
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const taskIndex = window.scrumTasks[status].findIndex(task => task.id === taskId);
                    if (taskIndex !== -1) {
                        taskToMove = window.scrumTasks[status].splice(taskIndex, 1)[0];
                        fromStatus = status;
                    }
                }
            });
            
            // æ·»åŠ åˆ°æ–°ä½ç½®
            if (taskToMove) {
                // å¦‚æœç§»åŠ¨åˆ°å·²å®Œæˆï¼Œæ·»åŠ å®Œæˆæ—¥æœŸ
                if (newStatus === 'done' && !taskToMove.completedDate) {
                    taskToMove.completedDate = new Date().toISOString().split('T')[0];
                }
                
                if (Array.isArray(window.scrumTasks[newStatus])) {
                    window.scrumTasks[newStatus].push(taskToMove);
                } else {
                    console.error(`ç›®æ ‡çŠ¶æ€ ${newStatus} ä¸æ˜¯æ•°ç»„ï¼Œæ— æ³•ç§»åŠ¨ä»»åŠ¡`);
                    return;
                }
                
                // æ˜¾ç¤ºç§»åŠ¨æç¤º
                showTaskMoveNotification(taskToMove.title, fromStatus, newStatus);
            }
        }

        // æ˜¾ç¤ºä»»åŠ¡ç§»åŠ¨æç¤º
        function showTaskMoveNotification(taskTitle, fromStatus, toStatus) {
            const statusNames = {
                'todo': 'å¾…åŠäº‹é¡¹',
                'in-progress': 'è¿›è¡Œä¸­',
                'done': 'å·²å®Œæˆ'
            };
            
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'task-move-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                "${taskTitle}" å·²ä» ${statusNames[fromStatus]} ç§»åŠ¨åˆ° ${statusNames[toStatus]}
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => notification.classList.add('show'), 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // åˆå§‹åŒ–Scrumæ¨¡å—
        function initializeScrumModule() {
            // é»˜è®¤æ˜¾ç¤ºKanbanè§†å›¾
            // å–æ¶ˆçœ‹æ¿æ¸²æŸ“ï¼Œä»…ä¿ç•™ç”˜ç‰¹å›¾
            
            // åˆå§‹åŒ–ç”˜ç‰¹å›¾é»˜è®¤ä¸ºæ—¥è§†å›¾
            window.ganttConfig.currentZoom = 'day';
            
            console.log('Scrumæ¨¡å—åˆå§‹åŒ–å®Œæˆ');
        }



        // æ¸²æŸ“ç”˜ç‰¹å›¾
        window.renderGanttChart = function() {
            console.log('ğŸ“Š =================== ç”˜ç‰¹å›¾æ¸²æŸ“å¼€å§‹ ===================');
            
            try {
                const ganttChart = document.getElementById('ganttChart');
                if (!ganttChart) {
                    console.warn('âŒ æ‰¾ä¸åˆ°ç”˜ç‰¹å›¾å®¹å™¨å…ƒç´  #ganttChart');
                    return;
                }
                console.log('âœ… ç”˜ç‰¹å›¾å®¹å™¨å…ƒç´ æ‰¾åˆ°');
                // é¡µé¢æç¤ºï¼šæ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾
                try {
                    ganttChart.innerHTML = '<div style="padding: 16px; text-align:center; color:#555;">â³ æ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾...</div>';
                    if (window.addScrumProgress) {
                        window.addScrumProgress('æ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾...');
                    }
                } catch (e) {}
                
                // æ£€æŸ¥æ•°æ®
                console.log('ğŸ” æ£€æŸ¥Scrumä»»åŠ¡æ•°æ®...');
                console.log('ğŸ“¦ window.scrumTasks:', window.scrumTasks);
                console.log('ğŸ“Š æ•°æ®ç±»å‹:', typeof window.scrumTasks);
                
                if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                    console.warn('âŒ Scrumä»»åŠ¡æ•°æ®æ— æ•ˆæˆ–ä¸å­˜åœ¨');
                    ganttChart.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;">æš‚æ— ä»»åŠ¡æ•°æ®ï¼Œè¯·å…ˆç”ŸæˆScrumè®¡åˆ’</div>';
                    return;
                }
                console.log('âœ… Scrumä»»åŠ¡æ•°æ®æ£€æŸ¥é€šè¿‡');
                
                // è·å–æ‰€æœ‰ä»»åŠ¡
                console.log('ğŸ”„ =================== ä»»åŠ¡æ•°æ®æå– ===================');
                console.log('ğŸ“¦ åŸå§‹scrumTasksæ•°æ®:', window.scrumTasks);
                const allTasks = [];
                
                // å®‰å…¨åœ°æå–æ‰€æœ‰ä»»åŠ¡
                console.log('ğŸ” å¼€å§‹ä»å„çŠ¶æ€æå–ä»»åŠ¡...');
                Object.keys(window.scrumTasks).forEach(status => {
                    if (status !== '__auto' && status !== '__aiGenerated') {
                        console.log(`ğŸ“‹ æ£€æŸ¥çŠ¶æ€"${status}":`, window.scrumTasks[status]);
                        console.log(`  ğŸ“Š æ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(window.scrumTasks[status])}`);
                        console.log(`  ğŸ”¢ ä»»åŠ¡æ•°é‡: ${window.scrumTasks[status]?.length || 0}`);
                        
                        if (Array.isArray(window.scrumTasks[status])) {
                            const statusTasks = window.scrumTasks[status];
                            console.log(`  âœ… ä»"${status}"æå– ${statusTasks.length} ä¸ªä»»åŠ¡`);
                            statusTasks.forEach((task, idx) => {
                                console.log(`    ğŸ“ ä»»åŠ¡${idx + 1}:`, {
                                    id: task.id,
                                    title: task.title,
                                    startDate: task.startDate,
                                    endDate: task.endDate
                                });
                            });
                            allTasks.push(...statusTasks);
                        } else {
                            console.warn(`  âš ï¸ çŠ¶æ€"${status}"çš„æ•°æ®ä¸æ˜¯æ•°ç»„:`, window.scrumTasks[status]);
                        }
                    }
                });
                
                console.log('ğŸ“Š =================== ä»»åŠ¡æå–ç»“æœ ===================');
                console.log('ğŸ”¢ æå–çš„ä»»åŠ¡æ€»æ•°:', allTasks.length);
                console.log('ğŸ“‹ æ‰€æœ‰ä»»åŠ¡è¯¦æƒ…:', allTasks);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡
                if (allTasks.length === 0) {
                    console.warn('âŒ æ²¡æœ‰æå–åˆ°ä»»ä½•ä»»åŠ¡æ•°æ®');
                    console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
                    console.log('  - scrumTasks å¯¹è±¡:', window.scrumTasks);
                    console.log('  - scrumTasks é”®:', Object.keys(window.scrumTasks));
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>âŒ æš‚æ— ä»»åŠ¡</h3>
                            <p>è¯·å…ˆç”ŸæˆScrumä»»åŠ¡è®¡åˆ’</p>
                            <p style="color: #666; font-size: 12px;">è°ƒè¯•ï¼šæ£€æµ‹åˆ° scrumTasks å¯¹è±¡ï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆä»»åŠ¡</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('âœ… ä»»åŠ¡æ•°æ®æå–æˆåŠŸ');
                
                // éªŒè¯ä»»åŠ¡æ•°æ®æ ¼å¼
                console.log('ğŸ” =================== ä»»åŠ¡æ•°æ®éªŒè¯ ===================');
                console.log('ğŸ“Š å¼€å§‹éªŒè¯ä»»åŠ¡æ•°æ®æ ¼å¼...');
                
                const validTasks = allTasks.filter((task, idx) => {
                    const isValid = task && task.startDate && task.endDate && task.title;
                    console.log(`ğŸ“‹ ä»»åŠ¡${idx + 1} éªŒè¯:`, {
                        title: task?.title,
                        startDate: task?.startDate,
                        endDate: task?.endDate,
                        isValid: isValid
                    });
                    
                    if (!isValid) {
                        console.warn(`âš ï¸ ä»»åŠ¡${idx + 1} æ•°æ®ä¸å®Œæ•´:`, task);
                    }
                    
                    return isValid;
                });
                
                console.log('ğŸ“Š éªŒè¯ç»“æœ:');
                console.log(`  ğŸ”¢ åŸå§‹ä»»åŠ¡æ•°: ${allTasks.length}`);
                console.log(`  âœ… æœ‰æ•ˆä»»åŠ¡æ•°: ${validTasks.length}`);
                console.log(`  âŒ æ— æ•ˆä»»åŠ¡æ•°: ${allTasks.length - validTasks.length}`);
                
                if (validTasks.length === 0) {
                    console.error('âŒ æ‰€æœ‰ä»»åŠ¡æ•°æ®æ ¼å¼éƒ½ä¸æ­£ç¡®ï¼');
                    console.log('ğŸ” æ— æ•ˆä»»åŠ¡è¯¦æƒ…:');
                    allTasks.forEach((task, idx) => {
                        console.log(`  ä»»åŠ¡${idx + 1}:`, {
                            hasTask: !!task,
                            hasTitle: !!task?.title,
                            hasStartDate: !!task?.startDate,
                            hasEndDate: !!task?.endDate,
                            task: task
                        });
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>âŒ ä»»åŠ¡æ•°æ®æ ¼å¼é”™è¯¯</h3>
                            <p>æ£€æµ‹åˆ° ${allTasks.length} ä¸ªä»»åŠ¡ï¼Œä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®</p>
                            <p style="color: #666; font-size: 12px;">è¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('âœ… ä»»åŠ¡æ•°æ®éªŒè¯é€šè¿‡');
                
                // æŒ‰å¼€å§‹æ—¥æœŸæ’åº
                console.log('ğŸ”„ =================== ä»»åŠ¡æ’åºå’Œæ—¥æœŸè®¡ç®— ===================');
                console.log('ğŸ“… æŒ‰å¼€å§‹æ—¥æœŸæ’åºä»»åŠ¡...');
                
                validTasks.sort((a, b) => {
                    const dateA = new Date(a.startDate);
                    const dateB = new Date(b.startDate);
                    console.log(`ğŸ“‹ æ¯”è¾ƒä»»åŠ¡: "${a.title}" (${a.startDate}) vs "${b.title}" (${b.startDate})`);
                    return dateA - dateB;
                });
                
                console.log('âœ… ä»»åŠ¡æ’åºå®Œæˆ');
                console.log('ğŸ“‹ æ’åºåçš„ä»»åŠ¡é¡ºåº:');
                validTasks.forEach((task, idx) => {
                    console.log(`  ${idx + 1}. "${task.title}" (${task.startDate} ~ ${task.endDate})`);
                });
                
                // è®¡ç®—æ—¶é—´èŒƒå›´
                console.log('ğŸ“… è®¡ç®—ç”˜ç‰¹å›¾æ—¶é—´èŒƒå›´...');
                let minDate, maxDate;
                try {
                    const startDates = validTasks.map(task => {
                        const date = new Date(task.startDate);
                        console.log(`ğŸ“… è§£æå¼€å§‹æ—¥æœŸ: ${task.startDate} -> ${date} (æœ‰æ•ˆ: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    const endDates = validTasks.map(task => {
                        const date = new Date(task.endDate);
                        console.log(`ğŸ“… è§£æç»“æŸæ—¥æœŸ: ${task.endDate} -> ${date} (æœ‰æ•ˆ: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    console.log(`ğŸ“Š æœ‰æ•ˆå¼€å§‹æ—¥æœŸæ•°é‡: ${startDates.length}`);
                    console.log(`ğŸ“Š æœ‰æ•ˆç»“æŸæ—¥æœŸæ•°é‡: ${endDates.length}`);
                    
                    if (startDates.length === 0 || endDates.length === 0) {
                        throw new Error('æ— æœ‰æ•ˆæ—¥æœŸæ•°æ®');
                    }
                    
                    minDate = new Date(Math.min(...startDates));
                    maxDate = new Date(Math.max(...endDates));
                    
                    console.log(`ğŸ“… è®¡ç®—çš„æ—¶é—´èŒƒå›´: ${minDate} ~ ${maxDate}`);
                    console.log(`ğŸ“Š æ—¶é—´è·¨åº¦: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} å¤©`);
                    
                    // ç¡®ä¿æ—¥æœŸæœ‰æ•ˆ
                    if (isNaN(minDate) || isNaN(maxDate)) {
                        throw new Error('æ—¥æœŸè®¡ç®—å¤±è´¥');
                    }
                    
                    console.log('âœ… æ—¶é—´èŒƒå›´è®¡ç®—æˆåŠŸ');
                    
                } catch (dateError) {
                    console.error('âŒ æ—¥æœŸè®¡ç®—é”™è¯¯:', dateError);
                    console.log('ğŸ” æ—¥æœŸè®¡ç®—è°ƒè¯•ä¿¡æ¯:');
                    validTasks.forEach((task, idx) => {
                        console.log(`  ä»»åŠ¡${idx + 1}: ${task.title}`);
                        console.log(`    å¼€å§‹æ—¥æœŸ: ${task.startDate} -> ${new Date(task.startDate)}`);
                        console.log(`    ç»“æŸæ—¥æœŸ: ${task.endDate} -> ${new Date(task.endDate)}`);
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> æ—¥æœŸæ•°æ®é”™è¯¯</h3>
                            <p>ä»»åŠ¡çš„å¼€å§‹æˆ–ç»“æŸæ—¥æœŸæ ¼å¼ä¸æ­£ç¡®</p>
                            <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${dateError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // æ ¹æ®å½“å‰ç¼©æ”¾çº§åˆ«ç”Ÿæˆæ—¥æœŸåˆ—
                console.log('ğŸ“… =================== æ—¥æœŸåˆ—ç”Ÿæˆ ===================');
                let dateColumns;
                try {
                    const currentZoom = window.ganttConfig?.currentZoom || 'day';
                    console.log(`ğŸ” å½“å‰ç¼©æ”¾çº§åˆ«: ${currentZoom}`);
                    console.log(`ğŸ“… æ—¶é—´èŒƒå›´: ${minDate} åˆ° ${maxDate}`);
                    
                    console.log('â³ è°ƒç”¨generateDateColumnsWithZoom...');
                    dateColumns = generateDateColumnsWithZoom(minDate, maxDate, currentZoom);
                    
                    console.log('ğŸ“… ç”Ÿæˆçš„æ—¥æœŸåˆ—:');
                    console.log(`  ğŸ”¢ æ—¥æœŸåˆ—æ•°é‡: ${dateColumns?.length || 0}`);
                    console.log(`  ğŸ“Š æ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(dateColumns)}`);
                    console.log('  ğŸ“‹ æ—¥æœŸåˆ—è¯¦æƒ…:', dateColumns);
                    
                    // æ˜¾ç¤ºå‰å‡ ä¸ªæ—¥æœŸåˆ—çš„å†…å®¹
                    if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                        console.log('ğŸ“… å‰å‡ ä¸ªæ—¥æœŸåˆ—ç¤ºä¾‹:');
                        dateColumns.slice(0, 5).forEach((col, idx) => {
                            console.log(`  ${idx + 1}. ${col.displayText} (${col.type}) - ${col.fullDate}`);
                        });
                        if (dateColumns.length > 5) {
                            console.log(`  ... è¿˜æœ‰ ${dateColumns.length - 5} ä¸ªæ—¥æœŸåˆ—`);
                        }
                    }
                    
                    if (!Array.isArray(dateColumns) || dateColumns.length === 0) {
                        throw new Error('æ—¥æœŸåˆ—ç”Ÿæˆå¤±è´¥ - è¿”å›ç©ºæ•°ç»„æˆ–éæ•°ç»„');
                    }
                    
                    console.log('âœ… æ—¥æœŸåˆ—ç”ŸæˆæˆåŠŸ');
                    
                } catch (columnError) {
                    console.error('âŒ æ—¥æœŸåˆ—ç”Ÿæˆé”™è¯¯:', columnError);
                    console.log('ğŸ” æ—¥æœŸåˆ—ç”Ÿæˆè°ƒè¯•ä¿¡æ¯:');
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    console.log('  - currentZoom:', window.ganttConfig?.currentZoom);
                    console.log('  - ganttConfig:', window.ganttConfig);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> æ—¥æœŸåˆ—ç”Ÿæˆé”™è¯¯</h3>
                            <p>æ— æ³•ç”Ÿæˆç”˜ç‰¹å›¾æ—¶é—´è½´</p>
                            <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${columnError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // æ¸²æŸ“ç”˜ç‰¹å›¾
                console.log('ğŸ¨ =================== ç”˜ç‰¹å›¾HTMLæ¸²æŸ“ ===================');
                try {
                    console.log('ğŸ“‹ å¼€å§‹æ¸²æŸ“å„ä»»åŠ¡è¡Œ...');
                    console.log(`ğŸ”¢ éœ€è¦æ¸²æŸ“çš„ä»»åŠ¡æ•°: ${validTasks.length}`);
                    // è®¡ç®—æ¨ªå‘æ€»å®½åº¦ï¼Œä¿è¯å¯æ»šåŠ¨åŒºåŸŸå®Œæ•´æ¸²æŸ“
                    const zoomForWidth = (window.ganttConfig && window.ganttConfig.currentZoom) ? window.ganttConfig.currentZoom : 'day';
                    const baseColWidth = (zoomForWidth === 'week') ? 140 : 100;
                    const timelineWidthPx = Math.max(800, (dateColumns?.length || 0) * baseColWidth);
                    
                    const taskRows = validTasks.map((task, idx) => {
                        console.log(`ğŸ“‹ æ¸²æŸ“ä»»åŠ¡ ${idx + 1}: "${task.title}"`);
                        try {
                            const taskHtml = renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx);
                            console.log(`  âœ… ä»»åŠ¡ ${idx + 1} æ¸²æŸ“æˆåŠŸ`);
                            return taskHtml;
                        } catch (taskError) {
                            console.error(`  âŒ ä»»åŠ¡ ${idx + 1} æ¸²æŸ“é”™è¯¯:`, taskError, task);
                            return `
                                <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                                    <div class="task-info" style="padding: 15px;">
                                        <div style="color: #856404;">
                                            <strong>ä»»åŠ¡æ¸²æŸ“é”™è¯¯:</strong> ${task.title || 'æœªçŸ¥ä»»åŠ¡'}
                                            <br><small>${taskError.message}</small>
                                        </div>
                                    </div>
                                    <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                                        <small style="color: #856404;">æ¸²æŸ“å¤±è´¥</small>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    console.log('âœ… æ‰€æœ‰ä»»åŠ¡è¡Œæ¸²æŸ“å®Œæˆ');
                    console.log(`ğŸ“Š ç”Ÿæˆçš„HTMLè¡Œæ•°: ${taskRows.length}`);
                    
                    // ç”Ÿæˆæ—¥æœŸåˆ—æ ‡é¢˜HTML
                    console.log('ğŸ“… ç”Ÿæˆæ—¥æœŸåˆ—æ ‡é¢˜HTML...');
                    const dateHeaderHtml = dateColumns.map(dateInfo => `
                        <div class="date-column" style="width: ${baseColWidth}px;" title="${dateInfo.fullDate || dateInfo.displayText}">${dateInfo.displayText}</div>
                    `).join('');
                    console.log(`ğŸ“… æ—¥æœŸåˆ—æ ‡é¢˜HTMLé•¿åº¦: ${dateHeaderHtml.length} å­—ç¬¦`);
                    
                    // ç»„è£…å®Œæ•´çš„ç”˜ç‰¹å›¾HTML
                    console.log('ğŸ¨ ç»„è£…å®Œæ•´ç”˜ç‰¹å›¾HTML...');
                    const totalGridWidthPx = 300 + timelineWidthPx;
                    const ganttHtml = `
                        <div class="gantt-timeline">
                            <div class="gantt-tasks" style="width: ${totalGridWidthPx}px;">
                                <div class="gantt-header-row">
                                    <div class="task-info-header">ä»»åŠ¡ä¿¡æ¯</div>
                                    <div class="timeline-header" style="width: ${timelineWidthPx}px">
                                        ${dateHeaderHtml}
                                    </div>
                                </div>
                                ${taskRows.join('')}
                            </div>
                        </div>
                    `;
                    
                    console.log(`ğŸ¨ å®Œæ•´ç”˜ç‰¹å›¾HTMLé•¿åº¦: ${ganttHtml.length} å­—ç¬¦`);
                    console.log('â³ å°†HTMLæ’å…¥åˆ°DOMä¸­...');
                    
                    ganttChart.innerHTML = ganttHtml;
                    
                    console.log('âœ… ç”˜ç‰¹å›¾HTMLæ’å…¥æˆåŠŸ');
                    
                    // ä¿å­˜å½“å‰æ—¥æœŸèŒƒå›´
                    if (window.ganttConfig) {
                        window.ganttConfig.startDate = minDate;
                        window.ganttConfig.endDate = maxDate;
                        console.log('ğŸ’¾ ç”˜ç‰¹å›¾é…ç½®å·²æ›´æ–°:', window.ganttConfig);
                    }
                    
                    console.log('ğŸ¯ =================== ç”˜ç‰¹å›¾æ¸²æŸ“å®Œæˆ ===================');
                    console.log(`âœ… ç”˜ç‰¹å›¾æ¸²æŸ“æˆåŠŸï¼`);
                    console.log(`  ğŸ“Š ä»»åŠ¡æ•°: ${validTasks.length}`);
                    console.log(`  ğŸ“… æ—¥æœŸåˆ—æ•°: ${dateColumns.length}`);
                    console.log(`  ğŸ“ˆ æ—¶é—´è·¨åº¦: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} å¤©`);
                    console.log(`  ğŸ” ç¼©æ”¾çº§åˆ«: ${window.ganttConfig?.currentZoom || 'day'}`);
                    
                } catch (renderError) {
                    console.error('âŒ ç”˜ç‰¹å›¾æ¸²æŸ“é”™è¯¯:', renderError);
                    console.log('ğŸ” æ¸²æŸ“é”™è¯¯è°ƒè¯•ä¿¡æ¯:');
                    console.log('  - validTasks:', validTasks);
                    console.log('  - dateColumns:', dateColumns);
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> ç”˜ç‰¹å›¾æ¸²æŸ“å¤±è´¥</h3>
                            <p>æ£€æµ‹åˆ° ${validTasks.length} ä¸ªæœ‰æ•ˆä»»åŠ¡ï¼Œä½†æ¸²æŸ“è¿‡ç¨‹å‡ºç°é”™è¯¯</p>
                            <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${renderError.message}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> é‡æ–°åŠ è½½é¡µé¢
                                </button>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ ç”˜ç‰¹å›¾æ•´ä½“æ¸²æŸ“å¤±è´¥:', error);
                console.log('ğŸ” æ•´ä½“æ¸²æŸ“å¤±è´¥è°ƒè¯•ä¿¡æ¯:');
                console.log('  - error.stack:', error.stack);
                console.log('  - window.scrumTasks:', window.scrumTasks);
                console.log('  - window.ganttConfig:', window.ganttConfig);
                
                const ganttChart = document.getElementById('ganttChart');
                if (ganttChart) {
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-times-circle" style="color: #721c24;"></i> ç”˜ç‰¹å›¾åŠ è½½å¤±è´¥</h3>
                            <p>ç”˜ç‰¹å›¾ç»„ä»¶é‡åˆ°ä¸¥é‡é”™è¯¯ï¼Œæ— æ³•æ­£å¸¸æ˜¾ç¤º</p>
                            <p style="color: #666; font-size: 14px;">æŠ€æœ¯é”™è¯¯: ${error.message || error}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> é‡æ–°åŠ è½½é¡µé¢
                                </button>
                                <button class="btn btn-secondary" onclick="console.log('Debug Info:', {scrumTasks: window.scrumTasks, ganttConfig: window.ganttConfig})" style="margin-left: 10px;">
                                    <i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // ç”Ÿæˆæ—¥æœŸåˆ—ï¼ˆåŸå§‹ç‰ˆæœ¬ï¼Œä¿æŒå‘åå…¼å®¹ï¼‰
        function generateDateColumns(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // æ ¹æ®ç¼©æ”¾çº§åˆ«ç”Ÿæˆæ—¥æœŸåˆ—
        function generateDateColumnsWithZoom(startDate, endDate, zoomLevel) {
            try {
                const dateColumns = [];
                
                // ç¡®ä¿è¾“å…¥å‚æ•°æœ‰æ•ˆ
                if (!startDate || !endDate || isNaN(startDate) || isNaN(endDate)) {
                    throw new Error('æ— æ•ˆçš„å¼€å§‹æˆ–ç»“æŸæ—¥æœŸ');
                }
                
                if (startDate > endDate) {
                    throw new Error('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                }
                
                // é˜²æ­¢æ— é™å¾ªç¯çš„å®‰å…¨æ£€æŸ¥
                const maxDays = 365; // æœ€å¤šä¸€å¹´çš„æ—¥æœŸèŒƒå›´
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > maxDays) {
                    throw new Error(`æ—¥æœŸèŒƒå›´è¿‡å¤§: ${daysDiff} å¤©ï¼Œæœ€å¤§æ”¯æŒ ${maxDays} å¤©`);
                }
                
                if (zoomLevel === 'day') {
                    // æ—¥è§†å›¾ï¼šæ˜¾ç¤ºæ¯ä¸€å¤©
                    const currentDate = new Date(startDate);
                    let loopCount = 0;
                    const maxLoops = 400; // é˜²æ­¢æ— é™å¾ªç¯
                    
                    while (currentDate <= endDate && loopCount < maxLoops) {
                        try {
                            dateColumns.push({
                                date: new Date(currentDate),
                                displayText: formatDateShort ? formatDateShort(currentDate) : `${currentDate.getMonth()+1}/${currentDate.getDate()}`,
                                fullDate: formatDateFull ? formatDateFull(currentDate) : currentDate.toDateString(),
                                type: 'day'
                            });
                            currentDate.setDate(currentDate.getDate() + 1);
                        } catch (e) {
                            console.error('æ—¥è§†å›¾æ—¥æœŸå¤„ç†é”™è¯¯:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxLoops) {
                        console.warn('æ—¥è§†å›¾æ—¥æœŸç”Ÿæˆå¾ªç¯æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜');
                    }
                    
                } else if (zoomLevel === 'week') {
                    // å‘¨è§†å›¾ï¼šä»â€œè®¡åˆ’ç¬¬ä¸€å¤©â€å¼€å§‹ï¼Œæ¯7å¤©ä¸ºä¸€åˆ—ï¼Œå¹¶åœ¨å°¾éƒ¨é¢å¤–æ‰©å±•è‹¥å¹²å‘¨
                    const firstDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const extraWeeksAfter = 2; // æœ«å°¾é¢å¤–å±•ç¤ºçš„å‘¨æ•°
                    const endWithPadding = new Date(endDate);
                    endWithPadding.setDate(endWithPadding.getDate() + (extraWeeksAfter * 7));
                    
                    let weekStart = new Date(firstDay);
                    let weekNumber = 1;
                    let loopCount = 0;
                    const maxWeeks = 60; // é˜²æ­¢æ— é™å¾ªç¯
                    
                    while (weekStart <= endWithPadding && loopCount < maxWeeks) {
                        try {
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            
                            const startText = formatDateShort ? formatDateShort(weekStart) : `${weekStart.getMonth()+1}/${weekStart.getDate()}`;
                            const endText = formatDateShort ? formatDateShort(weekEnd) : `${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;
                            
                            dateColumns.push({
                                date: new Date(weekStart),
                                displayText: `ç¬¬${weekNumber}å‘¨`,
                                fullDate: `${startText} - ${endText}`,
                                type: 'week',
                                weekStart: new Date(weekStart),
                                weekEnd: new Date(weekEnd)
                            });
                            
                            weekStart.setDate(weekStart.getDate() + 7);
                            weekNumber++;
                        } catch (e) {
                            console.error('å‘¨è§†å›¾æ—¥æœŸå¤„ç†é”™è¯¯:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxWeeks) {
                        console.warn('å‘¨è§†å›¾æ—¥æœŸç”Ÿæˆå¾ªç¯æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜');
                    }
                    
                } else if (zoomLevel === 'month') {
                    // æœˆè§†å›¾ï¼šæ˜¾ç¤ºæ¯ä¸€æœˆ
                    const currentDate = new Date(startDate);
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœˆçš„å¼€å§‹
                    const firstMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    
                    let monthStart = new Date(firstMonth);
                    let loopCount = 0;
                    const maxMonths = 24; // é˜²æ­¢æ— é™å¾ªç¯ï¼Œæœ€å¤š24ä¸ªæœˆ
                    
                    while (monthStart <= endDate && loopCount < maxMonths) {
                        try {
                            const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0); // æœˆæœ«æœ€åä¸€å¤©
                            
                            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                                              '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                            const monthName = monthNames[monthStart.getMonth()];
                            const year = monthStart.getFullYear();
                            
                            dateColumns.push({
                                date: new Date(monthStart),
                                displayText: `${year}å¹´${monthName}`,
                                fullDate: `${year}å¹´${monthName} (${monthStart.getMonth()+1}/1 - ${monthEnd.getMonth()+1}/${monthEnd.getDate()})`,
                                type: 'month',
                                monthStart: new Date(monthStart),
                                monthEnd: new Date(monthEnd)
                            });
                            
                            // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæœˆ
                            monthStart.setMonth(monthStart.getMonth() + 1);
                        } catch (e) {
                            console.error('æœˆè§†å›¾æ—¥æœŸå¤„ç†é”™è¯¯:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxMonths) {
                        console.warn('æœˆè§†å›¾æ—¥æœŸç”Ÿæˆå¾ªç¯æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜');
                    }
                } else {
                    // é»˜è®¤è¿”å›ç®€å•çš„æ—¥æœŸåˆ—
                    console.warn('æœªçŸ¥çš„ç¼©æ”¾çº§åˆ«:', zoomLevel, 'ä½¿ç”¨é»˜è®¤å¤„ç†');
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    const step = Math.max(1, Math.ceil(daysDiff / 20)); // æœ€å¤š20åˆ—
                    
                    for (let i = 0; i <= daysDiff; i += step) {
                        const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                        dateColumns.push({
                            date: date,
                            displayText: `${date.getMonth()+1}/${date.getDate()}`,
                            fullDate: date.toDateString(),
                            type: 'day'
                        });
                    }
                }
                
                if (dateColumns.length === 0) {
                    // ç¡®ä¿è‡³å°‘æœ‰ä¸€åˆ—
                    dateColumns.push({
                        date: new Date(startDate),
                        displayText: 'æ— æ•°æ®',
                        fullDate: 'æ— æœ‰æ•ˆæ—¥æœŸæ•°æ®',
                        type: 'day'
                    });
                }
                
                return dateColumns;
                
            } catch (error) {
                console.error('generateDateColumnsWithZoom é”™è¯¯:', error);
                // è¿”å›æœ€åŸºæœ¬çš„ç»“æ„ä»¥é¿å…å®Œå…¨å¤±è´¥
                return [{
                    date: new Date(),
                    displayText: 'é”™è¯¯',
                    fullDate: error.message || 'æ—¥æœŸç”Ÿæˆé”™è¯¯',
                    type: 'error'
                }];
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆçŸ­æ ¼å¼ï¼‰
        function formatDateShort(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆå®Œæ•´æ ¼å¼ï¼‰
        function formatDateFull(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekday = weekdays[date.getDay()];
            return `${year}-${month}-${day} ${weekday}`;
        }

        // æ¸²æŸ“ç”˜ç‰¹å›¾ä»»åŠ¡è¡Œï¼ˆå…¼å®¹æ€§å‡½æ•°ï¼Œé»˜è®¤æŒ‰å¤©è®¡ç®—ï¼‰
        function renderGanttTask(task, minDate, maxDate, totalDays) {
            const taskStartDate = new Date(task.startDate);
            const taskEndDate = new Date(task.endDate);
            
            // è®¡ç®—ä»»åŠ¡åœ¨æ—¶é—´è½´ä¸Šçš„ä½ç½®å’Œå®½åº¦ï¼ˆæŒ‰å¤©è®¡ç®—ï¼‰
            const startOffset = Math.floor((taskStartDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.floor((taskEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const statusColors = {
                'todo': '#6c757d',
                'in-progress': '#ffc107',
                'done': '#28a745'
            };
            
            // æ‰¾åˆ°ä»»åŠ¡çŠ¶æ€
            let taskStatus = 'todo';
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    if (window.scrumTasks[status].find(t => t.id === task.id)) {
                        taskStatus = status;
                    }
                }
            });
            
            const progressWidth = task.progress ? (task.progress / 100) * duration : 0;
            
            return `
                <div class="gantt-task-row">
                    <div class="task-info">
                        <div class="task-info-content">
                            <div class="task-title-gantt">${task.title}</div>
                            <div class="task-meta">
                                <span class="task-priority priority-${task.priority}">ä¼˜å…ˆçº§ï¼š${task.priority}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-content">
                        <div class="gantt-bar-container" style="position: relative;">
                            <div class="gantt-bar" 
                                 style="left: ${(startOffset / totalDays) * 100}%; 
                                        width: ${(duration / totalDays) * 100}%; 
                                        background-color: ${statusColors[taskStatus]};">
                                ${task.progress ? `
                                    <div class="gantt-progress" 
                                         style="width: ${task.progress}%; background-color: ${statusColors[taskStatus]}; opacity: 0.8;"></div>
                                ` : ''}
                                <span class="gantt-bar-text">${task.title}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ”¯æŒç¼©æ”¾çš„ç”˜ç‰¹å›¾ä»»åŠ¡æ¸²æŸ“
        function renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx) {
            try {
                // å‚æ•°éªŒè¯
                if (!task || !task.startDate || !task.endDate || !task.title) {
                    throw new Error('ä»»åŠ¡æ•°æ®ä¸å®Œæ•´');
                }
                
                if (!minDate || !maxDate || !Array.isArray(dateColumns)) {
                    throw new Error('æ—¥æœŸå‚æ•°æ— æ•ˆ');
                }
                
                if (!timelineWidthPx || isNaN(timelineWidthPx)) {
                    throw new Error('æ—¶é—´è½´å®½åº¦å‚æ•°æ— æ•ˆ');
                }
                
                const taskStartDate = new Date(task.startDate);
                const taskEndDate = new Date(task.endDate);
                const DAY_MS = 24 * 60 * 60 * 1000;
                const normalize = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const normMin = normalize(new Date(minDate));
                const normStart = normalize(taskStartDate);
                const normEnd = normalize(taskEndDate);
                
                // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(taskStartDate) || isNaN(taskEndDate)) {
                    throw new Error('ä»»åŠ¡æ—¥æœŸæ ¼å¼æ— æ•ˆ');
                }
                
                const statusColors = {
                    'todo': '#6c757d',
                    'in-progress': '#ffc107',
                    'done': '#28a745'
                };
                
                // æ‰¾åˆ°ä»»åŠ¡çŠ¶æ€
                let taskStatus = 'todo';
                try {
                    if (window.scrumTasks && typeof window.scrumTasks === 'object') {
                        Object.keys(window.scrumTasks).forEach(status => {
                            if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                                if (window.scrumTasks[status].find(t => t && t.id === task.id)) {
                                    taskStatus = status;
                                }
                            }
                        });
                    }
                } catch (statusError) {
                    console.warn('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', statusError);
                    // ä½¿ç”¨é»˜è®¤çŠ¶æ€
                }
                
                const zoomLevel = window.ganttConfig?.currentZoom || 'day';
                let startOffset, duration;
                
                try {
                    if (zoomLevel === 'day') {
                        // æ—¥è§†å›¾ï¼šæŒ‰å¤©è®¡ç®—ï¼ˆé›¶ç‚¹å¯¹é½ï¼Œé¿å…æ—¶åŒºåå·®ï¼‰
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    } else if (zoomLevel === 'week') {
                        // å‘¨è§†å›¾ï¼šä»¥â€œå¤©â€ä¸ºæœ€å°åˆ»åº¦è¿›è¡Œå®šä½å’Œå®½åº¦è®¡ç®—ï¼Œä½†è¡¨å¤´ä»ä»¥å‘¨åˆ—æ˜¾ç¤º
                        const DAY_MS = 24 * 60 * 60 * 1000;
                        const getAlignedMonday = (base) => {
                            const d = new Date(base);
                            const dow = d.getDay();
                            const daysToMonday = dow === 0 ? 6 : dow - 1;
                            d.setDate(d.getDate() - daysToMonday);
                            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                        };

                        // è¡¨å¤´çš„ç¬¬ä¸€åˆ—èµ·ç‚¹ï¼šç°åœ¨ä»â€œè®¡åˆ’ç¬¬ä¸€å¤©â€å¼€å§‹ï¼Œä¸å¼ºåˆ¶å¯¹é½å‘¨ä¸€
                        let baseStart;
                        if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                            const firstCol = dateColumns[0];
                            baseStart = new Date(firstCol.date || firstCol.weekStart || normMin);
                        } else {
                            baseStart = new Date(normMin);
                        }
                        baseStart = new Date(baseStart.getFullYear(), baseStart.getMonth(), baseStart.getDate());

                        const totalDaysAll = Math.max(1, (dateColumns.length || 1) * 7);
                        const leftDays = Math.max(0, Math.floor((normStart - baseStart) / DAY_MS));
                        const widthDays = Math.max(1, Math.floor((normEnd - normStart) / DAY_MS) + 1);

                        // å°†â€œå¤©â€æ˜ å°„ä¸ºç›¸å¯¹æ•´æ®µçš„ç™¾åˆ†æ¯”ï¼Œä»¥é¿å… 3å¤©/7å¤© è¢«æ”¾å¤§ä¸ºæ•´å‘¨
                        startOffset = leftDays; // ä»…ç”¨äºæ—¥å¿—ï¼Œä¸å†ç›´æ¥ç”¨äºç™¾åˆ†æ¯”
                        duration = widthDays;

                        // è¦†ç›–ä¸‹é¢çš„ç™¾åˆ†æ¯”è®¡ç®—ä½¿ç”¨ totalDaysAll
                        var __weekly_totalDaysAll = totalDaysAll;
                        var __weekly_leftDays = leftDays;
                        var __weekly_widthDays = widthDays;
                    } else {
                        // é»˜è®¤å¤„ç†ï¼šæŒ‰å¤©è®¡ç®—
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    }
                    
                    // ç¡®ä¿åç§»é‡å’ŒæŒç»­æ—¶é—´ä¸ºæœ‰æ•ˆå€¼
                    startOffset = Math.max(0, startOffset || 0);
                    duration = Math.max(1, duration || 1);
                    
                } catch (dateCalcError) {
                    console.warn('æ—¥æœŸè®¡ç®—å¤±è´¥:', dateCalcError);
                    startOffset = 0;
                    duration = 1;
                }
                
                const totalColumns = Math.max(1, dateColumns.length);
                const daysDuration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                
                // å®‰å…¨åœ°å¤„ç†å„ç§å±æ€§
                const safeTitle = (task.title || 'æœªå‘½åä»»åŠ¡').toString();
                const safeAssignee = (task.assignee || 'æœªåˆ†é…').toString();
                const safeStoryPoints = isNaN(task.storyPoints) ? 0 : Number(task.storyPoints);
                const safePriority = ['high', 'medium', 'low'].includes(task.priority) ? task.priority : 'medium';
                const safeProgress = (task.progress && !isNaN(task.progress)) ? Math.min(100, Math.max(0, Number(task.progress))) : null;
                
                // è®¡ç®—å®‰å…¨çš„ç™¾åˆ†æ¯”å€¼
                let leftPercent;
                let widthPercent;
                if (zoomLevel === 'week' && typeof __weekly_totalDaysAll !== 'undefined') {
                    // ä½¿ç”¨åŸºäºâ€œå¤©â€çš„æ˜ å°„æ¯”ä¾‹ï¼Œä¿è¯ 3å¤©/7å¤© ä¸ä¼šè¢«æ”¾å¤§ä¸ºæ•´å‘¨
                    leftPercent = Math.max(0, Math.min(100, (__weekly_leftDays / __weekly_totalDaysAll) * 100));
                    widthPercent = Math.max(1, Math.min(100, (__weekly_widthDays / __weekly_totalDaysAll) * 100));
                } else {
                    leftPercent = Math.max(0, Math.min(100, (startOffset / totalColumns) * 100));
                    widthPercent = Math.max(1, Math.min(100, (duration / totalColumns) * 100));
                }
                // é˜²æº¢å‡ºï¼šç¡®ä¿æ¡å½¢ä¸ä¼šè¶…å‡ºå®¹å™¨
                widthPercent = Math.min(widthPercent, 100 - leftPercent);
                
                return `
                    <div class="gantt-task-row" style="display:flex; align-items: stretch; gap: 8px; margin-bottom: 8px;">
                        <div class="task-info" style="flex: 0 0 300px; max-width: 300px;">
                            <div class="task-info-content" style="display:flex; flex-direction: column; gap:4px;">
                                <div class="task-title-gantt" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${safeTitle}</div>
                                <div class="task-meta" style="display:flex; gap:8px; flex-wrap: wrap;">
                                    <span class="task-priority priority-${safePriority}">ä¼˜å…ˆçº§ï¼š${safePriority}</span>
                                </div>
                                <div class="task-dates" style="font-size: 11px; color: #666;">
                                    ${task.startDate} ~ ${task.endDate} (${daysDuration}å¤©)
                                </div>
                            </div>
                        </div>
                        <div class="timeline-content" style="flex:1; width: ${timelineWidthPx}px;">
                            <div class="gantt-bar-container" style="position: relative; height: 28px;">
                                <div class="gantt-bar" 
                                     style="position: absolute; top:0; bottom:0; left: ${leftPercent}%; 
                                            width: ${widthPercent}%; 
                                            background-color: ${statusColors[taskStatus] || statusColors.todo}; border-radius: 4px;">
                                    ${safeProgress ? `
                                        <div class="gantt-progress" 
                                             style="height:100%; width: ${safeProgress}%; background-color: ${statusColors[taskStatus] || statusColors.todo}; opacity: 0.8; border-radius:4px;"></div>
                                    ` : ''}
                                    <span class="gantt-bar-text" style="position:absolute; left:8px; top:50%; transform: translateY(-50%); font-size:12px; color:#fff; white-space:nowrap;">${daysDuration}å¤©</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('renderGanttTaskWithZoom é”™è¯¯:', error, task);
                // è¿”å›é”™è¯¯æ˜¾ç¤ºçš„ä»»åŠ¡è¡Œ
                const errorTitle = task?.title || 'é”™è¯¯ä»»åŠ¡';
                return `
                    <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                        <div class="task-info" style="padding: 15px;">
                            <div style="color: #856404;">
                                <strong>ä»»åŠ¡æ¸²æŸ“é”™è¯¯:</strong> ${errorTitle}
                                <br><small>${error.message || error}</small>
                            </div>
                        </div>
                        <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                            <small style="color: #856404;">æ¸²æŸ“å¤±è´¥</small>
                        </div>
                    </div>
                `;
            }
        }

        // è®¡ç®—ä»»åŠ¡åœ¨å‘¨è§†å›¾ä¸­çš„å‘¨ç´¢å¼•
        function getWeekIndex(taskDate, startDate) {
            try {
                if (!taskDate || !startDate || isNaN(taskDate) || isNaN(startDate)) {
                    console.warn('getWeekIndex: æ— æ•ˆçš„æ—¥æœŸå‚æ•°', { taskDate, startDate });
                    return 0;
                }
                
                const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                const diffMs = taskDate - startDate;
                
                if (isNaN(diffMs)) {
                    console.warn('getWeekIndex: æ—¥æœŸå·®å¼‚è®¡ç®—å¤±è´¥');
                    return 0;
                }
                
                const weekIndex = Math.floor(diffMs / msPerWeek);
                
                // ç¡®ä¿è¿”å›éè´Ÿæ•°
                return Math.max(0, weekIndex);
                
            } catch (error) {
                console.error('getWeekIndex é”™è¯¯:', error);
                return 0;
            }
        }



        // ç”˜ç‰¹å›¾å…¨å±€é…ç½®
        window.ganttConfig = {
            currentZoom: 'day', // 'day' æˆ– 'week'
            startDate: null,
            endDate: null
        };

        // è°ƒæ•´ç”˜ç‰¹å›¾ç¼©æ”¾
        window.adjustGanttZoom = function(zoomLevel) {
            console.log('è°ƒæ•´ç”˜ç‰¹å›¾ç¼©æ”¾çº§åˆ«:', zoomLevel);
            window.ganttConfig.currentZoom = zoomLevel;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.gantt-controls .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            const activeBtn = document.querySelector(`[onclick="adjustGanttZoom('${zoomLevel}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
            
            // é‡æ–°æ¸²æŸ“ç”˜ç‰¹å›¾
            renderGanttChart();
        };



        // æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†
        window.showAddTaskModal = function(status) {
            console.log('æ˜¾ç¤ºæ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡†:', status);
            // è¿™é‡Œå¯ä»¥å®ç°æ·»åŠ ä»»åŠ¡çš„åŠŸèƒ½
            alert(`æ·»åŠ æ–°ä»»åŠ¡åˆ°"${status}"åˆ—çš„åŠŸèƒ½å¼€å‘ä¸­...`);
        };

        // è¿›å…¥Scrumæ‰§è¡Œï¼ˆä»…ç”˜ç‰¹å›¾ï¼‰ï¼šè°ƒç”¨AI/å›é€€ç”Ÿæˆè®¡åˆ’å¹¶æ˜¾ç¤ºç”˜ç‰¹å›¾
        window.goToScrumExecution = async function() {
            try {
                // æ§åˆ¶å°æ‰“å°ï¼ˆä¸å†åœ¨é¡µé¢è¾“å‡ºè¯¦ç»†è°ƒè¯•é¡¹ï¼‰
                const log = (msg, detail) => {
                    console.log('[Scrum]', `[${new Date().toLocaleTimeString()}]`, msg, detail || '');
                };

                // è½»é‡è¿›åº¦æç¤ºï¼ˆä»…æ˜¾ç¤ºå…³é”®æ­¥éª¤ï¼‰
                function ensureScrumProgressPanel() {
                    const container = document.querySelector('#gantt-view .gantt-container');
                    if (!container) return null;
                    let panel = document.getElementById('scrumProgressPanel');
                    if (!panel) {
                        panel = document.createElement('div');
                        panel.id = 'scrumProgressPanel';
                        panel.className = 'scrum-progress';
                        panel.style.margin = '8px 0';
                        panel.style.background = '#f8f9fa';
                        panel.style.border = '1px solid #e9ecef';
                        panel.style.borderRadius = '8px';
                        panel.style.padding = '8px 10px';
                        panel.style.fontSize = '12px';
                        panel.style.color = '#333';
                        const label = document.createElement('div');
                        label.className = 'scrum-progress-label';
                        label.textContent = 'ç”˜ç‰¹å›¾ç”Ÿæˆä¸­...';
                        panel.appendChild(label);
                        const ganttChartEl = document.getElementById('ganttChart');
                        container.insertBefore(panel, ganttChartEl || container.firstChild);
                    }
                    return panel;
                }

                function addScrumProgress(message) {
                    const panel = ensureScrumProgressPanel();
                    if (!panel) return;
                    const label = panel.querySelector('.scrum-progress-label');
                    if (label) {
                        // å¦‚æœæ˜¯ç”˜ç‰¹å›¾ç”Ÿæˆç›¸å…³çš„æ¶ˆæ¯ï¼Œæ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾"
                        if (message.includes('ç”˜ç‰¹å›¾') || message.includes('ensureScrumPlanReady') || message.includes('ç”Ÿæˆ')) {
                            label.textContent = 'æ­£åœ¨ç”Ÿæˆç”˜ç‰¹å›¾...';
                            panel.style.display = 'block';
                        } else {
                            label.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        }
                    }
                }

                function hideScrumProgressPanel() {
                    const panel = document.getElementById('scrumProgressPanel');
                    if (panel) {
                        panel.style.display = 'none';
                        // æ¸…ç©ºè¿›åº¦æ ‡ç­¾å†…å®¹
                        const label = panel.querySelector('.scrum-progress-label');
                        if (label) {
                            label.textContent = '';
                        }
                    }
                }

                log('å¼€å§‹è¿›å…¥Scrumæ‰§è¡Œ');
                addScrumProgress('å¼€å§‹è¿›å…¥Scrumæ‰§è¡Œ');
                
                // åˆå§‹åŒ–ç”˜ç‰¹å›¾é…ç½®ï¼ˆç¡®ä¿é…ç½®å­˜åœ¨ï¼‰
                if (!window.ganttConfig) {
                    window.ganttConfig = {
                        currentZoom: 'day',
                        startDate: null,
                        endDate: null
                    };
                    log('åˆå§‹åŒ–ç”˜ç‰¹å›¾é…ç½®');
                }
                
                // åˆ‡æ¢åˆ°Scrumæ¨¡å—
                if (typeof switchModule === 'function') {
                    log('è°ƒç”¨switchModule("scrum")');
                    addScrumProgress('è°ƒç”¨switchModule("scrum")');
                    switchModule('scrum');
                } else {
                    log('fallbackåˆ‡æ¢scrumæ¨¡å—');
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                }

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰AIç”Ÿæˆçš„ä»»åŠ¡æ•°æ®ï¼ˆæ’é™¤é¢„è®¾çš„é»˜è®¤æ•°æ®ï¼‰
                const hasAIGeneratedTasks = window.scrumTasks && window.scrumTasks.__auto && window.scrumTasks.__aiGenerated &&
                    Object.keys(window.scrumTasks).some(key => 
                        key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]) && window.scrumTasks[key].length > 0
                    );
                
                if (hasAIGeneratedTasks) {
                    log('æ£€æµ‹åˆ°å·²æœ‰AIç”Ÿæˆçš„ä»»åŠ¡æ•°æ®ï¼Œè·³è¿‡é‡æ–°ç”Ÿæˆ');
                    log(`å½“å‰ä»»åŠ¡ç»Ÿè®¡: ${Object.keys(window.scrumTasks).filter(k => k !== '__auto' && k !== '__aiGenerated').map(k => `${k}(${window.scrumTasks[k].length})`).join(', ')}`);
                } else {
                    // æ¸…é™¤é¢„è®¾æ•°æ®ï¼Œå¼ºåˆ¶AIé‡æ–°ç”Ÿæˆ
                    log('æ¸…é™¤é¢„è®¾ä»»åŠ¡æ•°æ®ï¼Œå‡†å¤‡AIç”Ÿæˆ');
                    window.scrumTasks = {
                        todo: [],
                        'in-progress': [],
                        done: [],
                        __auto: false,
                        __aiGenerated: false
                    };
                    // è°ƒç”¨è‡ªåŠ¨ç”Ÿæˆï¼ˆAIä¼˜å…ˆï¼Œå¤±è´¥å›é€€ï¼‰
                    if (typeof window.ensureScrumPlanReady === 'function') {
                        log('è°ƒç”¨ensureScrumPlanReady()');
                        addScrumProgress('è°ƒç”¨ensureScrumPlanReady()');
                        await window.ensureScrumPlanReady();
                    } else if (typeof window.generateScrumPlanFromContext === 'function') {
                        log('è°ƒç”¨generateScrumPlanFromContext()');
                        await window.generateScrumPlanFromContext();
                    } else {
                        log('æœªæ‰¾åˆ°ç”Ÿæˆå‡½æ•°ï¼Œä½¿ç”¨é»˜è®¤ä»»åŠ¡æ•°æ®');
                        // å¦‚æœç”Ÿæˆå‡½æ•°ä¸å­˜åœ¨ï¼Œç¡®ä¿æœ‰åŸºæœ¬çš„ä»»åŠ¡æ•°æ®
                        if (!window.scrumTasks || !window.scrumTasks.__auto) {
                            window.scrumTasks = {
                                todo: [
                                    {
                                        id: 'fallback-1',
                                        title: 'ææ–™é‡‡è´­ä¼˜åŒ–',
                                        description: 'å®æ–½ç¯ä¿ææ–™é‡‡è´­ç­–ç•¥',
                                        assignee: 'é‡‡è´­éƒ¨',
                                        priority: 'high',
                                        storyPoints: 8,
                                        startDate: new Date().toISOString().slice(0,10),
                                        endDate: new Date(Date.now() + 7*24*60*60*1000).toISOString().slice(0,10),
                                        tags: ['é‡‡è´­', 'ç¯ä¿']
                                    }
                                ],
                                'in-progress': [],
                                done: [],
                                __auto: true,
                                __aiGenerated: false    // æ ‡è®°ä¸ºå›é€€æ–¹æ¡ˆï¼ŒéAIç”Ÿæˆ
                            };
                        }
                    }
                }

                // ç¡®ä¿ç”˜ç‰¹å›¾è§†å›¾å­˜åœ¨
                const ganttView = document.getElementById('gantt-view');
                if (!ganttView) {
                    log('æœªæ‰¾åˆ°ç”˜ç‰¹å›¾è§†å›¾å®¹å™¨');
                    throw new Error('ç”˜ç‰¹å›¾è§†å›¾å®¹å™¨ä¸å­˜åœ¨');
                }

                // æ˜¾ç¤ºç”˜ç‰¹å›¾è§†å›¾
                log('åˆ‡æ¢åˆ°ç”˜ç‰¹å›¾è§†å›¾');
                addScrumProgress('åˆ‡æ¢åˆ°ç”˜ç‰¹å›¾è§†å›¾');
                ganttView.style.display = 'block';
                
                // éšè—å…¶ä»–è§†å›¾
                const allViews = document.querySelectorAll('.scrum-view');
                allViews.forEach(view => {
                    if (view.id !== 'gantt-view') {
                        view.style.display = 'none';
                    }
                });

                // æ£€æŸ¥ç”˜ç‰¹å›¾æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“
                const ganttChart = document.getElementById('ganttChart');
                const needsGanttRender = !ganttChart || !ganttChart.innerHTML || ganttChart.innerHTML.trim() === '' ||
                                       ganttChart.innerHTML.includes('æš‚æ— ä»»åŠ¡æ•°æ®') || 
                                       ganttChart.innerHTML.includes('ç”˜ç‰¹å›¾åŠ è½½ä¸­');
                
                if (needsGanttRender) {
                    log('ç”˜ç‰¹å›¾éœ€è¦æ¸²æŸ“ï¼Œè°ƒç”¨renderGanttChart()');
                    try {
                        if (typeof window.renderGanttChart === 'function') {
                            window.renderGanttChart();
                            log('ç”˜ç‰¹å›¾æ¸²æŸ“å‡½æ•°è°ƒç”¨å®Œæˆ');
                            // ç”˜ç‰¹å›¾æ¸²æŸ“å®Œæˆï¼Œéšè—è¿›åº¦é¢æ¿
                            setTimeout(() => {
                                hideScrumProgressPanel();
                            }, 500); // å»¶è¿Ÿ500msç¡®ä¿æ¸²æŸ“å®Œæˆ
                        } else {
                            log('renderGanttChartå‡½æ•°ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç®€åŒ–æ¸²æŸ“');
                            if (ganttChart) {
                                ganttChart.innerHTML = `
                                    <div style="padding: 20px; text-align: center;">
                                        <h3>ç”˜ç‰¹å›¾åŠ è½½ä¸­...</h3>
                                        <p>ä»»åŠ¡æ•°æ®å·²å‡†å¤‡å®Œæˆï¼Œæ­£åœ¨æ¸²æŸ“ç”˜ç‰¹å›¾ç•Œé¢</p>
                                        <div style="margin-top: 20px;">
                                            <i class="fas fa-chart-gantt" style="font-size: 48px; color: #007bff;"></i>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (renderError) {
                        log('ç”˜ç‰¹å›¾æ¸²æŸ“å‡ºé”™', renderError);
                        // æä¾›å¤‡ç”¨æ¸²æŸ“
                        if (ganttChart) {
                            const taskCount = Object.values(window.scrumTasks || {}).reduce((count, tasks) => {
                                return count + (Array.isArray(tasks) ? tasks.length : 0);
                            }, 0);
                            
                            ganttChart.innerHTML = `
                                <div style="padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> ç”˜ç‰¹å›¾æ¸²æŸ“é—®é¢˜</h3>
                                    <p>æ£€æµ‹åˆ° ${taskCount} ä¸ªä»»åŠ¡ï¼Œä½†ç”˜ç‰¹å›¾æ¸²æŸ“é‡åˆ°æŠ€æœ¯é—®é¢˜</p>
                                    <p style="color: #666; font-size: 14px;">é”™è¯¯è¯¦æƒ…: ${renderError.message || renderError}</p>
                                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                                        <i class="fas fa-refresh"></i> é‡æ–°åŠ è½½é¡µé¢
                                    </button>
                                </div>
                            `;
                        }
                    }
                } else {
                    log('ç”˜ç‰¹å›¾å·²å­˜åœ¨æœ‰æ•ˆå†…å®¹ï¼Œè·³è¿‡é‡å¤æ¸²æŸ“');
                    log('å½“å‰ç”˜ç‰¹å›¾å†…å®¹é•¿åº¦:', ganttChart ? ganttChart.innerHTML.length : 0);
                    // ç”˜ç‰¹å›¾å·²å­˜åœ¨ï¼Œç›´æ¥éšè—è¿›åº¦é¢æ¿
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 200);
                }

                // æ£€æŸ¥æœ€ç»ˆç»“æœ
                const gantt = document.getElementById('ganttChart');
                if (!gantt) {
                    log('æœªæ‰¾åˆ°#ganttChartå®¹å™¨');
                    throw new Error('ç”˜ç‰¹å›¾å®¹å™¨å…ƒç´ ä¸å­˜åœ¨');
                } else if (!gantt.innerHTML || gantt.innerHTML.trim() === '') {
                    log('ç”˜ç‰¹å®¹å™¨ä¸ºç©ºï¼Œå¯èƒ½æœªç”Ÿæˆä»»åŠ¡æˆ–æ¸²æŸ“å¤±è´¥');
                    gantt.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h3>ç”˜ç‰¹å›¾ä¸ºç©º</h3>
                            <p>è¯·æ£€æŸ¥ä»»åŠ¡æ•°æ®æ˜¯å¦æ­£ç¡®ç”Ÿæˆ</p>
                        </div>
                    `;
                } else {
                    log('ç”˜ç‰¹å›¾æ¸²æŸ“å®Œæˆ');
                    // ç”˜ç‰¹å›¾æ¸²æŸ“å®Œæˆï¼Œéšè—è¿›åº¦é¢æ¿
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 300);
                    // æ»šåŠ¨åˆ°ç”˜ç‰¹å›¾ä½ç½®
                    gantt.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                log('Scrumæ‰§è¡Œæ¨¡å—åŠ è½½å®Œæˆ');
                addScrumProgress('Scrumæ‰§è¡Œæ¨¡å—åŠ è½½å®Œæˆ');
                
            } catch (e) {
                console.error('è¿›å…¥Scrumæ‰§è¡Œå¤±è´¥:', e);
                const debugPanel = document.getElementById('scrumDebugPanel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                    const err = document.createElement('div');
                    err.style.color = '#721c24';
                    err.style.background = '#f8d7da';
                    err.style.border = '1px solid #f5c6cb';
                    err.style.padding = '8px';
                    err.style.borderRadius = '6px';
                    err.style.marginTop = '6px';
                    err.textContent = `é”™è¯¯: ${e && e.message ? e.message : e}`;
                    err.innerHTML += `<br><small>å †æ ˆ: ${e.stack ? e.stack.slice(0,200) : 'æ— '}</small>`;
                    debugPanel.appendChild(err);
                }
                
                // å³ä½¿å‡ºé”™ä¹Ÿå°è¯•æ˜¾ç¤ºScrumæ¨¡å—
                try {
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                    
                    const gantt = document.getElementById('ganttChart');
                    if (gantt) {
                        gantt.innerHTML = `
                            <div style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> åŠ è½½é‡åˆ°é—®é¢˜</h3>
                                <p>Scrumæ¨¡å—åŠ è½½æ—¶é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œä½†æ‚¨ä»å¯ä»¥æŸ¥çœ‹åŸºæœ¬ç•Œé¢</p>
                                <p style="color: #666; font-size: 14px;">è¯¦ç»†é”™è¯¯ä¿¡æ¯è¯·æŸ¥çœ‹ä¸‹æ–¹è°ƒè¯•é¢æ¿</p>
                                <button class="btn btn-warning" onclick="location.reload()" style="margin-top: 15px;">
                                    <i class="fas fa-refresh"></i> é‡æ–°åŠ è½½é¡µé¢
                                </button>
                            </div>
                        `;
                    }
                } catch (fallbackError) {
                    console.error('å¤‡ç”¨æ˜¾ç¤ºä¹Ÿå¤±è´¥:', fallbackError);
                }
                
                alert('è¿›å…¥Scrumæ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•é¢æ¿è·å–è¯¦ç»†ä¿¡æ¯ã€‚å»ºè®®åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–Scrumæ¨¡å—
        document.addEventListener('DOMContentLoaded', function() {
            initializeScrumModule();
        });

        // é‡æ–°æ¸²æŸ“Leanæ¨¡å—çš„æ—¶é—´æ•°æ®
        function refreshLeanTimelineData() {
            const timelineCardsContainer = document.querySelector('.timeline-cards-lean');
            if (timelineCardsContainer && typeof generateTimelineCardsHtml === 'function') {
                timelineCardsContainer.innerHTML = generateTimelineCardsHtml();
            }
        }
        
        // é‡æ–°æ¸²æŸ“Leanæ¨¡å—çš„ç¢³æ’æ”¾æ•°æ®
        function refreshLeanEmissionData() {
            const emissionCardsContainer = document.querySelector('.emission-cards-lean');
            if (emissionCardsContainer && typeof generateEmissionCardsForLean === 'function') {
                emissionCardsContainer.innerHTML = generateEmissionCardsForLean();
            }
        }
        
        // æ¸²æŸ“æ—¶é—´å’Œç¢³æ’æ”¾æ•°æ®å¡ç‰‡
        function renderDataCards() {
            // åˆ·æ–°Leanæ¨¡å—çš„æ—¶é—´æ•°æ®æ˜¾ç¤º
            refreshLeanTimelineData();
            const emissionsData = window.analysisData?.emissions || {};
            const timelineData = window.analysisData?.timeline || {};
            
            // è®¡ç®—ç´¯ç§¯æ”¹è¿›æ•ˆæœ
            const improvements = window.calculateCumulativeImprovements ? window.calculateCumulativeImprovements() : { carbon: {}, time: {} };
            
            // æ³¨æ„ï¼šåŸæœ¬çš„ç¢³æ’æ”¾å’Œæ—¶é—´æ•°æ®æ¸²æŸ“é€»è¾‘å·²ç§»é™¤ï¼Œ
            // å› ä¸ºç›¸åº”çš„DOMå®¹å™¨(emissionsData, timelineData)åœ¨å½“å‰é¡µé¢ä¸­ä¸å­˜åœ¨
            // å®é™…çš„æ•°æ®å±•ç¤ºé€šè¿‡å…¶ä»–æ–¹å¼å¤„ç†
        }

        // è·å–ç¢³æ’æ”¾é˜¶æ®µå›¾æ ‡
        function getEmissionIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-chart-bar';
        }

        // è·å–ç¢³æ’æ”¾é˜¶æ®µåç§°
        function getEmissionPhaseName(phase) {
            const names = {
                procurement: 'åŸæ–™é‡‡è´­',
                manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                logistics: 'ç‰©æµè¿è¾“',
                usage: 'äº§å“ä½¿ç”¨',
                recycling: 'å›æ”¶å¤„ç†',
                decomposition: 'è‡ªç„¶é™è§£'
            };
            return names[phase] || phase;
        }

        // è·å–æ—¶é—´é˜¶æ®µå›¾æ ‡
        function getTimelineIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-clock';
        }

        // è·å–æ—¶é—´é˜¶æ®µåç§°
        function getTimelinePhaseName(phase) {
            const names = {
                procurement: 'åŸæ–™é‡‡è´­',
                manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                logistics: 'ç‰©æµè¿è¾“',
                usage: 'äº§å“ä½¿ç”¨',
                recycling: 'å›æ”¶å¤„ç†',
                decomposition: 'è‡ªç„¶é™è§£'
            };
            return names[phase] || phase;
        }

        // è·å–fallbackå»ºè®®
        function getFallbackSuggestions(area) {
            const fallbackData = {
                'åŸææ–™é‡‡è´­': [
                    {
                        icon: 'fas fa-truck',
                        title: 'ä¼˜åŒ–ä¾›åº”å•†é€‰æ‹©',
                        timeImprovement: 'å‡å°‘ 3ä¸ªæœˆ',
                        carbonReduction: 'å‡å°‘ 15%',
                        desc: 'é€‰æ‹©è·ç¦»æ›´è¿‘çš„ä¾›åº”å•†ï¼Œå‡å°‘è¿è¾“è·ç¦»å’Œç¢³æ’æ”¾',
                        subProject: 'ä¾›åº”å•†ç®¡ç†',
                        carbonImprovements: { procurement: 15, manufacturing: 0, logistics: 10, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 3, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: 'æé«˜ææ–™å›æ”¶ç‡',
                        timeImprovement: 'å¢åŠ  2ä¸ªæœˆ',
                        carbonReduction: 'å‡å°‘ 25%',
                        desc: 'ä½¿ç”¨æ›´å¤šå›æ”¶ææ–™ï¼Œè™½ç„¶ä¼šå¢åŠ é‡‡è´­æ—¶é—´ï¼Œä½†æ˜¾è‘—å‡å°‘ç¢³æ’æ”¾',
                        subProject: 'ææ–™é€‰æ‹©',
                        carbonImprovements: { procurement: 25, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: -2, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                'å…³é”®éƒ¨ä»¶åˆ¶é€ ': [
                    {
                        icon: 'fas fa-cogs',
                        title: 'ä¼˜åŒ–ç”Ÿäº§å·¥è‰º',
                        timeImprovement: 'å‡å°‘ 5ä¸ªæœˆ',
                        carbonReduction: 'å‡å°‘ 20%',
                        desc: 'æ”¹è¿›åˆ¶é€ æµç¨‹ï¼Œæé«˜æ•ˆç‡å¹¶å‡å°‘èƒ½æºæ¶ˆè€—',
                        subProject: 'å·¥è‰ºä¼˜åŒ–',
                        carbonImprovements: { procurement: 0, manufacturing: 20, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 5, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-industry',
                        title: 'ä½¿ç”¨å¿«é€Ÿæˆå‹æŠ€æœ¯',
                        timeImprovement: 'å‡å°‘ 8ä¸ªæœˆ',
                        carbonReduction: 'å¢åŠ  10%',
                        desc: 'é‡‡ç”¨å¿«é€Ÿæˆå‹æŠ€æœ¯ç¼©çŸ­ç”Ÿäº§å‘¨æœŸï¼Œä½†å¯èƒ½å¢åŠ èƒ½æºæ¶ˆè€—',
                        subProject: 'æŠ€æœ¯å‡çº§',
                        carbonImprovements: { procurement: 0, manufacturing: -10, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 8, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                'ä¾›åº”é“¾ç®¡ç†': [
                    {
                        icon: 'fas fa-route',
                        title: 'ä¼˜åŒ–ç‰©æµè·¯çº¿',
                        timeImprovement: 'å‡å°‘ 4ä¸ªæœˆ',
                        carbonReduction: 'å‡å°‘ 18%',
                        desc: 'é‡æ–°è§„åˆ’è¿è¾“è·¯çº¿ï¼Œå‡å°‘è¿è¾“æ—¶é—´å’Œç¢³æ’æ”¾',
                        subProject: 'ç‰©æµä¼˜åŒ–',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: 18, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 4, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-shipping-fast',
                        title: 'å¿«é€Ÿè¿è¾“æ–¹æ¡ˆ',
                        timeImprovement: 'å‡å°‘ 6ä¸ªæœˆ',
                        carbonReduction: 'å¢åŠ  12%',
                        desc: 'é‡‡ç”¨å¿«é€Ÿè¿è¾“æ–¹å¼ç¼©çŸ­äº¤ä»˜æ—¶é—´ï¼Œä½†ä¼šå¢åŠ ç¢³æ’æ”¾',
                        subProject: 'è¿è¾“ç­–ç•¥',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: -12, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 6, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ]
            };
            
            return fallbackData[area] || [];
        }
    </script>

    <style>
        .improvement-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .improvement-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .nav-brand span {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        /* æ·±åº¦åˆ†ææ¨¡æ€æ¡†æ ·å¼ */
        .deep-analysis-modal .modal-content {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
        }

        .analysis-progress {
            padding: 20px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .progress-item.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            animation: pulse 1.5s infinite;
        }

        .progress-item.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .progress-item i {
            margin-right: 15px;
            font-size: 18px;
            color: #666;
        }

        .progress-item.active i {
            color: #2196f3;
        }

        .progress-item.completed i {
            color: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .analysis-summary {
            padding: 20px;
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .analysis-card.risk-assessment {
            border-left-color: #dc3545;
        }

        .analysis-card.optimization-potential {
            border-left-color: #28a745;
        }

        .analysis-card.recommendations {
            border-left-color: #ffc107;
        }

        .analysis-card h5 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
        }

        .analysis-card h5 i {
            margin-right: 10px;
        }

        .risk-item, .potential-item, .recommendation-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .risk-item:last-child, .potential-item:last-child, .recommendation-item:last-child {
            border-bottom: none;
        }

        .risk-item.high {
            color: #dc3545;
            font-weight: 500;
        }

        .risk-item.medium {
            color: #ffc107;
            font-weight: 500;
        }

        .risk-item.low {
            color: #28a745;
            font-weight: 500;
        }

        .analysis-chat {
            border-top: 1px solid #eee;
            padding: 20px;
        }

        #deepChatMessages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .large-modal {
            max-width: 900px !important;
            width: 90% !important;
        }

        /* æ–°å¢æ ·å¼ï¼šä¸ªæ€§åŒ–å»ºè®®å’ŒçŠ¶æ€æŒä¹…åŒ– */
        .solution-area-card {
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .solution-area-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ç§»é™¤has-acceptedæ ·å¼ï¼Œæ–¹æ¡ˆå†…å®¹åˆ†æåŒºåŸŸä¸å› é‡‡çº³å»ºè®®è€Œå˜è‰² */
        .solution-area-card.has-accepted {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .accepted-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* å»ºè®®å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .suggestion-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .suggestion-card.accepted {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .suggestion-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .suggestion-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .suggestion-icon i {
            color: white;
            font-size: 20px;
        }

        .suggestion-title {
            flex: 1;
        }

        .suggestion-title h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .improvement-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .metric.improvement {
            background: #e8f5e8;
            color: #28a745;
            border: 1px solid #c3e6c3;
        }

        .metric.tradeoff {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .metric i {
            font-size: 12px;
        }

        .suggestion-content {
            margin-bottom: 20px;
        }

        .suggestion-desc {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .suggestion-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .sub-project {
            background: #f8f9fa;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }

        .suggestion-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .accepted-status {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #28a745;
            font-weight: 500;
            font-size: 14px;
        }

        .accepted-status i {
            font-size: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* æ•°æ®å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .data-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .data-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .data-card .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .data-card .card-icon i {
            color: white;
            font-size: 16px;
        }

        .data-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .data-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .emission-value, .duration-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .unit {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .data-card .progress-bar {
            margin-top: auto;
        }

        .improvement-indicator {
            color: #28a745;
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .timeline-change-badge,
        .emission-change-badge {
            font-size: 12px;
            font-weight: 500;
            margin-left: 6px;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* æ·±åº¦åˆ†æAIåŠ©æ‰‹æ ·å¼ */
        .suggestion-consult-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .suggestion-consult-header h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .suggestion-description {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .ai-consult-guide {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ai-consult-guide h5 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .consult-options {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .consult-options li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consult-options li i {
            width: 20px;
            text-align: center;
        }

        .ai-welcome-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            flex: 1;
            line-height: 1.5;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading-suggestions {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-suggestions i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #007bff;
        }



        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .metric-values {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-values .before {
            color: #666;
        }

        .metric-values .after {
            color: #28a745;
            font-weight: bold;
        }

        .metric-values .after.pending {
            color: #ffc107;
            font-style: italic;
        }

        .improvement-rate {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .improvement-rate.positive {
            background: #d4edda;
            color: #155724;
        }

        .improvement-rate.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* AIåˆ†æåŠ©æ‰‹å¼¹çª—é«˜åº¦ä¼˜åŒ– */
        .modal-content {
            max-height: 85vh !important;
            height: auto !important;
            overflow-y: auto;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .ai-response {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* å¯¹è¯å†å²æ ·å¼ä¼˜åŒ– */
        .history-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .history-question {
            margin-bottom: 8px;
            color: #333;
        }

        .history-answer {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .history-time {
            font-size: 12px;
            color: #999;
            text-align: right;
        }

        /* ==================== Scrumæ¨¡å—æ ·å¼ ==================== */
        
        /* Scrumæ§åˆ¶é¢æ¿ */
        .scrum-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .view-switcher {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .view-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .view-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        .sprint-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .sprint-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .sprint-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .sprint-dates {
            color: #666;
            font-size: 14px;
        }

        .sprint-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-scrum {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-scrum {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        /* Scrumå†…å®¹å¸ƒå±€ */
        /* ä»…åœ¨åˆ‡æ¢åˆ°Scrumæ¨¡å—æ—¶æ˜¾ç¤ºï¼Œç”±styles.cssé‡Œçš„ .module/.module.active æ§åˆ¶ */
        /* [MODIFIED][Impact: ä»…å½±å“æ˜¾ç¤ºæ§åˆ¶][Backward Compatibility: ä¸å½±å“å…¶ä»–æ ·å¼] */

        #scrum-module .module-header {
            margin-bottom: 20px;
        }

        #scrum-module .scrum-controls {
            margin-bottom: 20px;
        }

        /* Kanbançœ‹æ¿æ ·å¼ */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 600px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            transition: all 0.3s ease;
        }

        .kanban-column.drag-over {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .column-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-count {
            background: #007bff;
            color: white;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .add-task-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 400px;
        }

        /* ä»»åŠ¡å¡ç‰‡æ ·å¼ */
        .task-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #e0e0e0;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .task-points {
            background: #f8f9fa;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .task-title {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .task-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-progress {
            margin-bottom: 10px;
        }

        .progress-bar-task {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill-task {
            height: 100%;
            background: #28a745;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignee-avatar {
            font-size: 16px;
        }

        .assignee-name {
            color: #666;
            font-weight: 500;
        }

        .task-dates {
            color: #999;
        }

        /* ç”˜ç‰¹å›¾æ ·å¼ */
        .gantt-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .gantt-controls {
            display: flex;
            gap: 10px;
        }

        .gantt-timeline {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .gantt-header-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-weight: bold;
        }

        .task-info-header {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            color: #333;
        }

        .timeline-header {
            display: flex;
            /* ç§»é™¤å›ºå®šmin-widthï¼Œä½¿ç”¨åŠ¨æ€è®¡ç®—çš„å®½åº¦ */
        }

        .date-column {
            /* ä½¿ç”¨åŠ¨æ€å®½åº¦ï¼Œé€šè¿‡å†…è”æ ·å¼è®¾ç½®å…·ä½“å®½åº¦ */
            min-width: 60px;
            padding: 15px 5px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            flex-shrink: 0; /* é˜²æ­¢åˆ—è¢«å‹ç¼© */
        }

        .gantt-task-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            border-bottom: 1px solid #e0e0e0;
            min-height: 60px;
        }

        .task-info {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            background: white;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        .task-info-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            max-width: 270px; /* ç¡®ä¿å†…å®¹ä¸ä¼šè¶…å‡ºå®¹å™¨ */
        }

        .task-title-gantt {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .task-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            max-width: 100%;
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }

        .task-story-points {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #6c757d;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-dates {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .priority-high {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-medium {
            background: #fff3cd;
            color: #856404;
        }

        .priority-low {
            background: #d4edda;
            color: #155724;
        }

        .timeline-content {
            padding: 10px;
            background: #fafafa;
            /* ç§»é™¤å›ºå®šmin-widthï¼Œä½¿ç”¨åŠ¨æ€å®½åº¦ */
        }

        .gantt-bar-container {
            height: 40px;
            position: relative;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .gantt-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 4px;
        }

        .gantt-bar-text {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }





        /* ä»»åŠ¡ç§»åŠ¨é€šçŸ¥ */
        .task-move-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .task-move-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .task-move-notification i {
            font-size: 18px;
        }

        /* å“åº”å¼è®¾è®¡ */

        @media (max-width: 768px) {
            .suggestions-grid {
                grid-template-columns: 1fr;
            }
            
            .suggestion-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .suggestion-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .improvement-metrics {
                justify-content: center;
            }
            
            .suggestion-actions {
                justify-content: center;
            }
            
            .scrum-controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .gantt-timeline {
                font-size: 12px;
            }
            
            .timeline-header {
                /* ç§»é™¤å›ºå®šmin-widthï¼Œä½¿ç”¨åŠ¨æ€å®½åº¦ */
                overflow-x: hidden;
            }
        }
    </style>
</body>
</html>
