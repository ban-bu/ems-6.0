<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>碳排放管理系统 - EMS (改进版)</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="improvements.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 配置管理器 - 必须在其他脚本之前加载 -->
    <script src="config.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-leaf"></i>
                <span>碳排放管理系统 (改进版)</span>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-module="upload">文档上传</button>
                <button class="nav-tab" data-module="kanban">Kanban分析</button>
                <button class="nav-tab" data-module="lean">Lean优化</button>
                <button class="nav-tab" data-module="scrum">Scrum执行</button>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 文档上传模块 -->
            <div id="upload-module" class="module active">
                <div class="module-header">
                    <h2><i class="fas fa-upload"></i> 产品设计方案上传</h2>
                    <p>上传您的产品设计方案，系统将自动分析碳排放并优化生产流程</p>

                </div>
                
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>拖拽文件到此处或点击上传</h3>
                        <p>支持 PDF, DOC, DOCX, TXT 格式</p>
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" hidden>
                        <button class="btn btn-primary" id="selectFileBtn">
                            选择文件
                        </button>
                    </div>
                    
                    <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                        <h4>已上传文件</h4>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>

                <!-- AI补充信息区域 -->
                <div class="ai-supplement" id="aiSupplement" style="display: none;">
                    <div class="ai-chat">
                        <div class="chat-header">
                            <i class="fas fa-robot"></i>
                            <span>AI助手 - 补充缺失信息</span>
                        </div>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="请回答AI的问题...">
                            <button class="btn btn-primary" onclick="sendMessage()">发送</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                    <button class="btn btn-success" id="startAnalysis" onclick="startAnalysis()" disabled>
                        <i class="fas fa-play"></i> 开始分析
                    </button>
                    <button class="btn btn-primary" id="downloadBtn" onclick="downloadCompletedDocument()" style="display: none;">
                        <i class="fas fa-download"></i> 下载AI补全文档
                    </button>
                </div>
                </div>
            </div>

            <!-- Kanban模块 -->
            <div id="kanban-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-chart-line"></i> Kanban 碳排放分析</h2>
                    <p>产品生命周期碳排放预测与逆时间线展示</p>

                </div>
                
                <div class="timeline-container">
                    <h3>产品生命周期逆时间线</h3>
                    <div class="reverse-timeline" id="reverseTimeline">
                        <!-- 时间线节点将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="emission-analysis">
                    <h3>各环节碳排放分析</h3>
                    <div class="emission-cards" id="emissionCards">
                        <!-- 排放卡片将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- Lean模块 -->
            <div id="lean-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-lightbulb"></i> Lean 优化分析</h2>
                    <p>深度分析高排放原因并提供优化建议</p>

                </div>
                
                <div class="analysis-content" id="leanAnalysis">
                    <div class="analysis-placeholder">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>请在Kanban模块中完成分析后进入Lean优化</p>
                    </div>
                </div>
            </div>

            <!-- Scrum模块 -->
            <div id="scrum-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-tasks"></i> Scrum 执行跟踪</h2>
                    <p>各部门任务分配与进度监控</p>

                </div>
                
                <!-- Scrum控制面板（已移除Sprint信息，应用户要求隐藏该模块） -->

                <!-- Scrum内容区域 -->
                <div class="scrum-content" id="scrumContent">
                    <!-- 甘特图视图（仅保留甘特图） -->
                    <div class="scrum-view" id="gantt-view" style="display: block;">
                        <div class="gantt-container">
                            <div class="gantt-header">
                                <h3><i class="fas fa-chart-gantt"></i> 项目甘特图</h3>
                                <div class="gantt-controls">
                                    <button class="btn btn-primary" onclick="adjustGanttZoom('day')">日视图</button>
                                    <button class="btn btn-secondary" onclick="adjustGanttZoom('week')">周视图</button>
                                </div>
                            </div>
                            <div class="gantt-chart" id="ganttChart">
                                <!-- 甘特图将通过JavaScript动态生成 -->
                            </div>
                            <div id="scrumDebugPanel" class="scrum-debug" style="display:none; margin-top:10px; background:#fff3cd; border:1px solid #ffeaa7; padding:8px; border-radius:6px;"></div>
                        </div>
                    </div>


                </div>


            </div>
        </main>
    </div>

    <!-- AI对话弹窗 -->
    <div class="modal" id="aiModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-robot"></i> AI分析助手</h3>
                <button class="close-btn" onclick="closeAiModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="selected-data" id="selectedData"></div>
                <div class="ai-question">
                    <label for="aiQuestion">请输入您的问题：</label>
                    <textarea id="aiQuestion" placeholder="例如：为什么这个环节的排放量这么高？"></textarea>
                    <button class="btn btn-primary" onclick="askAI()">询问AI</button>
                </div>
                <div class="ai-response" id="aiResponse" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- 引入Mammoth.js库用于DOCX文件解析 -->
    <script src="https://unpkg.com/mammoth@1.4.21/mammoth.browser.min.js"></script>
    
    <!-- 在script.js加载前重写关键函数 -->
    <script>
        // 预先重写selectSolutionArea函数
        window.selectSolutionArea = async function(area) {
            console.log('重写的selectSolutionArea被调用:', area);
            
            // 保存当前选中领域
            if (window.currentSelectedArea !== undefined) {
                window.currentSelectedArea = area;
            }

            // 高亮选中的项目
            document.querySelectorAll('.solution-area-card').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-area="${area}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
            
            // 显示分析区域
            const selectedAnalysis = document.getElementById('selectedAnalysis');
            const optimizationSection = document.getElementById('optimizationSection');
            if (selectedAnalysis) selectedAnalysis.style.display = 'block';
            if (optimizationSection) optimizationSection.style.display = 'block';
            
            // 显示加载状态
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AI正在分析中，生成个性化建议...</div>';
            }
            
            // 直接调用AI生成函数
            try {
                console.log('开始调用AI生成函数');
                if (typeof window.generatePersonalizedSuggestions === 'function') {
                    await window.generatePersonalizedSuggestions(area);
                } else {
                    console.error('generatePersonalizedSuggestions函数未定义');
                }
            } catch (error) {
                console.error('AI生成失败:', error);
            }
        };
    </script>
    
    <script src="script.js"></script>
    <script>
        // 碳排放管理系统改进功能
        
        // 全局变量 - 修复采纳状态持久化问题
        // 使用window对象避免与script.js中的变量冲突
        if (!window.acceptedSuggestions) {
            // 清除缓存，重置状态
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }
        
        // 初始化全局变量
        if (!window.acceptedSuggestions) {
            // 清除缓存，重置状态
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.lastSuggestionsCache) {
            window.lastSuggestionsCache = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }

        // 初始化分析数据
        if (!window.analysisData) {
            window.analysisData = {
                emissions: {
                    procurement: { value: 80, originalValue: 80 },
                    manufacturing: { value: 120, originalValue: 120 },
                    logistics: { value: 45, originalValue: 45 },
                    usage: { value: 200, originalValue: 200 },
                    recycling: { value: 25, originalValue: 25 },
                    decomposition: { value: 10, originalValue: 10 }
                },
                timeline: {
                    procurement: { duration: 30, originalDuration: 30, unit: '天' },
                    manufacturing: { duration: 45, originalDuration: 45, unit: '天' },
                    logistics: { duration: 7, originalDuration: 7, unit: '天' },
                    usage: { duration: 730, originalDuration: 730, unit: '天' },
                    recycling: { duration: 60, originalDuration: 60, unit: '天' },
                    decomposition: { duration: 1825, originalDuration: 1825, unit: '天' }
                }
            };
        }

        // 页面加载完成后应用累积改进效果
        document.addEventListener('DOMContentLoaded', function() {
            // 如果有已采纳的建议，应用累积效果
            if (window.acceptedSuggestions && window.acceptedSuggestions.length > 0) {
                setTimeout(() => {
                    if (typeof window.updateAllDataCards === 'function') {
                        window.updateAllDataCards();
                    }
                }, 500);
            }
            
            // 渲染数据卡片
            if (typeof renderDataCards === 'function') {
                renderDataCards();
            }
        });

        // 改进1: AI助手刷新功能
        function refreshFieldContent(fieldName) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"] .field-value`);
            if (!fieldElement) return;
            
            // 显示加载状态
            fieldElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI重新生成中...';
            
            // 模拟AI重新生成内容
            setTimeout(() => {
                const newContent = generateSmartFieldContent(fieldName);
                fieldElement.textContent = newContent;
                fieldElement.setAttribute('data-original', newContent);
                
                // 更新存储的数据
                if (window.supplementData) {
                    window.supplementData[fieldName] = newContent;
                }
                
                // 显示成功消息
                addAIMessage(`🔄 "${fieldName}"已重新生成：${newContent}`);
            }, 1500);
        }

        // 根据字段类型生成智能内容
        function generateSmartFieldContent(fieldName) {
            const documentType = window.currentAnalysis?.documentType || 'general';
            
            const smartContentGenerators = {
                '供应商地理位置信息': () => {
                    const locations = ['江苏苏州', '广东深圳', '浙江杭州', '山东青岛', '河北石家庄', '湖北武汉'];
                    const selected = locations[Math.floor(Math.random() * locations.length)];
                    return `${selected}（基于${getDocumentTypeName(documentType)}产业集群分析）`;
                },
                '原材料具体规格和来源': () => {
                    const materials = {
                        electronics: ['芯片-台积电', '金属外壳-富士康', '电池-宁德时代'],
                        textile: ['有机棉-新疆', '环保染料-德国巴斯夫', '再生纤维-日本东丽'],
                        automotive: ['钢材-宝钢集团', '橡胶-米其林', '电池-比亚迪'],
                        general: ['钢材-宝钢集团', '塑料-中石化', '电子元件-富士康']
                    };
                    const typeMatrials = materials[documentType] || materials.general;
                    return typeMatrials.join('，');
                },
                '生产工艺详细流程': () => {
                    const processes = {
                        electronics: '芯片封装→电路板组装→外壳装配→系统测试→质量检验',
                        textile: '纤维处理→纺纱织布→染色印花→裁剪缝制→质量检测',
                        automotive: '冲压成型→焊接装配→涂装处理→总装调试→路试检验',
                        general: '原料预处理→精密加工→质量检测→组装集成→包装入库'
                    };
                    return processes[documentType] || processes.general;
                },
                '物流运输方式和路径': () => {
                    const logistics = [
                        '公路运输为主，平均运距' + (Math.floor(Math.random() * 200) + 200) + '公里',
                        '铁路+公路联运，绿色物流占比' + (Math.floor(Math.random() * 30) + 20) + '%',
                        '多式联运，海运+陆运结合，成本优化' + (Math.floor(Math.random() * 15) + 10) + '%'
                    ];
                    return logistics[Math.floor(Math.random() * logistics.length)];
                },
                '产品使用场景和周期': () => {
                    const scenarios = {
                        electronics: `消费电子产品，典型使用寿命${Math.floor(Math.random() * 5) + 3}-${Math.floor(Math.random() * 3) + 8}年`,
                        textile: `日常服装，推荐穿戴周期${Math.floor(Math.random() * 24) + 12}个月`,
                        automotive: `交通工具，使用寿命${Math.floor(Math.random() * 5) + 8}-${Math.floor(Math.random() * 5) + 12}年`,
                        general: `通用产品，典型使用寿命${Math.floor(Math.random() * 3) + 3}-${Math.floor(Math.random() * 3) + 6}年`
                    };
                    return scenarios[documentType] || scenarios.general;
                }
            };
            
            const generator = smartContentGenerators[fieldName];
            if (generator) {
                return generator();
            }
            
            // 默认生成
            return `基于${getDocumentTypeName(documentType)}行业特点重新生成的${fieldName}信息`;
        }

        // 改进2: 对话记录功能
        if (!window.aiChatHistory) {
            window.aiChatHistory = {
                kanban: [],
                lean: []
            };
        }

        // 立即重写函数，不等待DOM加载
        (function() {
            // 重写displayAutoCompletedData函数以添加刷新按钮
            const originalDisplayAutoCompletedData = window.displayAutoCompletedData;
            
            if (originalDisplayAutoCompletedData) {
                window.displayAutoCompletedData = function(data) {
                    const chatMessages = document.getElementById('chatMessages');
                    const autoCompletedDiv = document.createElement('div');
                    autoCompletedDiv.className = 'message ai auto-completed-data';
                    autoCompletedDiv.id = 'autoCompletedData';
                    
                    let content = '<div class="auto-completed-header"><i class="fas fa-magic"></i> <strong>AI自动补全结果：</strong></div>';
                    
                    Object.entries(data).forEach(([key, value]) => {
                        content += `
                            <div class="auto-completed-item" data-field="${key}">
                                <div class="field-label"><strong>${key}:</strong></div>
                                <div class="field-value" contenteditable="true" data-original="${value}">${value}</div>
                                <div class="field-actions">
                                    <button class="btn-mini btn-edit" onclick="editField('${key}')" title="编辑字段">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button class="btn-mini btn-reset" onclick="resetField('${key}')" title="重置为推荐值">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    autoCompletedDiv.innerHTML = content;
                    chatMessages.appendChild(autoCompletedDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
            }

            // 增强的AI对话模态框
            const originalOpenAIModal = window.openAIModal;
            if (originalOpenAIModal) {
                window.openAIModal = function(emissionType, emissionData) {
                    selectedEmissionData = { type: emissionType, data: emissionData };
                    
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    const typeNames = {
                        procurement: '原料采购',
                        manufacturing: '生产制造',
                        logistics: '物流运输',
                        usage: '产品使用',
                        recycling: '回收处理',
                        decomposition: '自然降解'
                    };
                    
                    // 确定当前模块
                    const currentModule = document.querySelector('.nav-tab.active')?.dataset.module || 'kanban';
                    
                    selectedDataDiv.innerHTML = `
                        <h4>选中数据: ${typeNames[emissionType]}</h4>
                        <p>碳排放值: <strong>${emissionData.value}</strong></p>
                        <p>排放级别: <strong>${emissionData.level === 'high' ? '高' : emissionData.level === 'medium' ? '中' : '低'}</strong></p>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-history"></i> 对话记录</h5>
                            <div class="history-messages" id="historyMessages">
                                ${renderChatHistory(currentModule, emissionType)}
                            </div>
                        </div>
                    `;
                    
                    // 设置当前模块类型
                    modal.setAttribute('data-module', currentModule);
                    modal.setAttribute('data-emission-type', emissionType);
                    
                    modal.style.display = 'flex';
                };
            }

            // 增强的AI询问功能
            const originalAskAI = window.askAI;
            if (originalAskAI) {
                window.askAI = async function() {
                    const questionInput = document.getElementById('aiQuestion');
                    if (!questionInput) {
                        alert('无法找到问题输入框');
                        return;
                    }
                    
                    const question = questionInput.value.trim();
                    if (!question) {
                        alert('请输入您的问题');
                        return;
                    }
                    
                    const modal = document.getElementById('aiModal');
                    if (!modal) {
                        alert('无法找到AI对话框');
                        return;
                    }
                    
                    const moduleType = modal.getAttribute('data-module') || 'kanban';
                    const emissionType = modal.getAttribute('data-emission-type');
                    const mode = modal.getAttribute('data-mode');
                    
                    const responseDiv = document.getElementById('aiResponse');
                    if (responseDiv) {
                        responseDiv.style.display = 'block';
                        responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI正在分析中...';
                    }
                    
                    try {
                        let response;
                        if (mode === 'suggestion-consult') {
                            // 深度分析AI助手模式
                            response = await callSuggestionAI(question, window.currentConsultSuggestion);
                        } else {
                            // 普通AI分析模式
                            response = await callAI(question, selectedEmissionData);
                        }
                        
                        // 保存对话记录
                        saveAIChatHistory(moduleType, emissionType, question, response);
                        
                        responseDiv.innerHTML = `
                            <h4><i class="fas fa-lightbulb"></i> AI分析结果</h4>
                            <div class="ai-analysis">${response}</div>
                            <div class="action-buttons" style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="continueConversation()" style="margin-right: 0.5rem;">
                                    <i class="fas fa-comments"></i> 继续追问
                                </button>
                                <button class="btn btn-primary" onclick="closeAiModal()">
                                    <i class="fas fa-times"></i> 关闭
                                </button>
                            </div>
                        `;
                        
                        // 更新对话历史显示
                        updateChatHistoryDisplay(moduleType, emissionType);
                        
                    } catch (error) {
                        console.error('AI分析失败:', error);
                        responseDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI服务暂不可用，请稍后重试。</div>`;
                    }
                };
            }

            // 重写Lean模块的渲染函数以支持个性化建议和状态持久化
            const originalRenderLeanModule = window.renderLeanModule;
            if (originalRenderLeanModule) {
                window.renderLeanModule = function() {
                    const leanContent = document.getElementById('leanAnalysis');
                    
                    // 获取实际方案内容分析结果
                    const solutionAnalysis = getSolutionAnalysisResults();
                    
                    // 获取碳排放卡片数据
                    const emissionCardsHtml = generateEmissionCardsForLean();
                    
                    leanContent.innerHTML = `
                        <div class="solution-analysis-section">
                            <h3><i class="fas fa-file-alt"></i> 方案内容分析</h3>
                            <div class="solution-analysis-results">
                                ${solutionAnalysis.map(analysis => {
                                    const classMap = {
                                        '材料选择': 'material-optimization',
                                        '生产工艺': 'process-improvement', 
                                        '供应链管理': 'management-enhancement',
                                        '产品设计': 'tech-innovation',
                                        '包装方案': 'material-optimization'
                                    };
                                    const isSelected = window.currentSelectedArea === analysis.area;
                                    // 移除has-accepted样式，方案内容分析区域不因采纳建议而变色
                                    return `
                                    <div class="solution-area-card ${classMap[analysis.area] || 'tech-innovation'} ${isSelected ? 'selected' : ''}" onclick="selectSolutionArea('${analysis.area}')" data-area="${analysis.area}">
                                        <h4>
                                            <i class="${analysis.icon} area-icon"></i>
                                            ${analysis.area}
                                        </h4>
                                        <p>${analysis.currentStatus}</p>
                                        <div class="improvement-potential">改进潜力: ${analysis.improvementPotential}</div>
                                    </div>
                                `}).join('')}
                            </div>
                            <div class="selection-hint">
                                <i class="fas fa-hand-pointer"></i> 点击任意方案领域进行深度分析
                            </div>
                        </div>
                        
                        <div class="analysis-section" id="selectedAnalysis" style="display: ${window.currentSelectedArea ? 'block' : 'none'};">
                            <h3><i class="fas fa-search"></i> 方案领域深度分析</h3>
                            <div id="optimizationSection">
                                <h3><i class="fas fa-lightbulb"></i> 优化建议</h3>
                                <div class="suggestions" id="suggestionsContent">
                                    ${window.currentSelectedArea ? '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> 正在加载建议...</div>' : ''}
                                </div>
                            </div>
                        </div>

                        
                        <div class="detailed-data-section">
                            <h3><i class="fas fa-chart-bar"></i> 时间和碳排放数据</h3>
                            <div class="data-container">
                                <div class="emission-data-block">
                                    <h4><i class="fas fa-leaf"></i> 碳排放数据</h4>
                                    <div class="emission-cards-lean">
                                        ${emissionCardsHtml}
                                    </div>
                                </div>
                                <div class="timeline-data-block">
                                    <h4><i class="fas fa-clock"></i> 时间数据</h4>
                                    <div class="timeline-cards-lean">
                                        ${generateTimelineCardsHtml()}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lean-to-scrum-action-section">
                            <h3><i class="fas fa-arrow-right"></i> 下一步：进入Scrum执行</h3>
                            <p>在Lean优化分析完成后，您可以将采纳的建议转化为Scrum任务，进行项目执行和跟踪。</p>
                            <button class="btn btn-primary btn-large" onclick="goToScrumExecution()">
                                <i class="fas fa-tasks"></i> 转到Scrum执行
                            </button>
                        </div>
                    `;
                    
                    // 如果有选中的领域，异步加载建议内容
                    if (window.currentSelectedArea) {
                        // 如果有缓存的建议，直接渲染
                        if (window.lastSuggestionsCache && window.lastSuggestionsCache[window.currentSelectedArea]) {
                            window.renderSuggestions(window.currentSelectedArea, window.lastSuggestionsCache[window.currentSelectedArea]);
                        } else {
                            // 否则重新生成建议
                            setTimeout(() => {
                                if (typeof window.generatePersonalizedSuggestions === 'function') {
                                    window.generatePersonalizedSuggestions(window.currentSelectedArea);
                                }
                            }, 100);
                        }
                    }
                };
            }



                    // 重写选择方案领域函数
        const originalSelectSolutionArea = window.selectSolutionArea;
        if (originalSelectSolutionArea) {
            window.selectSolutionArea = async function(area) {
                console.log('选择方案领域:', area);
                
                // 保存当前选中领域
                window.currentSelectedArea = area;

                // 高亮选中的项目
                document.querySelectorAll('.solution-area-card').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-area="${area}"]`);
                if (selectedCard) selectedCard.classList.add('selected');
                
                // 显示分析区域
                const selectedAnalysis = document.getElementById('selectedAnalysis');
                const optimizationSection = document.getElementById('optimizationSection');
                if (selectedAnalysis) selectedAnalysis.style.display = 'block';
                if (optimizationSection) optimizationSection.style.display = 'block';
                

                
                // 显示加载状态
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    // 若有缓存则直接渲染，不再显示加载与重新生成
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        window.renderSuggestions(area, window.lastSuggestionsCache[area]);
                        return; // 使用缓存并保持采纳状态
                    } else {
                        suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AI正在分析中，生成个性化建议...</div>';
                    }
                }
                
                // 直接调用AI生成函数
                try {
                    console.log('开始调用AI生成函数');
                    await window.generatePersonalizedSuggestions(area);
                } catch (error) {
                    console.error('AI生成失败:', error);
                    const suggestionsDiv = document.getElementById('suggestionsContent');
                    if (suggestionsDiv) {
                        suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI服务暂不可用，请稍后重试。</div>';
                    }
                }
            };
        }

            // 重写采纳建议函数以支持状态持久化
            const originalAcceptSuggestion = window.acceptSuggestion;
            if (originalAcceptSuggestion) {
                window.acceptSuggestion = function(suggestionTitle, event) {
                    // 添加到已采纳建议列表
                    if (!window.acceptedSuggestions.includes(suggestionTitle)) {
                        window.acceptedSuggestions.push(suggestionTitle);
                        window.hasAcceptedSuggestions = true;
                        // 按领域存储已采纳建议
                        if (window.currentSelectedArea) {
                            if (!window.acceptedSuggestionsByArea[window.currentSelectedArea]) {
                                window.acceptedSuggestionsByArea[window.currentSelectedArea] = [];
                            }
                            window.acceptedSuggestionsByArea[window.currentSelectedArea].push(suggestionTitle);
                        }
                        // 持久化存储
                        localStorage.setItem('acceptedSuggestions', JSON.stringify(window.acceptedSuggestions));
                        localStorage.setItem('acceptedSuggestionsByArea', JSON.stringify(window.acceptedSuggestionsByArea));
                        
                        // 使用累积计算更新所有数据卡片（确保时间与碳排先写入数据，再统一刷新UI）
                        if (typeof window.updateAllDataCards === 'function') {
                            window.updateAllDataCards();
                        } else if (typeof window.refreshLeanTimelineData === 'function') {
                            // 兜底：仅刷新时间卡片
                            window.refreshLeanTimelineData();
                        }

                        
                        // 更新当前建议卡片的显示状态
                        updateSuggestionCardStatus(suggestionTitle);
                    }
                    
                    // 显示成功消息
                    const button = event ? event.target : window.event?.target;
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> 已采纳';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                    
                    // 显示一键执行按钮
                    showExecuteAllButton();
                };
            }

            // 更新建议卡片状态的函数
            function updateSuggestionCardStatus(suggestionTitle) {
                const suggestionCard = document.querySelector(`[data-suggestion-title="${suggestionTitle}"]`);
                if (suggestionCard) {
                    suggestionCard.classList.add('accepted');
                    const button = suggestionCard.querySelector('.btn-success');
                    if (button) {
                        button.innerHTML = '<i class="fas fa-check"></i> 已采纳';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                }
            }



            // 重写咨询AI建议函数
            const originalConsultAIForSuggestion = window.consultAIForSuggestion;
            if (originalConsultAIForSuggestion) {
                window.consultAIForSuggestion = function(suggestionTitle, suggestionDesc) {
                    // 设置当前咨询的建议信息
                    window.currentConsultSuggestion = {
                        title: suggestionTitle,
                        description: suggestionDesc
                    };
                    
                    // 复用现有的AI模态框
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    // 设置建议咨询的内容
                    selectedDataDiv.innerHTML = `
                        <div class="suggestion-consult-header">
                            <h4><i class="fas fa-lightbulb text-warning"></i> 建议咨询: ${suggestionTitle}</h4>
                            <div class="suggestion-description">
                                <p><strong>建议内容：</strong></p>
                                <p class="text-muted">${suggestionDesc}</p>
                            </div>
                        </div>
                        
                        <div class="ai-consult-guide">
                            <h5><i class="fas fa-robot text-primary"></i> AI助手可以帮您：</h5>
                            <ul class="consult-options">
                                <li><i class="fas fa-check-circle text-success"></i> 分析建议的可行性和风险</li>
                                <li><i class="fas fa-list-ol text-info"></i> 提供详细的实施步骤</li>
                                <li><i class="fas fa-chart-line text-warning"></i> 评估预期的改进效果</li>
                                <li><i class="fas fa-star text-primary"></i> 推荐相关的最佳实践</li>
                            </ul>
                        </div>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-comments"></i> 咨询对话</h5>
                            <div class="history-messages" id="historyMessages">
                                <div class="ai-welcome-message">
                                    <div class="message-avatar ai-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        您好！我是AI助手，针对「${suggestionTitle}」这个建议，请告诉我您想了解什么？我会为您提供专业的分析和建议。
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 设置模态框属性
                    modal.setAttribute('data-mode', 'suggestion-consult');
                    modal.setAttribute('data-suggestion-title', suggestionTitle);
                    modal.setAttribute('data-module', 'lean');
                    modal.setAttribute('data-emission-type', 'suggestion');
                    
                    // 显示模态框
                    modal.style.display = 'flex';
                    
                    // 清空并聚焦问题输入框
                    const questionInput = document.getElementById('aiQuestion');
                    questionInput.value = '';
                    questionInput.placeholder = '请输入您关于此建议的问题...';
                    setTimeout(() => {
                        questionInput.focus();
                    }, 300);
                };
            }
        })();

        // 生成个性化建议函数 - 使用真实AI API
        window.generatePersonalizedSuggestions = async function(area) {
            console.log('开始生成个性化建议:', area);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('找不到suggestionsContent元素');
                return;
            }

            // 显示加载状态
            suggestionsDiv.innerHTML = `
                <div class="loading-suggestions">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>AI正在分析${area}领域，生成个性化优化建议...</p>
                </div>
            `;

            try {
                // 获取当前文档和产品信息
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);
                
                console.log('产品信息:', {
                    productType,
                    productTypeName,
                    documentContentLength: documentContent.length,
                    supplementDataKeys: Object.keys(supplementData)
                });

                // 准备子模块映射与基线（来自全局analysisData）
                const analysisData = window.analysisData || {};
                const carbonMapCN = {
                    procurement: '原料采购',
                    manufacturing: '生产制造',
                    logistics: '物流运输',
                    usage: '产品使用',
                    recycling: '回收处理',
                    decomposition: '自然降解'
                };
                const timeMapCN = {
                    procurement: '原料采购',
                    manufacturing: '生产制造',
                    logistics: '物流运输',
                    usage: '产品使用',
                    recycling: '回收处理',
                    decomposition: '自然降解'
                };
                const carbonBaseline = {
                    procurement: analysisData?.emissions?.procurement?.value ?? null,
                    manufacturing: analysisData?.emissions?.manufacturing?.value ?? null,
                    logistics: analysisData?.emissions?.logistics?.value ?? null,
                    usage: analysisData?.emissions?.usage?.value ?? null,
                    recycling: analysisData?.emissions?.recycling?.value ?? null,
                    decomposition: analysisData?.emissions?.decomposition?.value ?? null
                };
                const timeBaseline = {
                    procurement: analysisData?.timeline?.procurement?.duration ?? null,
                    manufacturing: analysisData?.timeline?.manufacturing?.duration ?? null,
                    logistics: analysisData?.timeline?.logistics?.duration ?? null,
                    usage: analysisData?.timeline?.usage?.duration ?? null,
                    recycling: analysisData?.timeline?.recycling?.duration ?? null,
                    decomposition: analysisData?.timeline?.decomposition?.duration ?? null
                };

                // 构建AI提示词 - 明确子模块与基线，并要求返回实施后的新值（更严格的数值规范、且不返回人类可读浓缩字段）
                const prompt = `作为碳排放管理和精益生产专家，请为${productTypeName}产品的${area}领域生成3个具体的优化建议。

【产品信息】：
产品类型：${productTypeName}
文档内容：${documentContent.substring(0, 300)}...
补充信息：${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}

【优化领域】：${area}

【子模块（键→中文名）】
碳排放：${JSON.stringify(carbonMapCN)}
时间：${JSON.stringify(timeMapCN)}

【当前基线（单位严格统一）】
碳排放（kgCO2e）：${JSON.stringify(carbonBaseline)}
时间（天）：${JSON.stringify(timeBaseline)}

请为每个建议提供以下信息（JSON格式）：
{
  "suggestions": [
    {
      "icon": "对应的FontAwesome图标类名",
      "title": "建议标题",
      "desc": "详细的建议描述（无需再返回任何人类可读的汇总字段）",
      "subProject": "子项目名称",
      // 必填：实施后的新值（必须包含所有键；单位与基线一致）
      "carbonAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      // 可选：若提供 improvements，必须与 after 数值严格一致（系统将验证），否则不要返回 improvements
      "carbonImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 }
    }
  ]
}

要求（务必严格遵守）：
1) 子模块与单位：所有 after 值必须与基线键一一对应，单位严格一致（碳排=kgCO2e，时间=天）。
2) 数值合法性：
   - timeAfter 各键必须是正整数（>=1）；不得返回负数/0/百分号/字符串。
   - carbonAfter 各键必须是非负数（>=0），可保留1位小数；不得返回负数/百分号/字符串。
   - 对于不受影响的键，将 after 设置为与基线相同的值。
3) 合理范围（请基于基线做保守估计并避免离谱值）：
   - timeAfter[k] 应在 [max(1, round(基线[k]*0.5)), round(基线[k]*1.3)] 范围内。
   - carbonAfter[k] 应在 [0, 基线[k]*1.3] 范围内。
4) 计算一致性（若给出 improvements）：
   - 使用公式 after = round(基线 * (1 - improvement/100))（时间四舍五入到天，碳排四舍五入到1位小数）。
   - improvement>0 表示减少（改进），<0 表示增加（权衡）。
   - 请确保 improvements 与 after 一致（例如 improvement=20，则 after≈基线*0.8）。
5) 只返回合法JSON；不要返回以下人类可读汇总字段：timeImprovement、carbonReduction（这些由系统通过前后对比自动计算）。
7) 请确保 carbonImprovements 和 timeImprovements 的键与“子模块（键→中文名）”完全对应，系统将据此展示“板块名: 减少/增加X%”。
6) 如果缺乏依据，请将 after 设置为基线值而不是臆测。`;

                console.log('AI提示词:', prompt);

                // 调用真实AI API
                console.log('开始调用AI API...');
                const response = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-ai/DeepSeek-V3',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.error('AI API响应错误:', response.status, response.statusText);
                    throw new Error('AI API调用失败');
                }

                const data = await response.json();
                console.log('AI API响应数据:', data);
                const aiResponse = data.choices[0].message.content;
                console.log('AI返回内容:', aiResponse);

                // 解析AI返回的JSON
                let suggestions;
                try {
                    // 尝试提取JSON部分
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        console.log('提取的JSON:', jsonMatch[0]);
                        suggestions = JSON.parse(jsonMatch[0]);
                        console.log('解析后的建议:', suggestions);
                        
                        // 验证数据格式
                        if (suggestions.suggestions && Array.isArray(suggestions.suggestions)) {
                            suggestions.suggestions.forEach((suggestion, index) => {
                                // 确保有改进百分比数据
                                if (!suggestion.carbonImprovements || !suggestion.timeImprovements) {
                                    console.warn(`建议${index + 1}缺少改进百分比数据，使用默认值`);
                                    suggestion.carbonImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 8,
                                        usage: 20,
                                        recycling: 5,
                                        decomposition: 2
                                    };
                                    suggestion.timeImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 5,
                                        usage: 8,
                                        recycling: 12,
                                        decomposition: 5
                                    };
                                }
                                
                                // 验证百分比范围
                                Object.keys(suggestion.carbonImprovements).forEach(phase => {
                                    if (suggestion.carbonImprovements[phase] < -50 || suggestion.carbonImprovements[phase] > 100) {
                                        suggestion.carbonImprovements[phase] = Math.max(-50, Math.min(100, suggestion.carbonImprovements[phase]));
                                    }
                                });
                                
                                Object.keys(suggestion.timeImprovements).forEach(phase => {
                                    if (suggestion.timeImprovements[phase] < -50 || suggestion.timeImprovements[phase] > 100) {
                                        suggestion.timeImprovements[phase] = Math.max(-50, Math.min(100, suggestion.timeImprovements[phase]));
                                    }
                                });
                            });
                        }
                    } else {
                        console.error('未找到JSON格式内容');
                        throw new Error('无法解析AI返回的JSON');
                    }
                } catch (parseError) {
                    console.error('AI返回内容解析失败:', parseError);
                    console.error('AI返回内容:', aiResponse);
                    throw parseError;
                }

                // 渲染建议
                console.log('开始渲染建议:', area, suggestions);
                
                // 缓存建议供后续使用
                if (!window.lastSuggestionsCache) window.lastSuggestionsCache = {};
                window.lastSuggestionsCache[area] = suggestions.suggestions || suggestions;
                
                renderSuggestions(area, suggestions.suggestions || suggestions);

            } catch (error) {
                console.error('AI API调用失败:', error);
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI服务暂不可用，请稍后重试。</div>';
                }
            }
        }

        // 计算时间变化（基于AI结果）
        function computeTimeChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const timeline = analysisData.timeline || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // 以“当前值”为基线进行对比，而不是 originalDuration，避免受到历史采纳影响
            const beforeTotal = keys.reduce((sum, k) => sum + (timeline[k]?.duration || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: '时间: 无变化' };
            }
            // 优先使用 timeAfter
            let afterTotal = 0;
            let hasAfter = suggestion && suggestion.timeAfter && typeof suggestion.timeAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const raw = suggestion.timeAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // 视为“新值（绝对值）”
                            normalized = raw;
                        } else if (raw === 0) {
                            // 不变
                            normalized = base;
                        } else {
                            // 负数：视为“相对变化（天）”
                            normalized = Math.max(1, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.timeImprovements && typeof suggestion.timeImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const pct = suggestion.timeImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(1, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: '时间: 无变化' };
            }
            const delta = Math.round(beforeTotal - afterTotal);
            if (delta > 0) {
                return { isImprovement: true, displayText: `时间: 减少 ${delta}天` };
            } else if (delta < 0) {
                return { isImprovement: false, displayText: `时间: 增加 ${Math.abs(delta)}天` };
            }
            return { isImprovement: true, displayText: '时间: 无变化' };
        }

        // 计算碳排放变化（基于AI结果）
        function computeCarbonChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // 以“当前值”为基线进行对比
            const beforeTotal = keys.reduce((sum, k) => sum + (emissions[k]?.value || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: '碳排放: 无变化' };
            }
            // 优先使用 carbonAfter
            let afterTotal = 0;
            const hasAfter = suggestion && suggestion.carbonAfter && typeof suggestion.carbonAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const raw = suggestion.carbonAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // 视为“新值（绝对值kgCO2e）”
                            normalized = Math.max(0, raw);
                        } else if (raw === 0) {
                            // 不变
                            normalized = base;
                        } else {
                            // 负数：视为“相对变化（kgCO2e）”，base + delta
                            normalized = Math.max(0, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.carbonImprovements && typeof suggestion.carbonImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const pct = suggestion.carbonImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(0, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: '碳排放: 无变化' };
            }
            const deltaPct = beforeTotal > 0 ? Math.round(((beforeTotal - afterTotal) / beforeTotal) * 100) : 0;
            if (deltaPct > 0) {
                return { isImprovement: true, displayText: `碳排放: 减少 ${deltaPct}%` };
            } else if (deltaPct < 0) {
                return { isImprovement: false, displayText: `碳排放: 增加 ${Math.abs(deltaPct)}%` };
            }
            return { isImprovement: true, displayText: '碳排放: 无变化' };
        }

        // 逐板块变化明细（碳排与时间）
        function computePhaseChangeDetails(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const timeline = analysisData.timeline || {};
            const carbonKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const timeKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const carbonLabel = {procurement:'原料采购',manufacturing:'生产制造',logistics:'物流运输',usage:'产品使用',recycling:'回收处理',decomposition:'自然降解'};
            const timeLabel = {procurement:'原料采购',manufacturing:'生产制造',logistics:'物流运输',usage:'产品使用',recycling:'回收处理',decomposition:'自然降解'};

            const carbonItems = carbonKeys.map(k => {
                const base = emissions[k]?.value ?? 0;
                let after;
                if (suggestion?.carbonAfter && typeof suggestion.carbonAfter[k] === 'number') {
                    const raw = suggestion.carbonAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(0, base + raw);
                } else if (suggestion?.carbonImprovements && typeof suggestion.carbonImprovements[k] === 'number') {
                    const pct = suggestion.carbonImprovements[k];
                    after = Math.max(0, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${carbonLabel[k]}: ${base}→${after} (${pctText})`;
            });

            const timeItems = timeKeys.map(k => {
                const base = timeline[k]?.duration ?? 0;
                let after;
                if (suggestion?.timeAfter && typeof suggestion.timeAfter[k] === 'number') {
                    const raw = suggestion.timeAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(1, base + raw);
                } else if (suggestion?.timeImprovements && typeof suggestion.timeImprovements[k] === 'number') {
                    const pct = suggestion.timeImprovements[k];
                    after = Math.max(1, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${timeLabel[k]}: ${base}→${after} (${pctText})`;
            });

            return {
                carbonHtml: carbonItems.join('、 '),
                timeHtml: timeItems.join('、 ')
            };
        }

        // 渲染建议函数
        window.renderSuggestions = function(area, suggestions) {
            console.log('开始渲染建议:', area, suggestions);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('找不到suggestionsContent元素');
                return;
            }

            if (!suggestions || suggestions.length === 0) {
                suggestionsDiv.innerHTML = '<div class="no-suggestions">暂无优化建议</div>';
                return;
            }

            const suggestionsHTML = suggestions.map((suggestion, index) => {
                const isAccepted = window.acceptedSuggestions.includes(suggestion.title);
                
                // 计算时间改进（基于AI结果对比基线）
                const timeEffect = computeTimeChangeSummary(suggestion);
                const carbonEffect = computeCarbonChangeSummary(suggestion);
                const phaseDetails = computePhaseChangeDetails(suggestion);
                
                return `
                    <div class="suggestion-card ${isAccepted ? 'accepted' : ''}" data-index="${index}" data-suggestion-title="${suggestion.title}">
                        <div class="suggestion-header">
                            <div class="suggestion-icon">
                                <i class="${suggestion.icon}"></i>
                            </div>
                            <div class="suggestion-title">
                                <h4>${suggestion.title}</h4>
                                <div class="improvement-metrics">
                                    <div class="metric time-metric ${timeEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-clock"></i>
                                        <span>${timeEffect.displayText}</span>
                                    </div>
                                    <div class="metric carbon-metric ${carbonEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-leaf"></i>
                                        <span>${carbonEffect.displayText}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <p class="suggestion-desc">${suggestion.desc}</p>
                            <div class="suggestion-details">
                                <span class="sub-project">子项目: ${suggestion.subProject}</span>
                                <div class="phase-details" style="margin-top:8px; font-size: 12px; color:#4b5563; line-height:1.6;">
                                    <div><strong>碳排放</strong>：${phaseDetails.carbonHtml}</div>
                                    <div><strong>时间</strong>：${phaseDetails.timeHtml}</div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-actions">
                            ${isAccepted ? 
                                '<div class="accepted-status"><i class="fas fa-check"></i> 已采纳</div>' :
                                `<button class="btn btn-success btn-sm" onclick="acceptSuggestion('${suggestion.title}', event)">
                                    <i class="fas fa-check"></i> 采纳建议
                                </button>`
                            }
                            <button class="btn btn-primary btn-sm" onclick="askAI('${suggestion.title}', '${area}')">
                                <i class="fas fa-robot"></i> 询问AI
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            suggestionsDiv.innerHTML = suggestionsHTML;
            console.log('建议渲染完成');
        };

        // 解析改进效果字符串
        function parseImprovementEffect(effectString, type) {
            if (!effectString) {
                return { 
                    isImprovement: true, 
                    value: '0%',
                    displayText: type === 'time' ? '时间: 无变化' : '碳排放: 无变化'
                };
            }
            
            // 检查是否包含"减少"或"增加"
            const isImprovement = effectString.includes('减少') || effectString.includes('降低');
            const isTradeoff = effectString.includes('增加') || effectString.includes('提高');
            
            // 提取数值和单位
            const match = effectString.match(/(\d+(?:\.\d+)?)([%个月天小时])/);
            if (match) {
                const value = parseFloat(match[1]);
                const unit = match[2];
                
                // 如果数值为负数，自动转换为"增加"
                if (value < 0) {
                    const absValue = Math.abs(value);
                    const displayText = type === 'time' ? 
                        `时间: 增加 ${absValue}${unit}` : 
                        `碳排放: 增加 ${absValue}${unit}`;
                    
                    return {
                        isImprovement: false,
                        value: absValue + unit,
                        displayText: displayText
                    };
                } else {
                    const displayText = type === 'time' ? 
                        `时间: 减少 ${value}${unit}` : 
                        `碳排放: 减少 ${value}${unit}`;
                    
                    return {
                        isImprovement: true,
                        value: value + unit,
                        displayText: displayText
                    };
                }
            }
            
            // 如果没有匹配到数值，尝试从文本中提取信息
            let displayText = '';
            if (type === 'time') {
                if (isImprovement) {
                    displayText = `时间: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `时间: ${effectString}`;
                } else {
                    displayText = `时间: ${effectString}`;
                }
            } else {
                if (isImprovement) {
                    displayText = `碳排放: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `碳排放: ${effectString}`;
                } else {
                    displayText = `碳排放: ${effectString}`;
                }
            }
            
            return { 
                isImprovement: isImprovement || !isTradeoff, 
                value: effectString,
                displayText: displayText
            };
        }

        // 备用建议生成函数 - 增加改进百分比字段
        window.getFallbackSuggestions = function(area, productTypeName) {
            const fallbackSuggestions = {
                '材料选择': [
                    {
                        icon: 'fas fa-seedling',
                        title: `${productTypeName}生物基材料替代`,
                        timeImprovement: '减少25%加工时间',
                        carbonReduction: '降低60%材料排放',
                        desc: `针对${productTypeName}特点，采用生物降解材料替代传统材料，减少化学处理工序和环境影响`,
                        subProject: '生物基材料选择',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 30,
                            recycling: 8,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 20,
                            logistics: 5,
                            usage: 10,
                            recycling: 12,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName}循环材料应用`,
                        timeImprovement: '节省30%制备时间',
                        carbonReduction: '减少50%原料排放',
                        desc: `建立${productTypeName}闭环材料循环体系，实现废料再利用，降低原材料采购成本`,
                        subProject: '回收材料应用',
                        carbonImprovements: {
                            procurement: 25,
                            manufacturing: 10,
                            logistics: 5,
                            usage: 15,
                            recycling: 20,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 18,
                            manufacturing: 12,
                            logistics: 5,
                            usage: 8,
                            recycling: 25,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-feather-alt',
                        title: `${productTypeName}轻量化设计`,
                        timeImprovement: '缩短20%运输时间',
                        carbonReduction: '降低40%物流排放',
                        desc: `采用轻量化材料和结构设计，减少${productTypeName}运输成本和排放`,
                        subProject: '轻量化结构设计',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 10,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 5,
                            recycling: 8,
                            decomposition: 3
                        }
                    }
                ],
                '生产工艺': [
                    {
                        icon: 'fas fa-cogs',
                        title: `${productTypeName}精益生产流程`,
                        timeImprovement: '缩短35%生产周期',
                        carbonReduction: '降低40%工艺排放',
                        desc: `针对${productTypeName}特点实施精益生产理念，消除浪费和冗余工序`,
                        subProject: '精益生产流程',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 8,
                            usage: 15,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 12,
                            manufacturing: 30,
                            logistics: 5,
                            usage: 8,
                            recycling: 10,
                            decomposition: 3
                        }
                    },
                    {
                        icon: 'fas fa-bolt',
                        title: `${productTypeName}清洁能源转换`,
                        timeImprovement: '减少15%能耗时间',
                        carbonReduction: '降低70%能源排放',
                        desc: `为${productTypeName}生产采用太阳能、风能等清洁能源替代传统能源`,
                        subProject: '清洁能源转换',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 60,
                            logistics: 10,
                            usage: 20,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 3,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-fire',
                        title: `${productTypeName}余热回收系统`,
                        timeImprovement: '提升30%能效',
                        carbonReduction: '减少35%热能损失',
                        desc: `安装${productTypeName}余热回收系统，提高能源利用效率`,
                        subProject: '余热回收系统',
                        carbonImprovements: {
                            procurement: 3,
                            manufacturing: 25,
                            logistics: 5,
                            usage: 10,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 20,
                            logistics: 2,
                            usage: 5,
                            recycling: 10,
                            decomposition: 2
                        }
                    }
                ],
                '供应链管理': [
                    {
                        icon: 'fas fa-map',
                        title: `${productTypeName}就近采购策略`,
                        timeImprovement: '减少40%运输时间',
                        carbonReduction: '降低45%物流排放',
                        desc: `为${productTypeName}优先选择本地供应商，减少运输距离和时间`,
                        subProject: '就近采购策略',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 8,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 25,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-chart-line',
                        title: `${productTypeName}数字化管理平台`,
                        timeImprovement: '提升50%决策效率',
                        carbonReduction: '减少35%管理排放',
                        desc: `建立${productTypeName}数字化管理平台，实现数据驱动决策`,
                        subProject: '数字化管理平台',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 25,
                            usage: 10,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 30,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 15,
                            recycling: 20,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-users',
                        title: `${productTypeName}敏捷团队协作`,
                        timeImprovement: '减少45%沟通时间',
                        carbonReduction: '降低30%协调成本',
                        desc: `采用敏捷工作方法，提高${productTypeName}团队协作效率`,
                        subProject: '敏捷团队协作',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 12,
                            logistics: 8,
                            usage: 5,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 20,
                            manufacturing: 18,
                            logistics: 10,
                            usage: 10,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                '产品设计': [
                    {
                        icon: 'fas fa-microchip',
                        title: `${productTypeName}智能化升级`,
                        timeImprovement: '减少45%处理时间',
                        carbonReduction: '降低40%碳排放',
                        desc: `为${productTypeName}采用AI和物联网技术优化流程，实现智能监控`,
                        subProject: '智能传感器集成',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 30,
                            recycling: 10,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 15,
                            usage: 20,
                            recycling: 15,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-robot',
                        title: `${productTypeName}自动化改造`,
                        timeImprovement: '缩短55%操作时间',
                        carbonReduction: '减少35%能耗',
                        desc: `引入${productTypeName}机器人和自动化产线，减少人工干预`,
                        subProject: '自动化控制系统',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 30,
                            logistics: 15,
                            usage: 20,
                            recycling: 12,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 15,
                            usage: 15,
                            recycling: 18,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-brain',
                        title: `${productTypeName}算法优化`,
                        timeImprovement: '提升65%计算效率',
                        carbonReduction: '降低30%服务器排放',
                        desc: `优化${productTypeName}核心算法，减少计算资源需求`,
                        subProject: '机器学习算法优化',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                '包装方案': [
                    {
                        icon: 'fas fa-box-open',
                        title: `${productTypeName}简约包装设计`,
                        timeImprovement: '减少30%包装时间',
                        carbonReduction: '降低50%包装材料',
                        desc: `为${productTypeName}采用简约包装设计，减少材料使用`,
                        subProject: '简约包装设计',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 5,
                            recycling: 15,
                            decomposition: 8
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 20,
                            decomposition: 10
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName}可回收包装材料`,
                        timeImprovement: '节省25%处理时间',
                        carbonReduction: '减少40%包装排放',
                        desc: `使用${productTypeName}可回收包装材料，建立包装回收体系`,
                        subProject: '可回收包装材料',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 25,
                            decomposition: 12
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 15,
                            usage: 2,
                            recycling: 30,
                            decomposition: 15
                        }
                    },
                    {
                        icon: 'fas fa-leaf',
                        title: `${productTypeName}绿色包装认证`,
                        timeImprovement: '提升20%品牌价值',
                        carbonReduction: '降低25%环境影响',
                        desc: `为${productTypeName}获得绿色包装认证，提升品牌形象`,
                        subProject: '绿色包装认证',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 3,
                            logistics: 15,
                            usage: 8,
                            recycling: 18,
                            decomposition: 10
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 3,
                            logistics: 10,
                            usage: 5,
                            recycling: 22,
                            decomposition: 12
                        }
                    }
                ]
            };

            return fallbackSuggestions[area] || fallbackSuggestions['产品设计'];
        }

        // 更新采纳建议后的数据变化函数
        window.updateDataAfterAcceptance = function(suggestionTitle) {
            // 查找对应的建议数据
            let suggestionData = null;
            if (window.lastSuggestionsCache && window.currentSelectedArea) {
                const suggestions = window.lastSuggestionsCache[window.currentSelectedArea];
                if (suggestions) {
                    suggestionData = suggestions.find(s => s.title === suggestionTitle);
                }
            }
            
            if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                // 更新碳排放数据
                if (window.analysisData && window.analysisData.emissions) {
                    Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                        if (window.analysisData.emissions[phase]) {
                            const improvement = suggestionData.carbonImprovements[phase];
                            const currentValue = window.analysisData.emissions[phase].value;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.emissions[phase].value = newValue;
                            
                            // 更新显示
                            const emissionCard = document.querySelector(`[onclick*="${phase}"]`);
                            if (emissionCard) {
                                const valueElement = emissionCard.querySelector('.emission-value');
                                if (valueElement) {
                                    valueElement.textContent = newValue;
                                    valueElement.style.color = '#28a745'; // 绿色表示改进
                                }

                            }
                        }
                    });
                }
                
                // 更新时间数据
                if (window.analysisData && window.analysisData.timeline) {
                    Object.keys(suggestionData.timeImprovements).forEach(phase => {
                        if (window.analysisData.timeline[phase]) {
                            const improvement = suggestionData.timeImprovements[phase];
                            const currentValue = window.analysisData.timeline[phase].duration;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.timeline[phase].duration = newValue;
                            window.analysisData.timeline[phase].improved = true;
                            window.analysisData.timeline[phase].reductionAmount = currentValue - newValue;
                            
                            // 更新显示
                            const timelineCard = document.querySelector(`[data-phase="${phase}"]`);
                            if (timelineCard) {
                                const valueElement = timelineCard.querySelector('.duration-value');
                                if (valueElement) {
                                    valueElement.textContent = `${newValue} (-${currentValue - newValue})`;
                                    valueElement.classList.add('improved');
                                    valueElement.style.color = '#28a745'; // 绿色表示改进
                                }
                            }
                        }
                    });
                }
            }
        };

        // 累积计算所有已采纳建议的效果
        window.calculateCumulativeImprovements = function() {
            if (!window.acceptedSuggestions || window.acceptedSuggestions.length === 0) {
                return { carbon: {}, time: {} };
            }

            const cumulativeCarbon = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };
            
            const cumulativeTime = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };

            // 遍历所有已采纳的建议
            window.acceptedSuggestions.forEach(suggestionTitle => {
                // 在所有缓存中查找建议数据
                Object.keys(window.acceptedSuggestionsByArea || {}).forEach(area => {
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        const suggestions = window.lastSuggestionsCache[area];
                        const suggestionData = suggestions.find(s => s.title === suggestionTitle);
                        
                        if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                            // 累积碳排放改进
                            Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                                if (cumulativeCarbon.hasOwnProperty(phase)) {
                                    cumulativeCarbon[phase] += suggestionData.carbonImprovements[phase];
                                }
                            });
                            
                            // 累积时间改进
                            Object.keys(suggestionData.timeImprovements).forEach(phase => {
                                if (cumulativeTime.hasOwnProperty(phase)) {
                                    cumulativeTime[phase] += suggestionData.timeImprovements[phase];
                                }
                            });
                        }
                    }
                });
            });

            return { carbon: cumulativeCarbon, time: cumulativeTime };
        };

        // 更新所有数据卡片显示
        window.updateAllDataCards = function() {
            const improvements = window.calculateCumulativeImprovements();
            
            // 先更新碳排放与时间数据，再统一刷新UI，确保显示的是最新数据
            // 更新碳排放数据卡片（写入 originalValue 以便卡片重渲染时显示“新值 (±差)”）
            if (window.analysisData && window.analysisData.emissions) {
                const totalBefore = Object.values(window.analysisData.emissions).reduce((s, d) => s + (d.originalValue || d.value), 0);
                Object.keys(improvements.carbon).forEach(phase => {
                    if (window.analysisData.emissions[phase]) {
                        const originalValue = window.analysisData.emissions[phase].originalValue || window.analysisData.emissions[phase].value;
                        const improvement = improvements.carbon[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // 更新数据
                        window.analysisData.emissions[phase].value = newValue;
                        window.analysisData.emissions[phase].originalValue = originalValue;
                        // 此处不直接更新DOM，交由 refreshLeanTimelineData()+生成卡片函数统一渲染
                    }
                });
                const totalAfter = Object.values(window.analysisData.emissions).reduce((s, d) => s + d.value, 0);
                window.__combinedCarbon__ = { before: Math.round(totalBefore), after: Math.round(totalAfter) };
            }
            
            // 更新时间数据卡片
            if (window.analysisData && window.analysisData.timeline) {
                const totalBeforeTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + (d.originalDuration || d.duration), 0);
                Object.keys(improvements.time).forEach(phase => {
                    if (window.analysisData.timeline[phase]) {
                        const originalValue = window.analysisData.timeline[phase].originalDuration || window.analysisData.timeline[phase].duration;
                        const improvement = improvements.time[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // 更新数据
                        window.analysisData.timeline[phase].duration = newValue;
                        window.analysisData.timeline[phase].originalDuration = originalValue;
                        window.analysisData.timeline[phase].improved = improvement > 0;
                        window.analysisData.timeline[phase].reductionAmount = originalValue - newValue;
                        
                        // DOM更新将通过refreshLeanTimelineData()统一处理
                    }
                });
                const totalAfterTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + d.duration, 0);
                window.__combinedTime__ = { before: Math.round(totalBeforeTime), after: Math.round(totalAfterTime) };
            }
            
            // 最后刷新Lean模块的时间与碳排数据显示（此时analysisData已更新）
            if (typeof refreshLeanTimelineData === 'function') {
                refreshLeanTimelineData();
            }
            if (typeof refreshLeanEmissionData === 'function') {
                refreshLeanEmissionData();
            }
        };

        // 深度分析AI调用函数 - 使用真实AI API
        async function callSuggestionAI(question, suggestion) {
            try {
                // 获取当前文档和产品信息
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);

                // 构建完整AI提示词（包含上下文，但要求回答简洁）
                const prompt = `作为碳排放专家，基于以下完整信息回答问题："${question}"

【产品信息】：
产品类型：${productTypeName}
文档摘要：${documentContent.substring(0, 300)}...

【补充数据】：
${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join('\n')}

【当前建议】：
标题：${suggestion.title}
描述：${suggestion.description}

要求：基于以上完整信息回答，但回答要简洁明了，不超过60字，重点说明与问题相关的核心要点。`;

                // 控制台调试日志 - AI输入
                console.log('=================== AI建议咨询调用 ===================');
                console.log('🔹 用户问题:', question);
                console.log('🔹 咨询建议:', suggestion);
                console.log('🔹 产品类型:', productTypeName);
                console.log('🔹 文档内容长度:', documentContent.length, '字符');
                console.log('🔹 补充数据:', supplementData);
                console.log('🔹 API端点:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('🔹 模型:', 'deepseek-ai/DeepSeek-V3');
                console.log('📤 完整AI提示词:');
                console.log(prompt);
                const requestBody = {
                    model: 'deepseek-ai/DeepSeek-V3',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 200, // 减少token数量以控制回答长度
                    temperature: 0.7
                };
                console.log('📤 请求参数:');
                console.log(JSON.stringify(requestBody, null, 2));

                // 调用真实AI API
                const response = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // 控制台调试日志 - API响应
                console.log('📥 API响应状态:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('❌ AI API调用失败:', response.status, response.statusText);
                    throw new Error('AI API调用失败');
                }

                const data = await response.json();
                console.log('📥 AI完整响应数据:');
                console.log(JSON.stringify(data, null, 2));
                
                const aiResponse = data.choices[0].message.content;
                console.log('📄 AI返回内容:');
                console.log(aiResponse);
                console.log('📊 回答字数:', aiResponse.length);
                console.log('===============================================');
                
                return aiResponse;
            } catch (error) {
                console.error('深度分析AI调用错误:', error);
                throw error;
            }
        }

        // 备用深度分析AI回复（当真实AI API不可用时）
        function generateFallbackSuggestionAIResponse(question, suggestion) {
            const productTypeName = getDocumentTypeName(window.currentAnalysis?.documentType || 'general');
            
            return `🤖 **AI深度分析** - ${suggestion.title}

基于您的问题"${question}"，我为您提供以下专业分析：

**产品背景**：
当前分析的产品类型：${productTypeName}

**核心要点**：
${suggestion.description}

**专业建议**：
1. 建议先进行可行性评估和试点测试
2. 制定详细的实施计划和时间表
3. 建立监控和评估机制
4. 注重员工培训和参与

**预期收益**：
- 时间效率: ${suggestion.timeImprovement || '显著提升'}
- 碳排放: ${suggestion.carbonReduction || '大幅减少'}
- 长期价值: 提升企业竞争力

**注意**：当前为备用回复模式，建议在网络正常时重新询问以获得更精准的AI分析。

如需更详细的分析，请具体询问可行性、实施步骤、效果评估或风险评估等方面的问题。`;
        }

        // 渲染对话历史
        function renderChatHistory(moduleType, emissionType) {
            const history = window.aiChatHistory[moduleType] || [];
            const relevantHistory = history.filter(item => item.emissionType === emissionType);
            
            if (relevantHistory.length === 0) {
                return '<p class="no-history">暂无对话记录，开始您的第一次询问吧！</p>';
            }
            
            return relevantHistory.map(item => `
                <div class="history-item">
                    <div class="history-question">
                        <i class="fas fa-user"></i> <strong>问：</strong>${item.question}
                    </div>
                    <div class="history-answer">
                        <i class="fas fa-robot"></i> <strong>答：</strong>${item.answer}
                    </div>
                    <div class="history-time">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // 保存AI对话记录
        function saveAIChatHistory(moduleType, emissionType, question, answer) {
            if (!window.aiChatHistory[moduleType]) {
                window.aiChatHistory[moduleType] = [];
            }
            
            window.aiChatHistory[moduleType].push({
                emissionType: emissionType,
                question: question,
                answer: answer,
                timestamp: new Date().toLocaleString()
            });
        }

        // 更新对话历史显示
        function updateChatHistoryDisplay(moduleType, emissionType) {
            const historyMessages = document.getElementById('historyMessages');
            if (historyMessages) {
                historyMessages.innerHTML = renderChatHistory(moduleType, emissionType);
            }
        }

        // 继续对话功能
        function continueConversation() {
            const aiQuestion = document.getElementById('aiQuestion');
            const aiResponse = document.getElementById('aiResponse');
            if (aiQuestion) {
                aiQuestion.value = '';
                aiQuestion.focus();
            }
            if (aiResponse) {
                aiResponse.style.display = 'none';
            }
        }

        console.log('碳排放管理系统改进功能已加载');

        // ==================== Scrum模块功能 ====================
        
        // Scrum任务数据
        window.scrumTasks = {
            todo: [
                {
                    id: 'task-1',
                    title: '实施绿色供应商筛选',
                    description: '建立供应商环保评估标准，优先选择低碳排放的供应商',
                    assignee: '张明',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: '2024-03-01',
                    endDate: '2024-03-05',
                    tags: ['采购优化', '供应链']
                },
                {
                    id: 'task-2',
                    title: '优化物流运输路线',
                    description: '重新规划运输路线，减少运输距离和碳排放',
                    assignee: '李华',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: '2024-03-02',
                    endDate: '2024-03-04',
                    tags: ['物流优化']
                },
                {
                    id: 'task-3',
                    title: '导入生物基材料',
                    description: '采用生物降解材料替代传统材料，减少环境影响',
                    assignee: '王芳',
                    priority: 'high',
                    storyPoints: 13,
                    startDate: '2024-03-03',
                    endDate: '2024-03-10',
                    tags: ['材料选择', '环保']
                },
                {
                    id: 'task-4',
                    title: '建立余热回收系统',
                    description: '安装余热回收设备，提高能源利用效率',
                    assignee: '陈强',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: '2024-03-06',
                    endDate: '2024-03-12',
                    tags: ['能源优化']
                }
            ],
            'in-progress': [
                {
                    id: 'task-5',
                    title: '清洁能源转换',
                    description: '将生产线改为使用太阳能和风能',
                    assignee: '刘洋',
                    priority: 'high',
                    storyPoints: 21,
                    startDate: '2024-02-26',
                    endDate: '2024-03-08',
                    progress: 60,
                    tags: ['清洁能源']
                },
                {
                    id: 'task-6',
                    title: '精益生产流程改进',
                    description: '消除生产浪费，优化工艺流程',
                    assignee: '赵敏',
                    priority: 'medium',
                    storyPoints: 13,
                    startDate: '2024-02-28',
                    endDate: '2024-03-06',
                    progress: 80,
                    tags: ['生产优化']
                },
                {
                    id: 'task-7',
                    title: '智能监控系统集成',
                    description: '部署IoT传感器实现实时监控',
                    assignee: '孙杰',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: '2024-03-01',
                    endDate: '2024-03-05',
                    progress: 40,
                    tags: ['智能化']
                }
            ],
            done: [
                {
                    id: 'task-8',
                    title: '环保包装材料采购',
                    description: '采购可回收包装材料，建立包装回收体系',
                    assignee: '周琳',
                    priority: 'low',
                    storyPoints: 5,
                    startDate: '2024-02-20',
                    endDate: '2024-02-25',
                    completedDate: '2024-02-25',
                    tags: ['包装优化']
                },
                {
                    id: 'task-9',
                    title: '团队环保培训',
                    description: '对全体员工进行碳排放管理培训',
                    assignee: '吴琼',
                    priority: 'medium',
                    storyPoints: 3,
                    startDate: '2024-02-15',
                    endDate: '2024-02-18',
                    completedDate: '2024-02-18',
                    tags: ['培训']
                },
                {
                    id: 'task-10',
                    title: '碳排放基线测量',
                    description: '建立产品碳排放基线数据',
                    assignee: '马强',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: '2024-02-10',
                    endDate: '2024-02-15',
                    completedDate: '2024-02-15',
                    tags: ['数据收集']
                },
                {
                    id: 'task-11',
                    title: '供应商评估标准制定',
                    description: '制定环保供应商评估标准和流程',
                    assignee: '黄丽',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: '2024-02-12',
                    endDate: '2024-02-16',
                    completedDate: '2024-02-16',
                    tags: ['标准制定']
                },
                {
                    id: 'task-12',
                    title: '环保认证申请',
                    description: '申请ISO 14001环境管理体系认证',
                    assignee: '林峰',
                    priority: 'low',
                    storyPoints: 3,
                    startDate: '2024-02-08',
                    endDate: '2024-02-12',
                    completedDate: '2024-02-12',
                    tags: ['认证']
                }
            ],
            __auto: false,          // 标记为非自动生成（预设数据）
            __aiGenerated: false    // 标记为非AI生成
        };

        // 团队成员数据（简化版，仅用于头像显示）
        window.teamMembers = [
            { name: '张明', avatar: '👨‍💼' },
            { name: '李华', avatar: '🚛' },
            { name: '王芳', avatar: '👩‍🔬' },
            { name: '陈强', avatar: '🔧' },
            { name: '刘洋', avatar: '⚡' },
            { name: '赵敏', avatar: '👩‍🏭' },
            { name: '孙杰', avatar: '💻' },
            { name: '周琳', avatar: '📦' },
            { name: '吴琼', avatar: '👩‍🏫' },
            { name: '马强', avatar: '📊' },
            { name: '黄丽', avatar: '📋' },
            { name: '林峰', avatar: '🎯' }
        ];

        // [ADDED] 根据上下文自动生成Scrum任务计划（AI优先，失败时使用规则回退）
        window.ensureScrumPlanReady = async function() {
            try {
                // 已生成且无需刷新则跳过（只有AI生成的任务才跳过）
                if (window.scrumTasks && window.scrumTasks.__auto === true && window.scrumTasks.__aiGenerated === true && !window.__scrumNeedsRefresh) {
                    return;
                }

                // 显示加载占位
                const kanbanContainer = document.getElementById('kanban-view');
                if (kanbanContainer) {
                    kanbanContainer.querySelectorAll('.task-list').forEach(list => list.innerHTML = '<div class="loading-suggestions" style="padding:20px 10px;">\n                        <i class="fas fa-spinner fa-spin"></i> 正在基于文档与分析结果自动生成Sprint任务...\n                    </div>');
                }

                await window.generateScrumPlanFromContext();
                window.__scrumNeedsRefresh = false;
            } catch (e) {
                console.error('生成Scrum计划失败:', e);
            }
        };

        window.generateScrumPlanFromContext = async function() {
            console.log('🚀 =================== Scrum AI 任务计划生成开始 ===================');
            
            // 汇总上下文
            const rawDocContent = (window.documentAIContent && window.documentAIContent.content) ? window.documentAIContent.content.slice(0, 2000) : '';
            // 清理文档内容中的多余换行符和空白字符
            const docContent = rawDocContent
                .replace(/\n{3,}/g, '\n\n')  // 将3个以上连续换行替换为2个
                .replace(/[ \t]+\n/g, '\n')   // 删除行尾空白
                .replace(/\n[ \t]+/g, '\n')   // 删除行首空白
                .replace(/[ \t]{2,}/g, ' ')   // 将多个空格替换为单个空格
                .trim();
            
            const supplementData = window.supplementData || {};
            const productType = window.currentAnalysis?.documentType || 'general';
            const productTypeName = (typeof getDocumentTypeName === 'function') ? getDocumentTypeName(productType) : productType;
            const analysis = window.analysisData || {};
            const accepted = Array.isArray(window.acceptedSuggestions) ? window.acceptedSuggestions : [];
            const acceptedByArea = window.acceptedSuggestionsByArea || {};

            // 将缓存建议拍平以便在提示中引用
            const cachedAreas = Object.keys(window.lastSuggestionsCache || {});
            const cachedSuggestions = cachedAreas.reduce((acc, area) => {
                const items = (window.lastSuggestionsCache[area] || []).map(s => ({ area, title: s.title, desc: s.desc }));
                return acc.concat(items);
            }, []);

            // 打印收集到的上下文数据
            console.log('📋 收集的上下文数据:');
            console.log('  📄 文档内容长度:', docContent.length);
            console.log('  🏷️ 产品类型:', productTypeName);
            console.log('  📊 分析数据:', analysis);
            console.log('  ✅ 已采纳建议:', accepted);
            console.log('  🎯 按领域分组的建议:', acceptedByArea);
            console.log('  💡 缓存建议数量:', cachedSuggestions.length);
            console.log('  📝 补充信息:', supplementData);

            // 构造提示词
            const prompt = `你是敏捷项目经理。请基于以下真实上下文，为当前产品生成一个可执行的Sprint任务计划（JSON）。\n\n` +
            `【产品类型】${productTypeName}\n` +
            `【文档摘要】${docContent}\n` +
            `【补充信息】${JSON.stringify(supplementData)}\n` +
            `【当前分析数据-碳排】${JSON.stringify(analysis.emissions || {})}\n` +
            `【当前分析数据-时间】${JSON.stringify(analysis.timeline || {})}\n` +
            `【已采纳建议】${JSON.stringify(accepted)}\n` +
            `【建议缓存摘要】${JSON.stringify(cachedSuggestions).slice(0, 2000)}\n\n` +
            `请输出严格JSON格式的中文任务计划：{\n  "sprint": {"name": "Sprint 1", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"},\n  "tasks": [\n    {"title":"中文任务名称","desc":"中文任务描述","assignee":"(可为空)","priority":"high|medium|low","storyPoints":8,"startDate":"YYYY-MM-DD","endDate":"YYYY-MM-DD","status":"todo|in-progress|done","tags":["材料选择"],"relatedSuggestion":"(若有)"}\n  ]\n}\n` +
            `要求：\n1) 所有任务标题(title)和描述(desc)必须使用中文；\n2) 任务需可执行，覆盖关键已采纳建议或高影响板块；\n3) 所有时间以日为最小单位，任务持续时间1-30天；\n4) startDate和endDate必须是有效的YYYY-MM-DD格式日期；\n5) 例如：3天任务从今天开始，持续到第3天；7天任务从开始日期持续到第7天；\n6) 如无明确负责人，assignee留空；\n7) 严格返回JSON，不要多余文本，不要英文任务名称。`;

            // 打印完整的AI输入
            console.log('🤖 AI输入提示词:');
            console.log('━'.repeat(80));
            console.log(prompt);
            console.log('━'.repeat(80));

            // 构建请求参数
            const requestData = {
                model: 'deepseek-ai/DeepSeek-V3',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 1200,
                temperature: 0.5
            };

            console.log('📤 AI API 请求参数:');
            console.log('  🔗 URL: https://api-inference.modelscope.cn/v1/chat/completions');
            console.log('  📦 请求体:', JSON.stringify(requestData, null, 2));

            let plan;
            try {
                console.log('⏳ 正在调用AI API...');
                const startTime = Date.now();
                
                const res = await fetch('https://api-inference.modelscope.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ms-150d583e-ed00-46d3-ab35-570f03555599'
                    },
                    body: JSON.stringify(requestData)
                });

                const responseTime = Date.now() - startTime;
                console.log(`⚡ AI API 响应时间: ${responseTime}ms`);
                console.log('📥 AI API 响应状态:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('❌ AI API 错误响应:', errorText);
                    throw new Error(`AI API失败: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('📥 AI API 完整响应数据:');
                console.log(JSON.stringify(data, null, 2));

                const content = data.choices?.[0]?.message?.content || '';
                console.log('🔍 AI 返回的内容:');
                console.log('━'.repeat(80));
                console.log(content);
                console.log('━'.repeat(80));

                // 提取JSON部分
                const match = content.match(/\{[\s\S]*\}/);
                if (match) {
                    const jsonString = match[0];
                    console.log('🔄 提取的JSON字符串:');
                    console.log(jsonString);
                    
                    try {
                        plan = JSON.parse(jsonString);
                        console.log('✅ JSON解析成功！');
                        console.log('📋 解析后的计划数据:');
                        console.log(JSON.stringify(plan, null, 2));
                    } catch (parseError) {
                        console.error('❌ JSON解析失败:', parseError);
                        console.error('🔤 原始JSON字符串:', jsonString);
                        throw new Error('AI返回的JSON格式错误');
                    }
                } else {
                    console.error('❌ 未在AI响应中找到JSON格式数据');
                    console.error('📄 AI完整响应:', content);
                    throw new Error('AI返回格式不正确，未包含JSON数据');
                }

            } catch (e) {
                console.error('❌ AI调用失败:', e);
                console.warn('🔄 使用规则回退生成Scrum计划');
                plan = buildScrumPlanFallback(acceptedByArea, analysis);
                console.log('🛠️ 回退生成的计划:', plan);
            }

            // 分析AI返回的计划数据
            console.log('🔍 =================== AI返回数据分析 ===================');
            console.log('📋 生成的计划数据:', plan);
            console.log('📊 计划数据类型:', typeof plan);
            console.log('📝 计划包含的任务:', plan?.tasks);
            console.log('🎯 Sprint信息:', plan?.sprint);

            // 映射到本地结构
            const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
            const tasks = Array.isArray(plan?.tasks) ? plan.tasks : [];
            
            console.log('🔄 =================== 任务数据处理 ===================');
            console.log('📦 提取的任务数组:', tasks);
            console.log('🔢 任务数组长度:', tasks.length);
            
            // 如果没有任务，记录详细信息
            if (tasks.length === 0) {
                console.warn('⚠️ 警告：AI未返回任何任务数据');
                console.log('🔍 原始计划对象:', JSON.stringify(plan, null, 2));
            }

            const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
            const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';

            tasks.forEach((t, idx) => {
                console.log(`📋 处理任务 ${idx + 1}:`, t);
                
                const task = {
                    id: `ai-${Date.now()}-${idx}`,
                    title: t.title || `任务${idx+1}`,
                    description: t.desc || '',
                    assignee: t.assignee || (window.teamMembers?.[idx % (window.teamMembers.length||1)]?.name || ''),
                    priority: normalizePriority(t.priority),
                    storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                    startDate: t.startDate || new Date().toISOString().slice(0,10),
                    endDate: t.endDate || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                    tags: Array.isArray(t.tags) ? t.tags : [],
                    progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                };
                
                const normalizedStatus = normalizeStatus(t.status);
                console.log(`✅ 标准化任务 ${idx + 1}:`, task);
                console.log(`📌 分配到状态: ${normalizedStatus}`);
                
                buckets[normalizedStatus].push(task);
            });

            window.scrumTasks = Object.assign(buckets, { __auto: true, __aiGenerated: true });

            console.log('🎯 =================== 最终任务数据结构 ===================');
            console.log('📊 完整的scrumTasks数据结构:', window.scrumTasks);
            
            // 详细分析每个状态的任务
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const statusTasks = window.scrumTasks[status];
                    console.log(`📋 状态"${status}"的任务详情:`);
                    console.log(`  📊 任务数量: ${statusTasks.length}`);
                    console.log(`  📦 数据类型: ${Array.isArray(statusTasks) ? 'Array' : typeof statusTasks}`);
                    console.log(`  📝 任务列表:`, statusTasks);
                    
                    // 分析每个任务的关键属性
                    statusTasks.forEach((task, idx) => {
                        console.log(`    📋 任务${idx + 1}: "${task.title}"`, {
                            id: task.id,
                            priority: task.priority,
                            storyPoints: task.storyPoints,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            assignee: task.assignee,
                            tags: task.tags
                        });
                    });
                }
            });

            // 计算总任务数
            const totalTasks = Object.keys(window.scrumTasks)
                .filter(key => key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]))
                .reduce((sum, status) => sum + window.scrumTasks[status].length, 0);
            console.log(`📊 任务统计: 总计 ${totalTasks} 个任务`);
            
            // 验证数据完整性
            if (totalTasks === 0) {
                console.error('❌ 严重错误：没有生成任何有效任务！');
            } else {
                console.log('✅ 任务数据验证通过');
            }

            // 渲染
            console.log('🎨 =================== 开始渲染甘特图 ===================');
            console.log('⏳ 调用renderGanttChart()函数...');
            renderGanttChart();
            console.log('🎯 =================== Scrum AI 任务计划生成完成 ===================');
        };

        function buildScrumPlanFallback(acceptedByArea, analysis) {
            const tasks = [];
            const today = new Date();
            let dayOffset = 0;
            Object.keys(acceptedByArea || {}).forEach(area => {
                (acceptedByArea[area] || []).forEach((title, idx) => {
                    const start = new Date(today.getTime() + dayOffset*86400000);
                    const end = new Date(start.getTime() + (2 + (idx%3))*86400000);
                    tasks.push({
                        title: `${area} - 执行「${title}」`,
                        desc: '根据已采纳建议落实执行、验证与复盘',
                        priority: idx%2===0 ? 'high' : 'medium',
                        storyPoints: [3,5,8,13][idx%4],
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: idx%3===0 ? 'in-progress' : 'todo',
                        tags: [area]
                    });
                    dayOffset += 1;
                });
            });
            // 若尚未采纳建议，基于高值板块生成基本任务
            if (tasks.length === 0 && analysis?.emissions) {
                const sorted = Object.entries(analysis.emissions).sort((a,b)=> (b[1].value||0) - (a[1].value||0)).slice(0,3);
                sorted.forEach(([k,v],i)=>{
                    const start = new Date(today.getTime() + i*86400000);
                    const end = new Date(start.getTime() + 3*86400000);
                    tasks.push({
                        title: `降低「${k}」阶段排放`,
                        desc: '制定并执行降碳举措，跟踪指标',
                        priority: i===0?'high':'medium',
                        storyPoints: [8,5,3][i] || 5,
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: 'todo',
                        tags: ['降碳']
                    });
                });
            }
            return { sprint: {}, tasks };
        }

        // 切换Scrum视图
        window.switchScrumView = function(viewType) {
            // 更新按钮状态
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
            
            // 隐藏所有视图
            document.querySelectorAll('.scrum-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // 显示选中视图
            const viewElement = document.getElementById(`${viewType}-view`);
            if (viewElement) {
                viewElement.style.display = 'block';
            }
            
            // 根据视图类型渲染相应内容
            switch(viewType) {
                case 'kanban':
                    // 取消看板渲染，仅保留甘特图
                    break;
                case 'gantt':
                    renderGanttChart();
                    break;
            }
        };

        // 渲染Kanban看板
        window.renderKanbanBoard = function() {
            // 检查数据结构
            if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                console.warn('scrumTasks 数据不存在或格式错误');
                return;
            }
            
            Object.keys(window.scrumTasks).forEach(status => {
                // 跳过特殊标记
                if (status === '__auto') return;
                
                const taskList = document.getElementById(`${status === 'in-progress' ? 'in-progress' : status}-tasks`);
                if (!taskList) {
                    console.warn(`找不到状态为 ${status} 的任务列表容器`);
                    return;
                }
                
                const tasks = window.scrumTasks[status];
                
                // 确保 tasks 是数组
                if (!Array.isArray(tasks)) {
                    console.warn(`状态 ${status} 的任务不是数组:`, tasks);
                    taskList.innerHTML = '<div class="no-tasks">暂无任务</div>';
                    return;
                }
                
                taskList.innerHTML = tasks.map(task => {
                    const priorityColor = {
                        high: '#dc3545',
                        medium: '#ffc107',
                        low: '#28a745'
                    };
                    
                    const progressBar = task.progress ? `
                        <div class="task-progress">
                            <div class="progress-bar-task">
                                <div class="progress-fill-task" style="width: ${task.progress}%"></div>
                            </div>
                            <span class="progress-text">${task.progress}%</span>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="task-card" data-task-id="${task.id}" draggable="true" 
                             ondragstart="handleTaskDragStart(event)" 
                             ondragend="handleTaskDragEnd(event)">
                            <div class="task-header">
                                <div class="task-priority" style="background-color: ${priorityColor[task.priority]}"></div>
                                <div class="task-points">${task.storyPoints} SP</div>
                            </div>
                            <h4 class="task-title">${task.title}</h4>
                            <p class="task-description">${task.description}</p>
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
                            </div>
                            ${progressBar}
                            <div class="task-footer">
                                <div class="task-assignee">
                                    <span class="assignee-avatar">${getTeamMemberAvatar(task.assignee)}</span>
                                    <span class="assignee-name">${task.assignee}</span>
                                </div>
                                <div class="task-dates">
                                    <small>${task.startDate} - ${task.endDate}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 更新任务计数
                const column = taskList.closest('.kanban-column');
                const countElement = column.querySelector('.task-count');
                countElement.textContent = tasks.length;
            });
            
            // 设置拖拽区域
            setupKanbanDragAndDrop();
        };

        // 获取团队成员头像
        function getTeamMemberAvatar(memberName) {
            const member = window.teamMembers.find(m => m.name === memberName);
            return member ? member.avatar : '👤';
        }

        // 设置Kanban拖拽功能
        function setupKanbanDragAndDrop() {
            // 为每个列设置拖拽目标
            document.querySelectorAll('.task-list').forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
            });
        }

        // 拖拽开始
        window.handleTaskDragStart = function(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.taskId);
            event.target.classList.add('dragging');
        };

        // 拖拽结束
        window.handleTaskDragEnd = function(event) {
            event.target.classList.remove('dragging');
        };

        // 拖拽悬停
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        // 放置任务
        function handleDrop(event) {
            event.preventDefault();
            const taskId = event.dataTransfer.getData('text/plain');
            const targetStatus = event.currentTarget.id.replace('-tasks', '').replace('in-progress', 'in-progress');
            
            // 移动任务到新状态
            moveTask(taskId, targetStatus);
            
            // 重新渲染看板
            // 取消看板渲染，仅保留甘特图
            
            // 移除拖拽样式
            event.currentTarget.classList.remove('drag-over');
        }

        // 移动任务
        function moveTask(taskId, newStatus) {
            let taskToMove = null;
            let fromStatus = null;
            
            // 找到任务并从原位置移除
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const taskIndex = window.scrumTasks[status].findIndex(task => task.id === taskId);
                    if (taskIndex !== -1) {
                        taskToMove = window.scrumTasks[status].splice(taskIndex, 1)[0];
                        fromStatus = status;
                    }
                }
            });
            
            // 添加到新位置
            if (taskToMove) {
                // 如果移动到已完成，添加完成日期
                if (newStatus === 'done' && !taskToMove.completedDate) {
                    taskToMove.completedDate = new Date().toISOString().split('T')[0];
                }
                
                if (Array.isArray(window.scrumTasks[newStatus])) {
                    window.scrumTasks[newStatus].push(taskToMove);
                } else {
                    console.error(`目标状态 ${newStatus} 不是数组，无法移动任务`);
                    return;
                }
                
                // 显示移动提示
                showTaskMoveNotification(taskToMove.title, fromStatus, newStatus);
            }
        }

        // 显示任务移动提示
        function showTaskMoveNotification(taskTitle, fromStatus, toStatus) {
            const statusNames = {
                'todo': '待办事项',
                'in-progress': '进行中',
                'done': '已完成'
            };
            
            // 创建提示元素
            const notification = document.createElement('div');
            notification.className = 'task-move-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                "${taskTitle}" 已从 ${statusNames[fromStatus]} 移动到 ${statusNames[toStatus]}
            `;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // 初始化Scrum模块
        function initializeScrumModule() {
            // 默认显示Kanban视图
            // 取消看板渲染，仅保留甘特图
            
            // 初始化甘特图默认为日视图
            window.ganttConfig.currentZoom = 'day';
            
            console.log('Scrum模块初始化完成');
        }



        // 渲染甘特图
        window.renderGanttChart = function() {
            console.log('📊 =================== 甘特图渲染开始 ===================');
            
            try {
                const ganttChart = document.getElementById('ganttChart');
                if (!ganttChart) {
                    console.warn('❌ 找不到甘特图容器元素 #ganttChart');
                    return;
                }
                console.log('✅ 甘特图容器元素找到');
                // 页面提示：正在生成甘特图
                try {
                    ganttChart.innerHTML = '<div style="padding: 16px; text-align:center; color:#555;">⏳ 正在生成甘特图...</div>';
                    if (window.addScrumProgress) {
                        window.addScrumProgress('正在生成甘特图...');
                    }
                } catch (e) {}
                
                // 检查数据
                console.log('🔍 检查Scrum任务数据...');
                console.log('📦 window.scrumTasks:', window.scrumTasks);
                console.log('📊 数据类型:', typeof window.scrumTasks);
                
                if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                    console.warn('❌ Scrum任务数据无效或不存在');
                    ganttChart.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;">暂无任务数据，请先生成Scrum计划</div>';
                    return;
                }
                console.log('✅ Scrum任务数据检查通过');
                
                // 获取所有任务
                console.log('🔄 =================== 任务数据提取 ===================');
                console.log('📦 原始scrumTasks数据:', window.scrumTasks);
                const allTasks = [];
                
                // 安全地提取所有任务
                console.log('🔍 开始从各状态提取任务...');
                Object.keys(window.scrumTasks).forEach(status => {
                    if (status !== '__auto' && status !== '__aiGenerated') {
                        console.log(`📋 检查状态"${status}":`, window.scrumTasks[status]);
                        console.log(`  📊 是否为数组: ${Array.isArray(window.scrumTasks[status])}`);
                        console.log(`  🔢 任务数量: ${window.scrumTasks[status]?.length || 0}`);
                        
                        if (Array.isArray(window.scrumTasks[status])) {
                            const statusTasks = window.scrumTasks[status];
                            console.log(`  ✅ 从"${status}"提取 ${statusTasks.length} 个任务`);
                            statusTasks.forEach((task, idx) => {
                                console.log(`    📝 任务${idx + 1}:`, {
                                    id: task.id,
                                    title: task.title,
                                    startDate: task.startDate,
                                    endDate: task.endDate
                                });
                            });
                            allTasks.push(...statusTasks);
                        } else {
                            console.warn(`  ⚠️ 状态"${status}"的数据不是数组:`, window.scrumTasks[status]);
                        }
                    }
                });
                
                console.log('📊 =================== 任务提取结果 ===================');
                console.log('🔢 提取的任务总数:', allTasks.length);
                console.log('📋 所有任务详情:', allTasks);
                
                // 检查是否有任务
                if (allTasks.length === 0) {
                    console.warn('❌ 没有提取到任何任务数据');
                    console.log('🔍 调试信息:');
                    console.log('  - scrumTasks 对象:', window.scrumTasks);
                    console.log('  - scrumTasks 键:', Object.keys(window.scrumTasks));
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>❌ 暂无任务</h3>
                            <p>请先生成Scrum任务计划</p>
                            <p style="color: #666; font-size: 12px;">调试：检测到 scrumTasks 对象，但未找到有效任务</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ 任务数据提取成功');
                
                // 验证任务数据格式
                console.log('🔍 =================== 任务数据验证 ===================');
                console.log('📊 开始验证任务数据格式...');
                
                const validTasks = allTasks.filter((task, idx) => {
                    const isValid = task && task.startDate && task.endDate && task.title;
                    console.log(`📋 任务${idx + 1} 验证:`, {
                        title: task?.title,
                        startDate: task?.startDate,
                        endDate: task?.endDate,
                        isValid: isValid
                    });
                    
                    if (!isValid) {
                        console.warn(`⚠️ 任务${idx + 1} 数据不完整:`, task);
                    }
                    
                    return isValid;
                });
                
                console.log('📊 验证结果:');
                console.log(`  🔢 原始任务数: ${allTasks.length}`);
                console.log(`  ✅ 有效任务数: ${validTasks.length}`);
                console.log(`  ❌ 无效任务数: ${allTasks.length - validTasks.length}`);
                
                if (validTasks.length === 0) {
                    console.error('❌ 所有任务数据格式都不正确！');
                    console.log('🔍 无效任务详情:');
                    allTasks.forEach((task, idx) => {
                        console.log(`  任务${idx + 1}:`, {
                            hasTask: !!task,
                            hasTitle: !!task?.title,
                            hasStartDate: !!task?.startDate,
                            hasEndDate: !!task?.endDate,
                            task: task
                        });
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>❌ 任务数据格式错误</h3>
                            <p>检测到 ${allTasks.length} 个任务，但数据格式不正确</p>
                            <p style="color: #666; font-size: 12px;">请检查控制台获取详细信息</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ 任务数据验证通过');
                
                // 按开始日期排序
                console.log('🔄 =================== 任务排序和日期计算 ===================');
                console.log('📅 按开始日期排序任务...');
                
                validTasks.sort((a, b) => {
                    const dateA = new Date(a.startDate);
                    const dateB = new Date(b.startDate);
                    console.log(`📋 比较任务: "${a.title}" (${a.startDate}) vs "${b.title}" (${b.startDate})`);
                    return dateA - dateB;
                });
                
                console.log('✅ 任务排序完成');
                console.log('📋 排序后的任务顺序:');
                validTasks.forEach((task, idx) => {
                    console.log(`  ${idx + 1}. "${task.title}" (${task.startDate} ~ ${task.endDate})`);
                });
                
                // 计算时间范围
                console.log('📅 计算甘特图时间范围...');
                let minDate, maxDate;
                try {
                    const startDates = validTasks.map(task => {
                        const date = new Date(task.startDate);
                        console.log(`📅 解析开始日期: ${task.startDate} -> ${date} (有效: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    const endDates = validTasks.map(task => {
                        const date = new Date(task.endDate);
                        console.log(`📅 解析结束日期: ${task.endDate} -> ${date} (有效: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    console.log(`📊 有效开始日期数量: ${startDates.length}`);
                    console.log(`📊 有效结束日期数量: ${endDates.length}`);
                    
                    if (startDates.length === 0 || endDates.length === 0) {
                        throw new Error('无有效日期数据');
                    }
                    
                    minDate = new Date(Math.min(...startDates));
                    maxDate = new Date(Math.max(...endDates));
                    
                    console.log(`📅 计算的时间范围: ${minDate} ~ ${maxDate}`);
                    console.log(`📊 时间跨度: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} 天`);
                    
                    // 确保日期有效
                    if (isNaN(minDate) || isNaN(maxDate)) {
                        throw new Error('日期计算失败');
                    }
                    
                    console.log('✅ 时间范围计算成功');
                    
                } catch (dateError) {
                    console.error('❌ 日期计算错误:', dateError);
                    console.log('🔍 日期计算调试信息:');
                    validTasks.forEach((task, idx) => {
                        console.log(`  任务${idx + 1}: ${task.title}`);
                        console.log(`    开始日期: ${task.startDate} -> ${new Date(task.startDate)}`);
                        console.log(`    结束日期: ${task.endDate} -> ${new Date(task.endDate)}`);
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> 日期数据错误</h3>
                            <p>任务的开始或结束日期格式不正确</p>
                            <p style="color: #666; font-size: 14px;">错误详情: ${dateError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // 根据当前缩放级别生成日期列
                console.log('📅 =================== 日期列生成 ===================');
                let dateColumns;
                try {
                    const currentZoom = window.ganttConfig?.currentZoom || 'day';
                    console.log(`🔍 当前缩放级别: ${currentZoom}`);
                    console.log(`📅 时间范围: ${minDate} 到 ${maxDate}`);
                    
                    console.log('⏳ 调用generateDateColumnsWithZoom...');
                    dateColumns = generateDateColumnsWithZoom(minDate, maxDate, currentZoom);
                    
                    console.log('📅 生成的日期列:');
                    console.log(`  🔢 日期列数量: ${dateColumns?.length || 0}`);
                    console.log(`  📊 是否为数组: ${Array.isArray(dateColumns)}`);
                    console.log('  📋 日期列详情:', dateColumns);
                    
                    // 显示前几个日期列的内容
                    if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                        console.log('📅 前几个日期列示例:');
                        dateColumns.slice(0, 5).forEach((col, idx) => {
                            console.log(`  ${idx + 1}. ${col.displayText} (${col.type}) - ${col.fullDate}`);
                        });
                        if (dateColumns.length > 5) {
                            console.log(`  ... 还有 ${dateColumns.length - 5} 个日期列`);
                        }
                    }
                    
                    if (!Array.isArray(dateColumns) || dateColumns.length === 0) {
                        throw new Error('日期列生成失败 - 返回空数组或非数组');
                    }
                    
                    console.log('✅ 日期列生成成功');
                    
                } catch (columnError) {
                    console.error('❌ 日期列生成错误:', columnError);
                    console.log('🔍 日期列生成调试信息:');
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    console.log('  - currentZoom:', window.ganttConfig?.currentZoom);
                    console.log('  - ganttConfig:', window.ganttConfig);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> 日期列生成错误</h3>
                            <p>无法生成甘特图时间轴</p>
                            <p style="color: #666; font-size: 14px;">错误详情: ${columnError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // 渲染甘特图
                console.log('🎨 =================== 甘特图HTML渲染 ===================');
                try {
                    console.log('📋 开始渲染各任务行...');
                    console.log(`🔢 需要渲染的任务数: ${validTasks.length}`);
                    // 计算横向总宽度，保证可滚动区域完整渲染
                    const zoomForWidth = (window.ganttConfig && window.ganttConfig.currentZoom) ? window.ganttConfig.currentZoom : 'day';
                    const baseColWidth = (zoomForWidth === 'week') ? 140 : 100;
                    const timelineWidthPx = Math.max(800, (dateColumns?.length || 0) * baseColWidth);
                    
                    const taskRows = validTasks.map((task, idx) => {
                        console.log(`📋 渲染任务 ${idx + 1}: "${task.title}"`);
                        try {
                            const taskHtml = renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx);
                            console.log(`  ✅ 任务 ${idx + 1} 渲染成功`);
                            return taskHtml;
                        } catch (taskError) {
                            console.error(`  ❌ 任务 ${idx + 1} 渲染错误:`, taskError, task);
                            return `
                                <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                                    <div class="task-info" style="padding: 15px;">
                                        <div style="color: #856404;">
                                            <strong>任务渲染错误:</strong> ${task.title || '未知任务'}
                                            <br><small>${taskError.message}</small>
                                        </div>
                                    </div>
                                    <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                                        <small style="color: #856404;">渲染失败</small>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    console.log('✅ 所有任务行渲染完成');
                    console.log(`📊 生成的HTML行数: ${taskRows.length}`);
                    
                    // 生成日期列标题HTML
                    console.log('📅 生成日期列标题HTML...');
                    const dateHeaderHtml = dateColumns.map(dateInfo => `
                        <div class="date-column" style="width: ${baseColWidth}px;" title="${dateInfo.fullDate || dateInfo.displayText}">${dateInfo.displayText}</div>
                    `).join('');
                    console.log(`📅 日期列标题HTML长度: ${dateHeaderHtml.length} 字符`);
                    
                    // 组装完整的甘特图HTML
                    console.log('🎨 组装完整甘特图HTML...');
                    const totalGridWidthPx = 300 + timelineWidthPx;
                    const ganttHtml = `
                        <div class="gantt-timeline">
                            <div class="gantt-tasks" style="width: ${totalGridWidthPx}px;">
                                <div class="gantt-header-row">
                                    <div class="task-info-header">任务信息</div>
                                    <div class="timeline-header" style="width: ${timelineWidthPx}px">
                                        ${dateHeaderHtml}
                                    </div>
                                </div>
                                ${taskRows.join('')}
                            </div>
                        </div>
                    `;
                    
                    console.log(`🎨 完整甘特图HTML长度: ${ganttHtml.length} 字符`);
                    console.log('⏳ 将HTML插入到DOM中...');
                    
                    ganttChart.innerHTML = ganttHtml;
                    
                    console.log('✅ 甘特图HTML插入成功');
                    
                    // 保存当前日期范围
                    if (window.ganttConfig) {
                        window.ganttConfig.startDate = minDate;
                        window.ganttConfig.endDate = maxDate;
                        console.log('💾 甘特图配置已更新:', window.ganttConfig);
                    }
                    
                    console.log('🎯 =================== 甘特图渲染完成 ===================');
                    console.log(`✅ 甘特图渲染成功！`);
                    console.log(`  📊 任务数: ${validTasks.length}`);
                    console.log(`  📅 日期列数: ${dateColumns.length}`);
                    console.log(`  📈 时间跨度: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} 天`);
                    console.log(`  🔍 缩放级别: ${window.ganttConfig?.currentZoom || 'day'}`);
                    
                } catch (renderError) {
                    console.error('❌ 甘特图渲染错误:', renderError);
                    console.log('🔍 渲染错误调试信息:');
                    console.log('  - validTasks:', validTasks);
                    console.log('  - dateColumns:', dateColumns);
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> 甘特图渲染失败</h3>
                            <p>检测到 ${validTasks.length} 个有效任务，但渲染过程出现错误</p>
                            <p style="color: #666; font-size: 14px;">错误详情: ${renderError.message}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> 重新加载页面
                                </button>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ 甘特图整体渲染失败:', error);
                console.log('🔍 整体渲染失败调试信息:');
                console.log('  - error.stack:', error.stack);
                console.log('  - window.scrumTasks:', window.scrumTasks);
                console.log('  - window.ganttConfig:', window.ganttConfig);
                
                const ganttChart = document.getElementById('ganttChart');
                if (ganttChart) {
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-times-circle" style="color: #721c24;"></i> 甘特图加载失败</h3>
                            <p>甘特图组件遇到严重错误，无法正常显示</p>
                            <p style="color: #666; font-size: 14px;">技术错误: ${error.message || error}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> 重新加载页面
                                </button>
                                <button class="btn btn-secondary" onclick="console.log('Debug Info:', {scrumTasks: window.scrumTasks, ganttConfig: window.ganttConfig})" style="margin-left: 10px;">
                                    <i class="fas fa-bug"></i> 调试信息
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // 生成日期列（原始版本，保持向后兼容）
        function generateDateColumns(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }

        // 根据缩放级别生成日期列
        function generateDateColumnsWithZoom(startDate, endDate, zoomLevel) {
            try {
                const dateColumns = [];
                
                // 确保输入参数有效
                if (!startDate || !endDate || isNaN(startDate) || isNaN(endDate)) {
                    throw new Error('无效的开始或结束日期');
                }
                
                if (startDate > endDate) {
                    throw new Error('开始日期不能晚于结束日期');
                }
                
                // 防止无限循环的安全检查
                const maxDays = 365; // 最多一年的日期范围
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > maxDays) {
                    throw new Error(`日期范围过大: ${daysDiff} 天，最大支持 ${maxDays} 天`);
                }
                
                if (zoomLevel === 'day') {
                    // 日视图：显示每一天
                    const currentDate = new Date(startDate);
                    let loopCount = 0;
                    const maxLoops = 400; // 防止无限循环
                    
                    while (currentDate <= endDate && loopCount < maxLoops) {
                        try {
                            dateColumns.push({
                                date: new Date(currentDate),
                                displayText: formatDateShort ? formatDateShort(currentDate) : `${currentDate.getMonth()+1}/${currentDate.getDate()}`,
                                fullDate: formatDateFull ? formatDateFull(currentDate) : currentDate.toDateString(),
                                type: 'day'
                            });
                            currentDate.setDate(currentDate.getDate() + 1);
                        } catch (e) {
                            console.error('日视图日期处理错误:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxLoops) {
                        console.warn('日视图日期生成循环次数过多，可能存在问题');
                    }
                    
                } else if (zoomLevel === 'week') {
                    // 周视图：从“计划第一天”开始，每7天为一列，并在尾部额外扩展若干周
                    const firstDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const extraWeeksAfter = 2; // 末尾额外展示的周数
                    const endWithPadding = new Date(endDate);
                    endWithPadding.setDate(endWithPadding.getDate() + (extraWeeksAfter * 7));
                    
                    let weekStart = new Date(firstDay);
                    let weekNumber = 1;
                    let loopCount = 0;
                    const maxWeeks = 60; // 防止无限循环
                    
                    while (weekStart <= endWithPadding && loopCount < maxWeeks) {
                        try {
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            
                            const startText = formatDateShort ? formatDateShort(weekStart) : `${weekStart.getMonth()+1}/${weekStart.getDate()}`;
                            const endText = formatDateShort ? formatDateShort(weekEnd) : `${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;
                            
                            dateColumns.push({
                                date: new Date(weekStart),
                                displayText: `第${weekNumber}周`,
                                fullDate: `${startText} - ${endText}`,
                                type: 'week',
                                weekStart: new Date(weekStart),
                                weekEnd: new Date(weekEnd)
                            });
                            
                            weekStart.setDate(weekStart.getDate() + 7);
                            weekNumber++;
                        } catch (e) {
                            console.error('周视图日期处理错误:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxWeeks) {
                        console.warn('周视图日期生成循环次数过多，可能存在问题');
                    }
                    
                } else if (zoomLevel === 'month') {
                    // 月视图：显示每一月
                    const currentDate = new Date(startDate);
                    // 找到第一个月的开始
                    const firstMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    
                    let monthStart = new Date(firstMonth);
                    let loopCount = 0;
                    const maxMonths = 24; // 防止无限循环，最多24个月
                    
                    while (monthStart <= endDate && loopCount < maxMonths) {
                        try {
                            const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0); // 月末最后一天
                            
                            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', 
                                              '7月', '8月', '9月', '10月', '11月', '12月'];
                            const monthName = monthNames[monthStart.getMonth()];
                            const year = monthStart.getFullYear();
                            
                            dateColumns.push({
                                date: new Date(monthStart),
                                displayText: `${year}年${monthName}`,
                                fullDate: `${year}年${monthName} (${monthStart.getMonth()+1}/1 - ${monthEnd.getMonth()+1}/${monthEnd.getDate()})`,
                                type: 'month',
                                monthStart: new Date(monthStart),
                                monthEnd: new Date(monthEnd)
                            });
                            
                            // 移动到下一个月
                            monthStart.setMonth(monthStart.getMonth() + 1);
                        } catch (e) {
                            console.error('月视图日期处理错误:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxMonths) {
                        console.warn('月视图日期生成循环次数过多，可能存在问题');
                    }
                } else {
                    // 默认返回简单的日期列
                    console.warn('未知的缩放级别:', zoomLevel, '使用默认处理');
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    const step = Math.max(1, Math.ceil(daysDiff / 20)); // 最多20列
                    
                    for (let i = 0; i <= daysDiff; i += step) {
                        const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                        dateColumns.push({
                            date: date,
                            displayText: `${date.getMonth()+1}/${date.getDate()}`,
                            fullDate: date.toDateString(),
                            type: 'day'
                        });
                    }
                }
                
                if (dateColumns.length === 0) {
                    // 确保至少有一列
                    dateColumns.push({
                        date: new Date(startDate),
                        displayText: '无数据',
                        fullDate: '无有效日期数据',
                        type: 'day'
                    });
                }
                
                return dateColumns;
                
            } catch (error) {
                console.error('generateDateColumnsWithZoom 错误:', error);
                // 返回最基本的结构以避免完全失败
                return [{
                    date: new Date(),
                    displayText: '错误',
                    fullDate: error.message || '日期生成错误',
                    type: 'error'
                }];
            }
        }

        // 格式化日期（短格式）
        function formatDateShort(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // 格式化日期（完整格式）
        function formatDateFull(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const weekday = weekdays[date.getDay()];
            return `${year}-${month}-${day} ${weekday}`;
        }

        // 渲染甘特图任务行（兼容性函数，默认按天计算）
        function renderGanttTask(task, minDate, maxDate, totalDays) {
            const taskStartDate = new Date(task.startDate);
            const taskEndDate = new Date(task.endDate);
            
            // 计算任务在时间轴上的位置和宽度（按天计算）
            const startOffset = Math.floor((taskStartDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.floor((taskEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const statusColors = {
                'todo': '#6c757d',
                'in-progress': '#ffc107',
                'done': '#28a745'
            };
            
            // 找到任务状态
            let taskStatus = 'todo';
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    if (window.scrumTasks[status].find(t => t.id === task.id)) {
                        taskStatus = status;
                    }
                }
            });
            
            const progressWidth = task.progress ? (task.progress / 100) * duration : 0;
            
            return `
                <div class="gantt-task-row">
                    <div class="task-info">
                        <div class="task-info-content">
                            <div class="task-title-gantt">${task.title}</div>
                            <div class="task-meta">
                                <span class="task-priority priority-${task.priority}">优先级：${task.priority}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-content">
                        <div class="gantt-bar-container" style="position: relative;">
                            <div class="gantt-bar" 
                                 style="left: ${(startOffset / totalDays) * 100}%; 
                                        width: ${(duration / totalDays) * 100}%; 
                                        background-color: ${statusColors[taskStatus]};">
                                ${task.progress ? `
                                    <div class="gantt-progress" 
                                         style="width: ${task.progress}%; background-color: ${statusColors[taskStatus]}; opacity: 0.8;"></div>
                                ` : ''}
                                <span class="gantt-bar-text">${task.title}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 支持缩放的甘特图任务渲染
        function renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx) {
            try {
                // 参数验证
                if (!task || !task.startDate || !task.endDate || !task.title) {
                    throw new Error('任务数据不完整');
                }
                
                if (!minDate || !maxDate || !Array.isArray(dateColumns)) {
                    throw new Error('日期参数无效');
                }
                
                if (!timelineWidthPx || isNaN(timelineWidthPx)) {
                    throw new Error('时间轴宽度参数无效');
                }
                
                const taskStartDate = new Date(task.startDate);
                const taskEndDate = new Date(task.endDate);
                const DAY_MS = 24 * 60 * 60 * 1000;
                const normalize = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const normMin = normalize(new Date(minDate));
                const normStart = normalize(taskStartDate);
                const normEnd = normalize(taskEndDate);
                
                // 验证日期有效性
                if (isNaN(taskStartDate) || isNaN(taskEndDate)) {
                    throw new Error('任务日期格式无效');
                }
                
                const statusColors = {
                    'todo': '#6c757d',
                    'in-progress': '#ffc107',
                    'done': '#28a745'
                };
                
                // 找到任务状态
                let taskStatus = 'todo';
                try {
                    if (window.scrumTasks && typeof window.scrumTasks === 'object') {
                        Object.keys(window.scrumTasks).forEach(status => {
                            if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                                if (window.scrumTasks[status].find(t => t && t.id === task.id)) {
                                    taskStatus = status;
                                }
                            }
                        });
                    }
                } catch (statusError) {
                    console.warn('获取任务状态失败:', statusError);
                    // 使用默认状态
                }
                
                const zoomLevel = window.ganttConfig?.currentZoom || 'day';
                let startOffset, duration;
                
                try {
                    if (zoomLevel === 'day') {
                        // 日视图：按天计算（零点对齐，避免时区偏差）
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    } else if (zoomLevel === 'week') {
                        // 周视图：以“天”为最小刻度进行定位和宽度计算，但表头仍以周列显示
                        const DAY_MS = 24 * 60 * 60 * 1000;
                        const getAlignedMonday = (base) => {
                            const d = new Date(base);
                            const dow = d.getDay();
                            const daysToMonday = dow === 0 ? 6 : dow - 1;
                            d.setDate(d.getDate() - daysToMonday);
                            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                        };

                        // 表头的第一列起点：现在从“计划第一天”开始，不强制对齐周一
                        let baseStart;
                        if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                            const firstCol = dateColumns[0];
                            baseStart = new Date(firstCol.date || firstCol.weekStart || normMin);
                        } else {
                            baseStart = new Date(normMin);
                        }
                        baseStart = new Date(baseStart.getFullYear(), baseStart.getMonth(), baseStart.getDate());

                        const totalDaysAll = Math.max(1, (dateColumns.length || 1) * 7);
                        const leftDays = Math.max(0, Math.floor((normStart - baseStart) / DAY_MS));
                        const widthDays = Math.max(1, Math.floor((normEnd - normStart) / DAY_MS) + 1);

                        // 将“天”映射为相对整段的百分比，以避免 3天/7天 被放大为整周
                        startOffset = leftDays; // 仅用于日志，不再直接用于百分比
                        duration = widthDays;

                        // 覆盖下面的百分比计算使用 totalDaysAll
                        var __weekly_totalDaysAll = totalDaysAll;
                        var __weekly_leftDays = leftDays;
                        var __weekly_widthDays = widthDays;
                    } else {
                        // 默认处理：按天计算
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    }
                    
                    // 确保偏移量和持续时间为有效值
                    startOffset = Math.max(0, startOffset || 0);
                    duration = Math.max(1, duration || 1);
                    
                } catch (dateCalcError) {
                    console.warn('日期计算失败:', dateCalcError);
                    startOffset = 0;
                    duration = 1;
                }
                
                const totalColumns = Math.max(1, dateColumns.length);
                const daysDuration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                
                // 安全地处理各种属性
                const safeTitle = (task.title || '未命名任务').toString();
                const safeAssignee = (task.assignee || '未分配').toString();
                const safeStoryPoints = isNaN(task.storyPoints) ? 0 : Number(task.storyPoints);
                const safePriority = ['high', 'medium', 'low'].includes(task.priority) ? task.priority : 'medium';
                const safeProgress = (task.progress && !isNaN(task.progress)) ? Math.min(100, Math.max(0, Number(task.progress))) : null;
                
                // 计算安全的百分比值
                let leftPercent;
                let widthPercent;
                if (zoomLevel === 'week' && typeof __weekly_totalDaysAll !== 'undefined') {
                    // 使用基于“天”的映射比例，保证 3天/7天 不会被放大为整周
                    leftPercent = Math.max(0, Math.min(100, (__weekly_leftDays / __weekly_totalDaysAll) * 100));
                    widthPercent = Math.max(1, Math.min(100, (__weekly_widthDays / __weekly_totalDaysAll) * 100));
                } else {
                    leftPercent = Math.max(0, Math.min(100, (startOffset / totalColumns) * 100));
                    widthPercent = Math.max(1, Math.min(100, (duration / totalColumns) * 100));
                }
                // 防溢出：确保条形不会超出容器
                widthPercent = Math.min(widthPercent, 100 - leftPercent);
                
                return `
                    <div class="gantt-task-row" style="display:flex; align-items: stretch; gap: 8px; margin-bottom: 8px;">
                        <div class="task-info" style="flex: 0 0 300px; max-width: 300px;">
                            <div class="task-info-content" style="display:flex; flex-direction: column; gap:4px;">
                                <div class="task-title-gantt" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${safeTitle}</div>
                                <div class="task-meta" style="display:flex; gap:8px; flex-wrap: wrap;">
                                    <span class="task-priority priority-${safePriority}">优先级：${safePriority}</span>
                                </div>
                                <div class="task-dates" style="font-size: 11px; color: #666;">
                                    ${task.startDate} ~ ${task.endDate} (${daysDuration}天)
                                </div>
                            </div>
                        </div>
                        <div class="timeline-content" style="flex:1; width: ${timelineWidthPx}px;">
                            <div class="gantt-bar-container" style="position: relative; height: 28px;">
                                <div class="gantt-bar" 
                                     style="position: absolute; top:0; bottom:0; left: ${leftPercent}%; 
                                            width: ${widthPercent}%; 
                                            background-color: ${statusColors[taskStatus] || statusColors.todo}; border-radius: 4px;">
                                    ${safeProgress ? `
                                        <div class="gantt-progress" 
                                             style="height:100%; width: ${safeProgress}%; background-color: ${statusColors[taskStatus] || statusColors.todo}; opacity: 0.8; border-radius:4px;"></div>
                                    ` : ''}
                                    <span class="gantt-bar-text" style="position:absolute; left:8px; top:50%; transform: translateY(-50%); font-size:12px; color:#fff; white-space:nowrap;">${daysDuration}天</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('renderGanttTaskWithZoom 错误:', error, task);
                // 返回错误显示的任务行
                const errorTitle = task?.title || '错误任务';
                return `
                    <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                        <div class="task-info" style="padding: 15px;">
                            <div style="color: #856404;">
                                <strong>任务渲染错误:</strong> ${errorTitle}
                                <br><small>${error.message || error}</small>
                            </div>
                        </div>
                        <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                            <small style="color: #856404;">渲染失败</small>
                        </div>
                    </div>
                `;
            }
        }

        // 计算任务在周视图中的周索引
        function getWeekIndex(taskDate, startDate) {
            try {
                if (!taskDate || !startDate || isNaN(taskDate) || isNaN(startDate)) {
                    console.warn('getWeekIndex: 无效的日期参数', { taskDate, startDate });
                    return 0;
                }
                
                const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                const diffMs = taskDate - startDate;
                
                if (isNaN(diffMs)) {
                    console.warn('getWeekIndex: 日期差异计算失败');
                    return 0;
                }
                
                const weekIndex = Math.floor(diffMs / msPerWeek);
                
                // 确保返回非负数
                return Math.max(0, weekIndex);
                
            } catch (error) {
                console.error('getWeekIndex 错误:', error);
                return 0;
            }
        }



        // 甘特图全局配置
        window.ganttConfig = {
            currentZoom: 'day', // 'day' 或 'week'
            startDate: null,
            endDate: null
        };

        // 调整甘特图缩放
        window.adjustGanttZoom = function(zoomLevel) {
            console.log('调整甘特图缩放级别:', zoomLevel);
            window.ganttConfig.currentZoom = zoomLevel;
            
            // 更新按钮状态
            document.querySelectorAll('.gantt-controls .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            const activeBtn = document.querySelector(`[onclick="adjustGanttZoom('${zoomLevel}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
            
            // 重新渲染甘特图
            renderGanttChart();
        };



        // 显示添加任务模态框
        window.showAddTaskModal = function(status) {
            console.log('显示添加任务模态框:', status);
            // 这里可以实现添加任务的功能
            alert(`添加新任务到"${status}"列的功能开发中...`);
        };

        // 进入Scrum执行（仅甘特图）：调用AI/回退生成计划并显示甘特图
        window.goToScrumExecution = async function() {
            try {
                // 控制台打印（不再在页面输出详细调试项）
                const log = (msg, detail) => {
                    console.log('[Scrum]', `[${new Date().toLocaleTimeString()}]`, msg, detail || '');
                };

                // 轻量进度提示（仅显示关键步骤）
                function ensureScrumProgressPanel() {
                    const container = document.querySelector('#gantt-view .gantt-container');
                    if (!container) return null;
                    let panel = document.getElementById('scrumProgressPanel');
                    if (!panel) {
                        panel = document.createElement('div');
                        panel.id = 'scrumProgressPanel';
                        panel.className = 'scrum-progress';
                        panel.style.margin = '8px 0';
                        panel.style.background = '#f8f9fa';
                        panel.style.border = '1px solid #e9ecef';
                        panel.style.borderRadius = '8px';
                        panel.style.padding = '8px 10px';
                        panel.style.fontSize = '12px';
                        panel.style.color = '#333';
                        const label = document.createElement('div');
                        label.className = 'scrum-progress-label';
                        label.textContent = '甘特图生成中...';
                        panel.appendChild(label);
                        const ganttChartEl = document.getElementById('ganttChart');
                        container.insertBefore(panel, ganttChartEl || container.firstChild);
                    }
                    return panel;
                }

                function addScrumProgress(message) {
                    const panel = ensureScrumProgressPanel();
                    if (!panel) return;
                    const label = panel.querySelector('.scrum-progress-label');
                    if (label) {
                        // 如果是甘特图生成相关的消息，显示"正在生成甘特图"
                        if (message.includes('甘特图') || message.includes('ensureScrumPlanReady') || message.includes('生成')) {
                            label.textContent = '正在生成甘特图...';
                            panel.style.display = 'block';
                        } else {
                            label.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        }
                    }
                }

                function hideScrumProgressPanel() {
                    const panel = document.getElementById('scrumProgressPanel');
                    if (panel) {
                        panel.style.display = 'none';
                        // 清空进度标签内容
                        const label = panel.querySelector('.scrum-progress-label');
                        if (label) {
                            label.textContent = '';
                        }
                    }
                }

                log('开始进入Scrum执行');
                addScrumProgress('开始进入Scrum执行');
                
                // 初始化甘特图配置（确保配置存在）
                if (!window.ganttConfig) {
                    window.ganttConfig = {
                        currentZoom: 'day',
                        startDate: null,
                        endDate: null
                    };
                    log('初始化甘特图配置');
                }
                
                // 切换到Scrum模块
                if (typeof switchModule === 'function') {
                    log('调用switchModule("scrum")');
                    addScrumProgress('调用switchModule("scrum")');
                    switchModule('scrum');
                } else {
                    log('fallback切换scrum模块');
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                }

                // 检查是否已有AI生成的任务数据（排除预设的默认数据）
                const hasAIGeneratedTasks = window.scrumTasks && window.scrumTasks.__auto && window.scrumTasks.__aiGenerated &&
                    Object.keys(window.scrumTasks).some(key => 
                        key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]) && window.scrumTasks[key].length > 0
                    );
                
                if (hasAIGeneratedTasks) {
                    log('检测到已有AI生成的任务数据，跳过重新生成');
                    log(`当前任务统计: ${Object.keys(window.scrumTasks).filter(k => k !== '__auto' && k !== '__aiGenerated').map(k => `${k}(${window.scrumTasks[k].length})`).join(', ')}`);
                } else {
                    // 清除预设数据，强制AI重新生成
                    log('清除预设任务数据，准备AI生成');
                    window.scrumTasks = {
                        todo: [],
                        'in-progress': [],
                        done: [],
                        __auto: false,
                        __aiGenerated: false
                    };
                    // 调用自动生成（AI优先，失败回退）
                    if (typeof window.ensureScrumPlanReady === 'function') {
                        log('调用ensureScrumPlanReady()');
                        addScrumProgress('调用ensureScrumPlanReady()');
                        await window.ensureScrumPlanReady();
                    } else if (typeof window.generateScrumPlanFromContext === 'function') {
                        log('调用generateScrumPlanFromContext()');
                        await window.generateScrumPlanFromContext();
                    } else {
                        log('未找到生成函数，使用默认任务数据');
                        // 如果生成函数不存在，确保有基本的任务数据
                        if (!window.scrumTasks || !window.scrumTasks.__auto) {
                            window.scrumTasks = {
                                todo: [
                                    {
                                        id: 'fallback-1',
                                        title: '材料采购优化',
                                        description: '实施环保材料采购策略',
                                        assignee: '采购部',
                                        priority: 'high',
                                        storyPoints: 8,
                                        startDate: new Date().toISOString().slice(0,10),
                                        endDate: new Date(Date.now() + 7*24*60*60*1000).toISOString().slice(0,10),
                                        tags: ['采购', '环保']
                                    }
                                ],
                                'in-progress': [],
                                done: [],
                                __auto: true,
                                __aiGenerated: false    // 标记为回退方案，非AI生成
                            };
                        }
                    }
                }

                // 确保甘特图视图存在
                const ganttView = document.getElementById('gantt-view');
                if (!ganttView) {
                    log('未找到甘特图视图容器');
                    throw new Error('甘特图视图容器不存在');
                }

                // 显示甘特图视图
                log('切换到甘特图视图');
                addScrumProgress('切换到甘特图视图');
                ganttView.style.display = 'block';
                
                // 隐藏其他视图
                const allViews = document.querySelectorAll('.scrum-view');
                allViews.forEach(view => {
                    if (view.id !== 'gantt-view') {
                        view.style.display = 'none';
                    }
                });

                // 检查甘特图是否需要重新渲染
                const ganttChart = document.getElementById('ganttChart');
                const needsGanttRender = !ganttChart || !ganttChart.innerHTML || ganttChart.innerHTML.trim() === '' ||
                                       ganttChart.innerHTML.includes('暂无任务数据') || 
                                       ganttChart.innerHTML.includes('甘特图加载中');
                
                if (needsGanttRender) {
                    log('甘特图需要渲染，调用renderGanttChart()');
                    try {
                        if (typeof window.renderGanttChart === 'function') {
                            window.renderGanttChart();
                            log('甘特图渲染函数调用完成');
                            // 甘特图渲染完成，隐藏进度面板
                            setTimeout(() => {
                                hideScrumProgressPanel();
                            }, 500); // 延迟500ms确保渲染完成
                        } else {
                            log('renderGanttChart函数不存在，使用简化渲染');
                            if (ganttChart) {
                                ganttChart.innerHTML = `
                                    <div style="padding: 20px; text-align: center;">
                                        <h3>甘特图加载中...</h3>
                                        <p>任务数据已准备完成，正在渲染甘特图界面</p>
                                        <div style="margin-top: 20px;">
                                            <i class="fas fa-chart-gantt" style="font-size: 48px; color: #007bff;"></i>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (renderError) {
                        log('甘特图渲染出错', renderError);
                        // 提供备用渲染
                        if (ganttChart) {
                            const taskCount = Object.values(window.scrumTasks || {}).reduce((count, tasks) => {
                                return count + (Array.isArray(tasks) ? tasks.length : 0);
                            }, 0);
                            
                            ganttChart.innerHTML = `
                                <div style="padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> 甘特图渲染问题</h3>
                                    <p>检测到 ${taskCount} 个任务，但甘特图渲染遇到技术问题</p>
                                    <p style="color: #666; font-size: 14px;">错误详情: ${renderError.message || renderError}</p>
                                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                                        <i class="fas fa-refresh"></i> 重新加载页面
                                    </button>
                                </div>
                            `;
                        }
                    }
                } else {
                    log('甘特图已存在有效内容，跳过重复渲染');
                    log('当前甘特图内容长度:', ganttChart ? ganttChart.innerHTML.length : 0);
                    // 甘特图已存在，直接隐藏进度面板
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 200);
                }

                // 检查最终结果
                const gantt = document.getElementById('ganttChart');
                if (!gantt) {
                    log('未找到#ganttChart容器');
                    throw new Error('甘特图容器元素不存在');
                } else if (!gantt.innerHTML || gantt.innerHTML.trim() === '') {
                    log('甘特容器为空，可能未生成任务或渲染失败');
                    gantt.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h3>甘特图为空</h3>
                            <p>请检查任务数据是否正确生成</p>
                        </div>
                    `;
                } else {
                    log('甘特图渲染完成');
                    // 甘特图渲染完成，隐藏进度面板
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 300);
                    // 滚动到甘特图位置
                    gantt.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                log('Scrum执行模块加载完成');
                addScrumProgress('Scrum执行模块加载完成');
                
            } catch (e) {
                console.error('进入Scrum执行失败:', e);
                const debugPanel = document.getElementById('scrumDebugPanel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                    const err = document.createElement('div');
                    err.style.color = '#721c24';
                    err.style.background = '#f8d7da';
                    err.style.border = '1px solid #f5c6cb';
                    err.style.padding = '8px';
                    err.style.borderRadius = '6px';
                    err.style.marginTop = '6px';
                    err.textContent = `错误: ${e && e.message ? e.message : e}`;
                    err.innerHTML += `<br><small>堆栈: ${e.stack ? e.stack.slice(0,200) : '无'}</small>`;
                    debugPanel.appendChild(err);
                }
                
                // 即使出错也尝试显示Scrum模块
                try {
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                    
                    const gantt = document.getElementById('ganttChart');
                    if (gantt) {
                        gantt.innerHTML = `
                            <div style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> 加载遇到问题</h3>
                                <p>Scrum模块加载时遇到技术问题，但您仍可以查看基本界面</p>
                                <p style="color: #666; font-size: 14px;">详细错误信息请查看下方调试面板</p>
                                <button class="btn btn-warning" onclick="location.reload()" style="margin-top: 15px;">
                                    <i class="fas fa-refresh"></i> 重新加载页面
                                </button>
                            </div>
                        `;
                    }
                } catch (fallbackError) {
                    console.error('备用显示也失败:', fallbackError);
                }
                
                alert('进入Scrum执行失败，请查看调试面板获取详细信息。建议刷新页面重试。');
            }
        };

        // 页面加载时初始化Scrum模块
        document.addEventListener('DOMContentLoaded', function() {
            initializeScrumModule();
        });

        // 重新渲染Lean模块的时间数据
        function refreshLeanTimelineData() {
            const timelineCardsContainer = document.querySelector('.timeline-cards-lean');
            if (timelineCardsContainer && typeof generateTimelineCardsHtml === 'function') {
                timelineCardsContainer.innerHTML = generateTimelineCardsHtml();
            }
        }
        
        // 重新渲染Lean模块的碳排放数据
        function refreshLeanEmissionData() {
            const emissionCardsContainer = document.querySelector('.emission-cards-lean');
            if (emissionCardsContainer && typeof generateEmissionCardsForLean === 'function') {
                emissionCardsContainer.innerHTML = generateEmissionCardsForLean();
            }
        }
        
        // 渲染时间和碳排放数据卡片
        function renderDataCards() {
            // 刷新Lean模块的时间数据显示
            refreshLeanTimelineData();
            const emissionsData = window.analysisData?.emissions || {};
            const timelineData = window.analysisData?.timeline || {};
            
            // 计算累积改进效果
            const improvements = window.calculateCumulativeImprovements ? window.calculateCumulativeImprovements() : { carbon: {}, time: {} };
            
            // 注意：原本的碳排放和时间数据渲染逻辑已移除，
            // 因为相应的DOM容器(emissionsData, timelineData)在当前页面中不存在
            // 实际的数据展示通过其他方式处理
        }

        // 获取碳排放阶段图标
        function getEmissionIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-chart-bar';
        }

        // 获取碳排放阶段名称
        function getEmissionPhaseName(phase) {
            const names = {
                procurement: '原料采购',
                manufacturing: '生产制造',
                logistics: '物流运输',
                usage: '产品使用',
                recycling: '回收处理',
                decomposition: '自然降解'
            };
            return names[phase] || phase;
        }

        // 获取时间阶段图标
        function getTimelineIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-clock';
        }

        // 获取时间阶段名称
        function getTimelinePhaseName(phase) {
            const names = {
                procurement: '原料采购',
                manufacturing: '生产制造',
                logistics: '物流运输',
                usage: '产品使用',
                recycling: '回收处理',
                decomposition: '自然降解'
            };
            return names[phase] || phase;
        }

        // 获取fallback建议
        function getFallbackSuggestions(area) {
            const fallbackData = {
                '原材料采购': [
                    {
                        icon: 'fas fa-truck',
                        title: '优化供应商选择',
                        timeImprovement: '减少 3个月',
                        carbonReduction: '减少 15%',
                        desc: '选择距离更近的供应商，减少运输距离和碳排放',
                        subProject: '供应商管理',
                        carbonImprovements: { procurement: 15, manufacturing: 0, logistics: 10, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 3, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: '提高材料回收率',
                        timeImprovement: '增加 2个月',
                        carbonReduction: '减少 25%',
                        desc: '使用更多回收材料，虽然会增加采购时间，但显著减少碳排放',
                        subProject: '材料选择',
                        carbonImprovements: { procurement: 25, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: -2, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                '关键部件制造': [
                    {
                        icon: 'fas fa-cogs',
                        title: '优化生产工艺',
                        timeImprovement: '减少 5个月',
                        carbonReduction: '减少 20%',
                        desc: '改进制造流程，提高效率并减少能源消耗',
                        subProject: '工艺优化',
                        carbonImprovements: { procurement: 0, manufacturing: 20, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 5, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-industry',
                        title: '使用快速成型技术',
                        timeImprovement: '减少 8个月',
                        carbonReduction: '增加 10%',
                        desc: '采用快速成型技术缩短生产周期，但可能增加能源消耗',
                        subProject: '技术升级',
                        carbonImprovements: { procurement: 0, manufacturing: -10, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 8, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                '供应链管理': [
                    {
                        icon: 'fas fa-route',
                        title: '优化物流路线',
                        timeImprovement: '减少 4个月',
                        carbonReduction: '减少 18%',
                        desc: '重新规划运输路线，减少运输时间和碳排放',
                        subProject: '物流优化',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: 18, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 4, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-shipping-fast',
                        title: '快速运输方案',
                        timeImprovement: '减少 6个月',
                        carbonReduction: '增加 12%',
                        desc: '采用快速运输方式缩短交付时间，但会增加碳排放',
                        subProject: '运输策略',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: -12, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 6, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ]
            };
            
            return fallbackData[area] || [];
        }
    </script>

    <style>
        .improvement-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .improvement-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .nav-brand span {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        /* 深度分析模态框样式 */
        .deep-analysis-modal .modal-content {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
        }

        .analysis-progress {
            padding: 20px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .progress-item.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            animation: pulse 1.5s infinite;
        }

        .progress-item.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .progress-item i {
            margin-right: 15px;
            font-size: 18px;
            color: #666;
        }

        .progress-item.active i {
            color: #2196f3;
        }

        .progress-item.completed i {
            color: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .analysis-summary {
            padding: 20px;
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .analysis-card.risk-assessment {
            border-left-color: #dc3545;
        }

        .analysis-card.optimization-potential {
            border-left-color: #28a745;
        }

        .analysis-card.recommendations {
            border-left-color: #ffc107;
        }

        .analysis-card h5 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
        }

        .analysis-card h5 i {
            margin-right: 10px;
        }

        .risk-item, .potential-item, .recommendation-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .risk-item:last-child, .potential-item:last-child, .recommendation-item:last-child {
            border-bottom: none;
        }

        .risk-item.high {
            color: #dc3545;
            font-weight: 500;
        }

        .risk-item.medium {
            color: #ffc107;
            font-weight: 500;
        }

        .risk-item.low {
            color: #28a745;
            font-weight: 500;
        }

        .analysis-chat {
            border-top: 1px solid #eee;
            padding: 20px;
        }

        #deepChatMessages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .large-modal {
            max-width: 900px !important;
            width: 90% !important;
        }

        /* 新增样式：个性化建议和状态持久化 */
        .solution-area-card {
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .solution-area-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        /* 移除has-accepted样式，方案内容分析区域不因采纳建议而变色 */
        .solution-area-card.has-accepted {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .accepted-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 建议卡片样式优化 */
        .suggestion-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .suggestion-card.accepted {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .suggestion-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .suggestion-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .suggestion-icon i {
            color: white;
            font-size: 20px;
        }

        .suggestion-title {
            flex: 1;
        }

        .suggestion-title h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .improvement-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .metric.improvement {
            background: #e8f5e8;
            color: #28a745;
            border: 1px solid #c3e6c3;
        }

        .metric.tradeoff {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .metric i {
            font-size: 12px;
        }

        .suggestion-content {
            margin-bottom: 20px;
        }

        .suggestion-desc {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .suggestion-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .sub-project {
            background: #f8f9fa;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }

        .suggestion-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .accepted-status {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #28a745;
            font-weight: 500;
            font-size: 14px;
        }

        .accepted-status i {
            font-size: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* 数据卡片样式优化 */
        .data-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .data-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .data-card .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .data-card .card-icon i {
            color: white;
            font-size: 16px;
        }

        .data-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .data-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .emission-value, .duration-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .unit {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .data-card .progress-bar {
            margin-top: auto;
        }

        .improvement-indicator {
            color: #28a745;
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .timeline-change-badge,
        .emission-change-badge {
            font-size: 12px;
            font-weight: 500;
            margin-left: 6px;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* 深度分析AI助手样式 */
        .suggestion-consult-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .suggestion-consult-header h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .suggestion-description {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .ai-consult-guide {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ai-consult-guide h5 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .consult-options {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .consult-options li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consult-options li i {
            width: 20px;
            text-align: center;
        }

        .ai-welcome-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            flex: 1;
            line-height: 1.5;
        }

        /* 加载状态样式 */
        .loading-suggestions {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-suggestions i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #007bff;
        }



        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .metric-values {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-values .before {
            color: #666;
        }

        .metric-values .after {
            color: #28a745;
            font-weight: bold;
        }

        .metric-values .after.pending {
            color: #ffc107;
            font-style: italic;
        }

        .improvement-rate {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .improvement-rate.positive {
            background: #d4edda;
            color: #155724;
        }

        .improvement-rate.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* AI分析助手弹窗高度优化 */
        .modal-content {
            max-height: 85vh !important;
            height: auto !important;
            overflow-y: auto;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .ai-response {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* 对话历史样式优化 */
        .history-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .history-question {
            margin-bottom: 8px;
            color: #333;
        }

        .history-answer {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .history-time {
            font-size: 12px;
            color: #999;
            text-align: right;
        }

        /* ==================== Scrum模块样式 ==================== */
        
        /* Scrum控制面板 */
        .scrum-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .view-switcher {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .view-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .view-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        .sprint-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .sprint-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .sprint-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .sprint-dates {
            color: #666;
            font-size: 14px;
        }

        .sprint-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-scrum {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-scrum {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        /* Scrum内容布局 */
        /* 仅在切换到Scrum模块时显示，由styles.css里的 .module/.module.active 控制 */
        /* [MODIFIED][Impact: 仅影响显示控制][Backward Compatibility: 不影响其他样式] */

        #scrum-module .module-header {
            margin-bottom: 20px;
        }

        #scrum-module .scrum-controls {
            margin-bottom: 20px;
        }

        /* Kanban看板样式 */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 600px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            transition: all 0.3s ease;
        }

        .kanban-column.drag-over {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .column-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-count {
            background: #007bff;
            color: white;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .add-task-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 400px;
        }

        /* 任务卡片样式 */
        .task-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #e0e0e0;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .task-points {
            background: #f8f9fa;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .task-title {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .task-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-progress {
            margin-bottom: 10px;
        }

        .progress-bar-task {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill-task {
            height: 100%;
            background: #28a745;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignee-avatar {
            font-size: 16px;
        }

        .assignee-name {
            color: #666;
            font-weight: 500;
        }

        .task-dates {
            color: #999;
        }

        /* 甘特图样式 */
        .gantt-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .gantt-controls {
            display: flex;
            gap: 10px;
        }

        .gantt-timeline {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .gantt-header-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-weight: bold;
        }

        .task-info-header {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            color: #333;
        }

        .timeline-header {
            display: flex;
            /* 移除固定min-width，使用动态计算的宽度 */
        }

        .date-column {
            /* 使用动态宽度，通过内联样式设置具体宽度 */
            min-width: 60px;
            padding: 15px 5px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            flex-shrink: 0; /* 防止列被压缩 */
        }

        .gantt-task-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            border-bottom: 1px solid #e0e0e0;
            min-height: 60px;
        }

        .task-info {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            background: white;
            overflow: hidden; /* 防止内容溢出 */
        }

        .task-info-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            max-width: 270px; /* 确保内容不会超出容器 */
        }

        .task-title-gantt {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .task-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap; /* 允许换行 */
            max-width: 100%;
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap; /* 防止文字换行 */
            flex-shrink: 0; /* 防止被压缩 */
        }

        .task-story-points {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #6c757d;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-dates {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .priority-high {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-medium {
            background: #fff3cd;
            color: #856404;
        }

        .priority-low {
            background: #d4edda;
            color: #155724;
        }

        .timeline-content {
            padding: 10px;
            background: #fafafa;
            /* 移除固定min-width，使用动态宽度 */
        }

        .gantt-bar-container {
            height: 40px;
            position: relative;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .gantt-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 4px;
        }

        .gantt-bar-text {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }





        /* 任务移动通知 */
        .task-move-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .task-move-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .task-move-notification i {
            font-size: 18px;
        }

        /* 响应式设计 */

        @media (max-width: 768px) {
            .suggestions-grid {
                grid-template-columns: 1fr;
            }
            
            .suggestion-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .suggestion-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .improvement-metrics {
                justify-content: center;
            }
            
            .suggestion-actions {
                justify-content: center;
            }
            
            .scrum-controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .gantt-timeline {
                font-size: 12px;
            }
            
            .timeline-header {
                /* 移除固定min-width，使用动态宽度 */
                overflow-x: hidden;
            }
        }
    </style>
</body>
</html>
